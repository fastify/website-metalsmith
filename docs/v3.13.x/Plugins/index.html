<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Plugins</title><meta name=description content="Fast and low overhead web framework, for Node.js"><link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.ed24c0a19503e080.png><link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.60c285c424d50738.png><link rel=apple-touch-icon sizes=72x72 href=/images/apple-icon-72x72.e49b27cfe1ab1461.png><link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.752f43fc91b8c1f7.png><link rel=apple-touch-icon sizes=114x114 href=/images/apple-icon-114x114.61739fa1d5a7059a.png><link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.7c25de37c5ce2ec1.png><link rel=apple-touch-icon sizes=144x144 href=/images/apple-icon-144x144.04d88fb27bd92cbe.png><link rel=apple-touch-icon sizes=152x152 href=/images/apple-icon-152x152.9364781175671626.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-icon-180x180.67579100928bfcd2.png><link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.37eb7f1ae3853740.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.1e22f0e774bc3cce.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.7e8a68b1b80c1799.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.e534ce05cb727f1a.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content=#ffffff><meta name=msapplication-TileImage content=/images/ms-icon-144x144.png><meta name=theme-color content=#ffffff><meta property=og:url content=https://www.fastify.io/docs/v3.13.x/Plugins><meta property=og:type content=website><meta property=og:title content=Plugins><meta property=og:description content="Fast and low overhead web framework, for Node.js"><meta property=og:image content=https://www.fastify.io/images/fastify-fb-share-image.07b6e6860853c758.png><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@fastifyjs><meta name=twitter:creator content=@fastifyjs><meta name=twitter:title content=Plugins><meta name=twitter:description content="Fast and low overhead web framework, for Node.js"><meta name=twitter:image content=https://www.fastify.io/images/fastify-twitter-share-image.cd9f217b360af3e2.png><link rel=stylesheet href=/css/style.f4d6592b3a91c5ef.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css integrity="sha512-kZqGbhf9JTB4bVJ0G8HCkqmaPcRgo88F0dneK30yku5Y/dep7CZfCnNml2Je/sY4lBoqoksXz4PtVXS4GHSUzQ==" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@alpha><meta name=robots content="noindex, nofollow"></head><body><nav id=main-navbar class=navbar><div class=navbar-brand><a class=navbar-item href=/ ><img src=/images/fastify-logo-menu.d13f8da7a965c800.png alt="Fastify: Fast and low overhead web framework, for Node.js" height=28 decoding=async> </a><a class="navbar-item is-hidden-desktop" href=https://github.com/fastify/fastify target=_blank rel=noopener><span class=icon style="color: #333;"><i class="fa fa-github"></i></span></a><div class="navbar-burger burger" data-target=mobileMenu><span></span> <span></span> <span></span></div></div><div class=navbar-menu id=mobileMenu><div class=navbar-start><a class=navbar-item href=/ >Home</a> <a class=navbar-item href=/docs/latest>Docs</a> <a class=navbar-item href=/ecosystem>Ecosystem</a> <a class=navbar-item href=/benchmarks>Benchmarks</a> <a class=navbar-item href=/contribute>Contribute</a> <a class=navbar-item href=https://medium.com/@fastifyjs/ >Blog</a> <a class=navbar-item href=https://github.com/fastify/help>Help</a></div><div class=navbar-end><span id=algolia-search-input class="control has-icons-left navbar-item"></span> <a class=navbar-item href=https://github.com/fastify/fastify target=_blank rel=noopener><span class="fa fa-github"></span>&nbsp;GitHub </a><a class=navbar-item href=https://twitter.com/fastifyjs target=_blank rel=noopener><span class="fa fa-twitter"></span>&nbsp;Twitter </a><a class=navbar-item rel=me href=https://fosstodon.org/@fastify target=_blank><span class="fa fa-hashtag"></span>&nbsp;Mastodon</a></div></div></nav><main class=page-content aria-label=Content><section class="hero is-primary" style="background-image: url(/images/bg-pattern-dark.3f8cda863b3bbf52.png)"><div class=hero-body><div class=container><h1 class=title>Documentation (v3.13.0)</h1></div></div></section><section class=section><div class=container><div class=columns><div class="column is-3 is-hidden-mobile sticky-container"><aside class="menu sticky" id=toc><ul class=menu-list><li style="text-transform: capitalize"><a title=Benchmarking href=/docs/v3.13.x/Benchmarking>Benchmarking</a></li><li style="text-transform: capitalize"><a title=ContentTypeParser href=/docs/v3.13.x/ContentTypeParser>ContentTypeParser</a></li><li style="text-transform: capitalize"><a title=Decorators href=/docs/v3.13.x/Decorators>Decorators</a></li><li style="text-transform: capitalize"><a title=Ecosystem href=/docs/v3.13.x/Ecosystem>Ecosystem</a></li><li style="text-transform: capitalize"><a title=Encapsulation href=/docs/v3.13.x/Encapsulation>Encapsulation</a></li><li style="text-transform: capitalize"><a title=Errors href=/docs/v3.13.x/Errors>Errors</a></li><li style="text-transform: capitalize"><a title=Fluent-Schema href=/docs/v3.13.x/Fluent-Schema>Fluent-Schema</a></li><li style="text-transform: capitalize"><a title=Getting-Started href=/docs/v3.13.x/Getting-Started>Getting-Started</a></li><li style="text-transform: capitalize"><a title=HTTP2 href=/docs/v3.13.x/HTTP2>HTTP2</a></li><li style="text-transform: capitalize"><a title=Hooks href=/docs/v3.13.x/Hooks>Hooks</a></li><li style="text-transform: capitalize"><a title=LTS href=/docs/v3.13.x/LTS>LTS</a></li><li style="text-transform: capitalize"><a title=Lifecycle href=/docs/v3.13.x/Lifecycle>Lifecycle</a></li><li style="text-transform: capitalize"><a title=Logging href=/docs/v3.13.x/Logging>Logging</a></li><li style="text-transform: capitalize"><a title=Middleware href=/docs/v3.13.x/Middleware>Middleware</a></li><li style="text-transform: capitalize"><a title=Migration-Guide-V3 href=/docs/v3.13.x/Migration-Guide-V3>Migration-Guide-V3</a></li><li style="text-transform: capitalize"><a title=Plugins-Guide href=/docs/v3.13.x/Plugins-Guide>Plugins-Guide</a></li><li style="text-transform: capitalize" id=doc-menu-section><a title=Plugins class=is-active href=/docs/v3.13.x/Plugins>Plugins</a></li><li style="text-transform: capitalize"><a title=Recommendations href=/docs/v3.13.x/Recommendations>Recommendations</a></li><li style="text-transform: capitalize"><a title=Reply href=/docs/v3.13.x/Reply>Reply</a></li><li style="text-transform: capitalize"><a title=Request href=/docs/v3.13.x/Request>Request</a></li><li style="text-transform: capitalize"><a title=Routes href=/docs/v3.13.x/Routes>Routes</a></li><li style="text-transform: capitalize"><a title=Server href=/docs/v3.13.x/Server>Server</a></li><li style="text-transform: capitalize"><a title=Serverless href=/docs/v3.13.x/Serverless>Serverless</a></li><li style="text-transform: capitalize"><a title=Style-Guide href=/docs/v3.13.x/Style-Guide>Style-Guide</a></li><li style="text-transform: capitalize"><a title=Testing href=/docs/v3.13.x/Testing>Testing</a></li><li style="text-transform: capitalize"><a title=TypeScript href=/docs/v3.13.x/TypeScript>TypeScript</a></li><li style="text-transform: capitalize"><a title=Validation-and-Serialization href=/docs/v3.13.x/Validation-and-Serialization>Validation-and-Serialization</a></li><li style="text-transform: capitalize"><a title=Write-Plugin href=/docs/v3.13.x/Write-Plugin>Write-Plugin</a></li></ul><div class=content style="margin: .8em; border-top: 1px solid #ccc; padding: .8em 0 0 0">Docs version<div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value"><option value=/docs/latest>latest</option><option value=/docs/master>master</option><option value=/docs/v4.12.x>v4.12.x</option><option value=/docs/v4.11.x>v4.11.x</option><option value=/docs/v4.10.x>v4.10.x</option><option value=/docs/v4.9.x>v4.9.x</option><option value=/docs/v4.8.x>v4.8.x</option><option value=/docs/v4.7.x>v4.7.x</option><option value=/docs/v4.6.x>v4.6.x</option><option value=/docs/v4.5.x>v4.5.x</option><option value=/docs/v4.4.x>v4.4.x</option><option value=/docs/v4.3.x>v4.3.x</option><option value=/docs/v4.2.x>v4.2.x</option><option value=/docs/v4.1.x>v4.1.x</option><option value=/docs/v4.0.x>v4.0.x</option><option value=/docs/v3.29.x>v3.29.x</option><option value=/docs/v3.28.x>v3.28.x</option><option value=/docs/v3.27.x>v3.27.x</option><option value=/docs/v3.26.x>v3.26.x</option><option value=/docs/v3.25.x>v3.25.x</option><option value=/docs/v3.24.x>v3.24.x</option><option value=/docs/v3.23.x>v3.23.x</option><option value=/docs/v3.22.x>v3.22.x</option><option value=/docs/v3.21.x>v3.21.x</option><option value=/docs/v3.20.x>v3.20.x</option><option value=/docs/v3.19.x>v3.19.x</option><option value=/docs/v3.18.x>v3.18.x</option><option value=/docs/v3.17.x>v3.17.x</option><option value=/docs/v3.16.x>v3.16.x</option><option value=/docs/v3.15.x>v3.15.x</option><option value=/docs/v3.14.x>v3.14.x</option><option selected value=/docs/v3.13.x>v3.13.x</option><option value=/docs/v3.12.x>v3.12.x</option><option value=/docs/v3.11.x>v3.11.x</option><option value=/docs/v3.10.x>v3.10.x</option><option value=/docs/v3.9.x>v3.9.x</option><option value=/docs/v3.8.x>v3.8.x</option><option value=/docs/v3.7.x>v3.7.x</option><option value=/docs/v3.6.x>v3.6.x</option><option value=/docs/v3.5.x>v3.5.x</option><option value=/docs/v3.4.x>v3.4.x</option><option value=/docs/v3.3.x>v3.3.x</option><option value=/docs/v3.2.x>v3.2.x</option><option value=/docs/v3.1.x>v3.1.x</option><option value=/docs/v3.0.x>v3.0.x</option><option value=/docs/v2.15.x>v2.15.x</option><option value=/docs/v2.14.x>v2.14.x</option><option value=/docs/v2.13.x>v2.13.x</option><option value=/docs/v2.12.x>v2.12.x</option><option value=/docs/v2.11.x>v2.11.x</option><option value=/docs/v2.10.x>v2.10.x</option><option value=/docs/v2.9.x>v2.9.x</option><option value=/docs/v2.8.x>v2.8.x</option><option value=/docs/v2.7.x>v2.7.x</option><option value=/docs/v2.6.x>v2.6.x</option><option value=/docs/v2.5.x>v2.5.x</option><option value=/docs/v2.4.x>v2.4.x</option><option value=/docs/v2.3.x>v2.3.x</option><option value=/docs/v2.2.x>v2.2.x</option><option value=/docs/v2.1.x>v2.1.x</option><option value=/docs/v2.0.x>v2.0.x</option><option value=/docs/v1.14.x>v1.14.x</option><option value=/docs/v1.13.x>v1.13.x</option></select></div></div></div></div></aside></div><div class="column is-9"><nav class=breadcrumb><ul><li><a href=/ style="padding-left: 0">Fastify</a></li><li><a href=/docs/v3.13.x>Documentation</a></li><li><div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value" style="border: none;"><option value=/docs/latest>latest</option><option value=/docs/master>master</option><option value=/docs/v4.12.x>v4.12.x</option><option value=/docs/v4.11.x>v4.11.x</option><option value=/docs/v4.10.x>v4.10.x</option><option value=/docs/v4.9.x>v4.9.x</option><option value=/docs/v4.8.x>v4.8.x</option><option value=/docs/v4.7.x>v4.7.x</option><option value=/docs/v4.6.x>v4.6.x</option><option value=/docs/v4.5.x>v4.5.x</option><option value=/docs/v4.4.x>v4.4.x</option><option value=/docs/v4.3.x>v4.3.x</option><option value=/docs/v4.2.x>v4.2.x</option><option value=/docs/v4.1.x>v4.1.x</option><option value=/docs/v4.0.x>v4.0.x</option><option value=/docs/v3.29.x>v3.29.x</option><option value=/docs/v3.28.x>v3.28.x</option><option value=/docs/v3.27.x>v3.27.x</option><option value=/docs/v3.26.x>v3.26.x</option><option value=/docs/v3.25.x>v3.25.x</option><option value=/docs/v3.24.x>v3.24.x</option><option value=/docs/v3.23.x>v3.23.x</option><option value=/docs/v3.22.x>v3.22.x</option><option value=/docs/v3.21.x>v3.21.x</option><option value=/docs/v3.20.x>v3.20.x</option><option value=/docs/v3.19.x>v3.19.x</option><option value=/docs/v3.18.x>v3.18.x</option><option value=/docs/v3.17.x>v3.17.x</option><option value=/docs/v3.16.x>v3.16.x</option><option value=/docs/v3.15.x>v3.15.x</option><option value=/docs/v3.14.x>v3.14.x</option><option selected value=/docs/v3.13.x>v3.13.x</option><option value=/docs/v3.12.x>v3.12.x</option><option value=/docs/v3.11.x>v3.11.x</option><option value=/docs/v3.10.x>v3.10.x</option><option value=/docs/v3.9.x>v3.9.x</option><option value=/docs/v3.8.x>v3.8.x</option><option value=/docs/v3.7.x>v3.7.x</option><option value=/docs/v3.6.x>v3.6.x</option><option value=/docs/v3.5.x>v3.5.x</option><option value=/docs/v3.4.x>v3.4.x</option><option value=/docs/v3.3.x>v3.3.x</option><option value=/docs/v3.2.x>v3.2.x</option><option value=/docs/v3.1.x>v3.1.x</option><option value=/docs/v3.0.x>v3.0.x</option><option value=/docs/v2.15.x>v2.15.x</option><option value=/docs/v2.14.x>v2.14.x</option><option value=/docs/v2.13.x>v2.13.x</option><option value=/docs/v2.12.x>v2.12.x</option><option value=/docs/v2.11.x>v2.11.x</option><option value=/docs/v2.10.x>v2.10.x</option><option value=/docs/v2.9.x>v2.9.x</option><option value=/docs/v2.8.x>v2.8.x</option><option value=/docs/v2.7.x>v2.7.x</option><option value=/docs/v2.6.x>v2.6.x</option><option value=/docs/v2.5.x>v2.5.x</option><option value=/docs/v2.4.x>v2.4.x</option><option value=/docs/v2.3.x>v2.3.x</option><option value=/docs/v2.2.x>v2.2.x</option><option value=/docs/v2.1.x>v2.1.x</option><option value=/docs/v2.0.x>v2.0.x</option><option value=/docs/v1.14.x>v1.14.x</option><option value=/docs/v1.13.x>v1.13.x</option></select></div></div></div></li><div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value" style="border: none;"><option value=/docs/v3.13.x>Documentation</option><option value=/docs/v3.13.x/Benchmarking>Benchmarking</option><option value=/docs/v3.13.x/ContentTypeParser>ContentTypeParser</option><option value=/docs/v3.13.x/Decorators>Decorators</option><option value=/docs/v3.13.x/Ecosystem>Ecosystem</option><option value=/docs/v3.13.x/Encapsulation>Encapsulation</option><option value=/docs/v3.13.x/Errors>Errors</option><option value=/docs/v3.13.x/Fluent-Schema>Fluent-Schema</option><option value=/docs/v3.13.x/Getting-Started>Getting-Started</option><option value=/docs/v3.13.x/HTTP2>HTTP2</option><option value=/docs/v3.13.x/Hooks>Hooks</option><option value=/docs/v3.13.x/LTS>LTS</option><option value=/docs/v3.13.x/Lifecycle>Lifecycle</option><option value=/docs/v3.13.x/Logging>Logging</option><option value=/docs/v3.13.x/Middleware>Middleware</option><option value=/docs/v3.13.x/Migration-Guide-V3>Migration-Guide-V3</option><option value=/docs/v3.13.x/Plugins-Guide>Plugins-Guide</option><option selected value=/docs/v3.13.x/Plugins>Plugins</option><option value=/docs/v3.13.x/Recommendations>Recommendations</option><option value=/docs/v3.13.x/Reply>Reply</option><option value=/docs/v3.13.x/Request>Request</option><option value=/docs/v3.13.x/Routes>Routes</option><option value=/docs/v3.13.x/Server>Server</option><option value=/docs/v3.13.x/Serverless>Serverless</option><option value=/docs/v3.13.x/Style-Guide>Style-Guide</option><option value=/docs/v3.13.x/Testing>Testing</option><option value=/docs/v3.13.x/TypeScript>TypeScript</option><option value=/docs/v3.13.x/Validation-and-Serialization>Validation-and-Serialization</option><option value=/docs/v3.13.x/Write-Plugin>Write-Plugin</option></select></div></div></div></ul></nav><div id=doc-content class=content><h2 id=plugins>Plugins</h2><p>Fastify allows the user to extend its functionalities with plugins. A plugin can be a set of routes, a server <a href=Decorators.md>decorator</a> or whatever. The API that you will need to use one or more plugins, is <code>register</code>.<br></p><p>By default, <code>register</code> creates a <em>new scope</em>, this means that if you do some changes to the Fastify instance (via <code>decorate</code>), this change will not be reflected to the current context ancestors, but only to its sons. This feature allows us to achieve plugin <em>encapsulation</em> and <em>inheritance</em>, in this way we create a <em>direct acyclic graph</em> (DAG) and we will not have issues caused by cross dependencies.</p><p>You already see in the <a href=Getting-Started.md#register>getting started</a> section how using this API is pretty straightforward.</p><pre><code>fastify.register(plugin, [options])
</code></pre><p><a name=plugin-options></a></p><h3 id=plugin-options>Plugin Options</h3><p>The optional <code>options</code> parameter for <code>fastify.register</code> supports a predefined set of options that Fastify itself will use, except when the plugin has been wrapped with <a href=https://github.com/fastify/fastify-plugin>fastify-plugin</a>. This options object will also be passed to the plugin upon invocation, regardless of whether or not the plugin has been wrapped. The currently supported list of Fastify specific options is:</p><ul><li><a href=Routes.md#custom-log-level><code>logLevel</code></a></li><li><a href=Routes.md#custom-log-serializer><code>logSerializers</code></a></li><li><a href=Plugins.md#route-prefixing-options><code>prefix</code></a></li></ul><p><strong>Note: Those options will be ignored when used with fastify-plugin</strong></p><p>It is possible that Fastify will directly support other options in the future. Thus, to avoid collisions, a plugin should consider namespacing its options. For example, a plugin <code>foo</code> might be registered like so:</p><pre><code class=language-js>fastify.register(require(&#39;fastify-foo&#39;), {
  prefix: &#39;/foo&#39;,
  foo: {
    fooOption1: &#39;value&#39;,
    fooOption2: &#39;value&#39;
  }
})
</code></pre><p>If collisions are not a concern, the plugin may simply accept the options object as-is:</p><pre><code class=language-js>fastify.register(require(&#39;fastify-foo&#39;), {
  prefix: &#39;/foo&#39;,
  fooOption1: &#39;value&#39;,
  fooOption2: &#39;value&#39;
})
</code></pre><p>The <code>options</code> parameter can also be a <code>Function</code> that will be evaluated at the time the plugin is registered while giving access to the Fastify instance via the first positional argument:</p><pre><code class=language-js>const fp = require(&#39;fastify-plugin&#39;)

fastify.register(fp((fastify, opts, done) =&gt; {
  fastify.decorate(&#39;foo_bar&#39;, { hello: &#39;world&#39; })

  done()
}))

// The opts argument of fastify-foo will be { hello: &#39;world&#39; }
fastify.register(require(&#39;fastify-foo&#39;), parent =&gt; parent.foo_bar)
</code></pre><p>The Fastify instance passed on to the function is the latest state of the <strong>external Fastify instance</strong> the plugin was declared on, allowing access to variables injected via <a href=Decorators.md><code>decorate</code></a> by preceding plugins according to the <strong>order of registration</strong>. This is useful in case a plugin depends on changes made to the Fastify instance by a preceding plugin i.e. utilizing an existing database connection to wrap around it.</p><p>Keep in mind that the Fastify instance passed on to the function is the same as the one that will be passed in to the plugin, a copy of the external Fastify instance rather than a reference. Any usage of the instance will behave the same as it would if called within the plugins function i.e. if <code>decorate</code> is called, the decorated variables will be available within the plugins function unless it was wrapped with <a href=https://github.com/fastify/fastify-plugin><code>fastify-plugin</code></a>.</p><p><a name=route-prefixing-option></a></p><h4 id=route-prefixing-option>Route Prefixing option</h4><p>If you pass an option with the key <code>prefix</code> with a <code>string</code> value, Fastify will use it to prefix all the routes inside the register, for more info check <a href=Routes.md#route-prefixing>here</a>.<br>Be aware that if you use <a href=https://github.com/fastify/fastify-plugin><code>fastify-plugin</code></a> this option will not work.</p><p><a name=error-handling></a></p><h4 id=error-handling>Error handling</h4><p>The error handling is done by <a href=https://github.com/mcollina/avvio#error-handling>avvio</a>.<br>As general rule, it is highly recommended that you handle your errors in the next <code>after</code> or <code>ready</code> block, otherwise you will get them inside the <code>listen</code> callback.</p><pre><code class=language-js>fastify.register(require(&#39;my-plugin&#39;))

// `after` will be executed once
// the previous declared `register` has finished
fastify.after(err =&gt; console.log(err))

// `ready` will be executed once all the registers declared
// have finished their execution
fastify.ready(err =&gt; console.log(err))

// `listen` is a special ready,
// so it behaves in the same way
fastify.listen(3000, (err, address) =&gt; {
  if (err) console.log(err)
})
</code></pre><p><a name=async-await></a></p><h3 id=asyncawait>async/await</h3><p><em>async/await</em> is supported by <code>after</code>, <code>ready</code> and <code>listen</code>, as well as <code>fastify</code> being a <a href=https://promisesaplus.com/ >Thenable</a>.</p><pre><code class=language-js>await fastify.register(require(&#39;my-plugin&#39;))

await fastify.after()

await fastify.ready()

await fastify.listen(3000)
</code></pre><p><a name=esm-support></a></p><h4 id=esm-support>ESM support</h4><p>ESM is supported as well from <a href=https://nodejs.org/api/esm.html>Node.js <code>v13.3.0</code></a> and above!</p><pre><code class=language-js>// main.mjs
import Fastify from &#39;fastify&#39;
const fastify = Fastify()

fastify.register(import(&#39;./plugin.mjs&#39;))

fastify.listen(3000, console.log)


// plugin.mjs
async function plugin (fastify, opts) {
  fastify.get(&#39;/&#39;, async (req, reply) =&gt; {
    return { hello: &#39;world&#39; }
  })
}

export default plugin
</code></pre><p><a name=create-plugin></a></p><h3 id=create-a-plugin>Create a plugin</h3><p>Creating a plugin is very easy, you just need to create a function that takes three parameters, the <code>fastify</code> instance, an <code>options</code> object and the <code>done</code> callback.<br>Example:</p><pre><code class=language-js>module.exports = function (fastify, opts, done) {
  fastify.decorate(&#39;utility&#39;, () =&gt; {})

  fastify.get(&#39;/&#39;, handler)

  done()
}
</code></pre><p>You can also use <code>register</code> inside another <code>register</code>:</p><pre><code class=language-js>module.exports = function (fastify, opts, done) {
  fastify.decorate(&#39;utility&#39;, () =&gt; {})

  fastify.get(&#39;/&#39;, handler)

  fastify.register(require(&#39;./other-plugin&#39;))

  done()
}
</code></pre><p>Sometimes, you will need to know when the server is about to close, for example because you must close a connection to a database. To know when this is going to happen, you can use the <a href=Hooks.md#on-close><code>&#39;onClose&#39;</code></a> hook.</p><p>Do not forget that <code>register</code> will always create a new Fastify scope, if you do not need that, read the following section.</p><p><a name=handle-scope></a></p><h3 id=handle-the-scope>Handle the scope</h3><p>If you are using <code>register</code> only for extending the functionality of the server with <a href=Decorators.md><code>decorate</code></a>, it is your responsibility to tell Fastify not to create a new scope, otherwise your changes will not be accessible by the user in the upper scope.</p><p>You have two ways to tell Fastify to avoid the creation of a new context:</p><ul><li>Use the <a href=https://github.com/fastify/fastify-plugin><code>fastify-plugin</code></a> module</li><li>Use the <code>&#39;skip-override&#39;</code> hidden property</li></ul><p>We recommend using the <code>fastify-plugin</code> module, because it solves this problem for you, and you can pass a version range of Fastify as a parameter that your plugin will support.</p><pre><code class=language-js>const fp = require(&#39;fastify-plugin&#39;)

module.exports = fp(function (fastify, opts, done) {
  fastify.decorate(&#39;utility&#39;, () =&gt; {})
  done()
}, &#39;0.x&#39;)
</code></pre><p>Check the <a href=https://github.com/fastify/fastify-plugin><code>fastify-plugin</code></a> documentation to know more about how use this module.</p><p>If you do not use the <code>fastify-plugin</code> module, you can use the <code>&#39;skip-override&#39;</code> hidden property, but we do not recommend it. If in the future the Fastify API changes it will be your responsibility update the module, while if you use <code>fastify-plugin</code>, you can be sure about backwards compatibility.</p><pre><code class=language-js>function yourPlugin (fastify, opts, done) {
  fastify.decorate(&#39;utility&#39;, () =&gt; {})
  done()
}
yourPlugin[Symbol.for(&#39;skip-override&#39;)] = true
module.exports = yourPlugin
</code></pre></div><hr><nav class=level></nav></div></div></div></section><script>// dynamically creates a submenu for the current section based on the content headers
  var titles = document.querySelectorAll('#doc-content h3, #doc-content h4')
  var currentMenu = document.getElementById('doc-menu-section')
  if (titles.length && currentMenu) {
    var submenu = document.createElement('ul')
    titles.forEach(el => {
      var currentSubmenuItem = document.createElement('li')
      var currentSubmenuLink = document.createElement('a')
      currentSubmenuLink.href = '#' + el.id
      currentSubmenuLink.title = el.textContent
      currentSubmenuLink.append(document.createTextNode(el.textContent))
      currentSubmenuItem.append(currentSubmenuLink)
      submenu.append(currentSubmenuItem)
    })
    currentMenu.append(submenu)
  }

  // dynamically creates header anchor links
  var headers = document.querySelectorAll('#doc-content h3, #doc-content h4')
  headers.forEach(el => {
    var currentAnchorLink = document.createElement('a')
    currentAnchorLink.className = 'anchor'
    currentAnchorLink.href = "#" + el.id
    currentAnchorLink.append(document.createTextNode('¶'))
    el.insertBefore(currentAnchorLink, el.firstChild);
  })</script><script>const contentLoaded = document.addEventListener('DOMContentLoaded', setTOCHeight)
  const resize = window.addEventListener('resize', setTOCHeight)

  function setTOCHeight() {
    const docHeight = window.innerHeight
    const tocSidebar = document.querySelector('#toc') || 0

    const tocHeight = docHeight - tocSidebar.getBoundingClientRect().top

    document.documentElement.style
      .setProperty('--TOC-height', `${tocHeight}px`)
  }

  window.addEventListener('beforeunload', () => {
    document.removeEventListener(contentLoaded)
    window.removeEventListener(resize)
  })</script></main><footer class="grey is-primary footer"><div class=container><div class="content has-text-centered"><p>Fastify, Copyright &copy; 2016-2023 <a href=https://openjsf.org/ target=_blank rel=noopener>OpenJS Foundation</a> and <a href=https://github.com/fastify/fastify#team target=_blank rel=noopener>The Fastify team</a>, Licensed under <a href=https://github.com/fastify/fastify/blob/master/LICENSE target=_blank rel=noopener>MIT</a></p><a href=https://www.netlify.com><img src=https://www.netlify.com/img/global/badges/netlify-color-accent.svg alt="Deploys by Netlify" loading=lazy decoding=async></a><p><small>Icons by simpleicons.org</small></p></div></div></footer><script src=/js/main.1e1d476db6c0b326.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js integrity="sha512-s+tOYYcC3Jybgr9mVsdAxsRYlGNq4mlAurOrfNuGMQ/SCofNPu92tjE7YRZCsdEtWL1yGkqk15fU/ark206YTg==" crossorigin=anonymous></script><script>hljs.highlightAll();</script><script src=https://cdn.jsdelivr.net/npm/@docsearch/js@alpha></script><script type=text/javascript>docsearch({
        appId: 'DMPMC33PLU',
        apiKey: '12d46b3bfeee6511031cfe00778f3e45',
        indexName: 'fastify',
        container: '#algolia-search-input',
        algoliaOptions: { 'facetFilters': ["version:latest", "tags:docs"] }
      });</script></body></html>