<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Plugins-Guide</title><meta name=description content="Fast and low overhead web framework, for Node.js"><link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.ed24c0a19503e080.png><link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.60c285c424d50738.png><link rel=apple-touch-icon sizes=72x72 href=/images/apple-icon-72x72.e49b27cfe1ab1461.png><link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.752f43fc91b8c1f7.png><link rel=apple-touch-icon sizes=114x114 href=/images/apple-icon-114x114.61739fa1d5a7059a.png><link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.7c25de37c5ce2ec1.png><link rel=apple-touch-icon sizes=144x144 href=/images/apple-icon-144x144.04d88fb27bd92cbe.png><link rel=apple-touch-icon sizes=152x152 href=/images/apple-icon-152x152.9364781175671626.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-icon-180x180.67579100928bfcd2.png><link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.37eb7f1ae3853740.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.1e22f0e774bc3cce.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.7e8a68b1b80c1799.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.e534ce05cb727f1a.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content=#ffffff><meta name=msapplication-TileImage content=/images/ms-icon-144x144.png><meta name=theme-color content=#ffffff><meta property=og:url content=https://www.fastify.io/docs/v2.1.x/Plugins-Guide><meta property=og:type content=website><meta property=og:title content=Plugins-Guide><meta property=og:description content="Fast and low overhead web framework, for Node.js"><meta property=og:image content=https://www.fastify.io/images/fastify-fb-share-image.07b6e6860853c758.png><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@fastifyjs><meta name=twitter:creator content=@fastifyjs><meta name=twitter:title content=Plugins-Guide><meta name=twitter:description content="Fast and low overhead web framework, for Node.js"><meta name=twitter:image content=https://www.fastify.io/images/fastify-twitter-share-image.cd9f217b360af3e2.png><link rel=stylesheet href=/css/style.f4d6592b3a91c5ef.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css integrity="sha512-kZqGbhf9JTB4bVJ0G8HCkqmaPcRgo88F0dneK30yku5Y/dep7CZfCnNml2Je/sY4lBoqoksXz4PtVXS4GHSUzQ==" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@alpha><meta name=robots content="noindex, nofollow"></head><body><nav id=main-navbar class=navbar><div class=navbar-brand><a class=navbar-item href=/ ><img src=/images/fastify-logo-menu.d13f8da7a965c800.png alt="Fastify: Fast and low overhead web framework, for Node.js" height=28 decoding=async> </a><a class="navbar-item is-hidden-desktop" href=https://github.com/fastify/fastify target=_blank rel=noopener><span class=icon style="color: #333;"><i class="fa fa-github"></i></span></a><div class="navbar-burger burger" data-target=mobileMenu><span></span> <span></span> <span></span></div></div><div class=navbar-menu id=mobileMenu><div class=navbar-start><a class=navbar-item href=/ >Home</a> <a class=navbar-item href=/docs/latest>Docs</a> <a class=navbar-item href=/ecosystem>Ecosystem</a> <a class=navbar-item href=/benchmarks>Benchmarks</a> <a class=navbar-item href=/contribute>Contribute</a> <a class=navbar-item href=https://medium.com/@fastifyjs/ >Blog</a> <a class=navbar-item href=https://github.com/fastify/help>Help</a></div><div class=navbar-end><span id=algolia-search-input class="control has-icons-left navbar-item"></span> <a class=navbar-item href=https://github.com/fastify/fastify target=_blank rel=noopener><span class="fa fa-github"></span>&nbsp;GitHub </a><a class=navbar-item href=https://twitter.com/fastifyjs target=_blank rel=noopener><span class="fa fa-twitter"></span>&nbsp;Twitter </a><a class=navbar-item rel=me href=https://fosstodon.org/@fastify target=_blank><span class="fa fa-hashtag"></span>&nbsp;Mastodon</a></div></div></nav><main class=page-content aria-label=Content><section class="hero is-primary" style="background-image: url(/images/bg-pattern-dark.3f8cda863b3bbf52.png)"><div class=hero-body><div class=container><h1 class=title>Documentation (v2.1.0)</h1></div></div></section><section class=section><div class=container><div class=columns><div class="column is-3 is-hidden-mobile sticky-container"><aside class="menu sticky" id=toc><ul class=menu-list><li style="text-transform: capitalize"><a title=Benchmarking href=/docs/v2.1.x/Benchmarking>Benchmarking</a></li><li style="text-transform: capitalize"><a title=ContentTypeParser href=/docs/v2.1.x/ContentTypeParser>ContentTypeParser</a></li><li style="text-transform: capitalize"><a title=Decorators href=/docs/v2.1.x/Decorators>Decorators</a></li><li style="text-transform: capitalize"><a title=Ecosystem href=/docs/v2.1.x/Ecosystem>Ecosystem</a></li><li style="text-transform: capitalize"><a title=Errors href=/docs/v2.1.x/Errors>Errors</a></li><li style="text-transform: capitalize"><a title=Fluent-Schema href=/docs/v2.1.x/Fluent-Schema>Fluent-Schema</a></li><li style="text-transform: capitalize"><a title=Getting-Started href=/docs/v2.1.x/Getting-Started>Getting-Started</a></li><li style="text-transform: capitalize"><a title=HTTP2 href=/docs/v2.1.x/HTTP2>HTTP2</a></li><li style="text-transform: capitalize"><a title=Hooks href=/docs/v2.1.x/Hooks>Hooks</a></li><li style="text-transform: capitalize"><a title=LTS href=/docs/v2.1.x/LTS>LTS</a></li><li style="text-transform: capitalize"><a title=Lifecycle href=/docs/v2.1.x/Lifecycle>Lifecycle</a></li><li style="text-transform: capitalize"><a title=Logging href=/docs/v2.1.x/Logging>Logging</a></li><li style="text-transform: capitalize"><a title=Middlewares href=/docs/v2.1.x/Middlewares>Middlewares</a></li><li style="text-transform: capitalize" id=doc-menu-section><a title=Plugins-Guide class=is-active href=/docs/v2.1.x/Plugins-Guide>Plugins-Guide</a></li><li style="text-transform: capitalize"><a title=Plugins href=/docs/v2.1.x/Plugins>Plugins</a></li><li style="text-transform: capitalize"><a title=Reply href=/docs/v2.1.x/Reply>Reply</a></li><li style="text-transform: capitalize"><a title=Request href=/docs/v2.1.x/Request>Request</a></li><li style="text-transform: capitalize"><a title=Routes href=/docs/v2.1.x/Routes>Routes</a></li><li style="text-transform: capitalize"><a title=Server href=/docs/v2.1.x/Server>Server</a></li><li style="text-transform: capitalize"><a title=Testing href=/docs/v2.1.x/Testing>Testing</a></li><li style="text-transform: capitalize"><a title=TypeScript href=/docs/v2.1.x/TypeScript>TypeScript</a></li><li style="text-transform: capitalize"><a title=Validation-and-Serialization href=/docs/v2.1.x/Validation-and-Serialization>Validation-and-Serialization</a></li><li style="text-transform: capitalize"><a title=Write-Plugin href=/docs/v2.1.x/Write-Plugin>Write-Plugin</a></li></ul><div class=content style="margin: .8em; border-top: 1px solid #ccc; padding: .8em 0 0 0">Docs version<div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value"><option value=/docs/latest>latest</option><option value=/docs/master>master</option><option value=/docs/v4.14.x>v4.14.x</option><option value=/docs/v4.13.x>v4.13.x</option><option value=/docs/v4.12.x>v4.12.x</option><option value=/docs/v4.11.x>v4.11.x</option><option value=/docs/v4.10.x>v4.10.x</option><option value=/docs/v4.9.x>v4.9.x</option><option value=/docs/v4.8.x>v4.8.x</option><option value=/docs/v4.7.x>v4.7.x</option><option value=/docs/v4.6.x>v4.6.x</option><option value=/docs/v4.5.x>v4.5.x</option><option value=/docs/v4.4.x>v4.4.x</option><option value=/docs/v4.3.x>v4.3.x</option><option value=/docs/v4.2.x>v4.2.x</option><option value=/docs/v4.1.x>v4.1.x</option><option value=/docs/v4.0.x>v4.0.x</option><option value=/docs/v3.29.x>v3.29.x</option><option value=/docs/v3.28.x>v3.28.x</option><option value=/docs/v3.27.x>v3.27.x</option><option value=/docs/v3.26.x>v3.26.x</option><option value=/docs/v3.25.x>v3.25.x</option><option value=/docs/v3.24.x>v3.24.x</option><option value=/docs/v3.23.x>v3.23.x</option><option value=/docs/v3.22.x>v3.22.x</option><option value=/docs/v3.21.x>v3.21.x</option><option value=/docs/v3.20.x>v3.20.x</option><option value=/docs/v3.19.x>v3.19.x</option><option value=/docs/v3.18.x>v3.18.x</option><option value=/docs/v3.17.x>v3.17.x</option><option value=/docs/v3.16.x>v3.16.x</option><option value=/docs/v3.15.x>v3.15.x</option><option value=/docs/v3.14.x>v3.14.x</option><option value=/docs/v3.13.x>v3.13.x</option><option value=/docs/v3.12.x>v3.12.x</option><option value=/docs/v3.11.x>v3.11.x</option><option value=/docs/v3.10.x>v3.10.x</option><option value=/docs/v3.9.x>v3.9.x</option><option value=/docs/v3.8.x>v3.8.x</option><option value=/docs/v3.7.x>v3.7.x</option><option value=/docs/v3.6.x>v3.6.x</option><option value=/docs/v3.5.x>v3.5.x</option><option value=/docs/v3.4.x>v3.4.x</option><option value=/docs/v3.3.x>v3.3.x</option><option value=/docs/v3.2.x>v3.2.x</option><option value=/docs/v3.1.x>v3.1.x</option><option value=/docs/v3.0.x>v3.0.x</option><option value=/docs/v2.15.x>v2.15.x</option><option value=/docs/v2.14.x>v2.14.x</option><option value=/docs/v2.13.x>v2.13.x</option><option value=/docs/v2.12.x>v2.12.x</option><option value=/docs/v2.11.x>v2.11.x</option><option value=/docs/v2.10.x>v2.10.x</option><option value=/docs/v2.9.x>v2.9.x</option><option value=/docs/v2.8.x>v2.8.x</option><option value=/docs/v2.7.x>v2.7.x</option><option value=/docs/v2.6.x>v2.6.x</option><option value=/docs/v2.5.x>v2.5.x</option><option value=/docs/v2.4.x>v2.4.x</option><option value=/docs/v2.3.x>v2.3.x</option><option value=/docs/v2.2.x>v2.2.x</option><option selected value=/docs/v2.1.x>v2.1.x</option><option value=/docs/v2.0.x>v2.0.x</option><option value=/docs/v1.14.x>v1.14.x</option><option value=/docs/v1.13.x>v1.13.x</option></select></div></div></div></div></aside></div><div class="column is-9"><nav class=breadcrumb><ul><li><a href=/ style="padding-left: 0">Fastify</a></li><li><a href=/docs/v2.1.x>Documentation</a></li><li><div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value" style="border: none;"><option value=/docs/latest>latest</option><option value=/docs/master>master</option><option value=/docs/v4.14.x>v4.14.x</option><option value=/docs/v4.13.x>v4.13.x</option><option value=/docs/v4.12.x>v4.12.x</option><option value=/docs/v4.11.x>v4.11.x</option><option value=/docs/v4.10.x>v4.10.x</option><option value=/docs/v4.9.x>v4.9.x</option><option value=/docs/v4.8.x>v4.8.x</option><option value=/docs/v4.7.x>v4.7.x</option><option value=/docs/v4.6.x>v4.6.x</option><option value=/docs/v4.5.x>v4.5.x</option><option value=/docs/v4.4.x>v4.4.x</option><option value=/docs/v4.3.x>v4.3.x</option><option value=/docs/v4.2.x>v4.2.x</option><option value=/docs/v4.1.x>v4.1.x</option><option value=/docs/v4.0.x>v4.0.x</option><option value=/docs/v3.29.x>v3.29.x</option><option value=/docs/v3.28.x>v3.28.x</option><option value=/docs/v3.27.x>v3.27.x</option><option value=/docs/v3.26.x>v3.26.x</option><option value=/docs/v3.25.x>v3.25.x</option><option value=/docs/v3.24.x>v3.24.x</option><option value=/docs/v3.23.x>v3.23.x</option><option value=/docs/v3.22.x>v3.22.x</option><option value=/docs/v3.21.x>v3.21.x</option><option value=/docs/v3.20.x>v3.20.x</option><option value=/docs/v3.19.x>v3.19.x</option><option value=/docs/v3.18.x>v3.18.x</option><option value=/docs/v3.17.x>v3.17.x</option><option value=/docs/v3.16.x>v3.16.x</option><option value=/docs/v3.15.x>v3.15.x</option><option value=/docs/v3.14.x>v3.14.x</option><option value=/docs/v3.13.x>v3.13.x</option><option value=/docs/v3.12.x>v3.12.x</option><option value=/docs/v3.11.x>v3.11.x</option><option value=/docs/v3.10.x>v3.10.x</option><option value=/docs/v3.9.x>v3.9.x</option><option value=/docs/v3.8.x>v3.8.x</option><option value=/docs/v3.7.x>v3.7.x</option><option value=/docs/v3.6.x>v3.6.x</option><option value=/docs/v3.5.x>v3.5.x</option><option value=/docs/v3.4.x>v3.4.x</option><option value=/docs/v3.3.x>v3.3.x</option><option value=/docs/v3.2.x>v3.2.x</option><option value=/docs/v3.1.x>v3.1.x</option><option value=/docs/v3.0.x>v3.0.x</option><option value=/docs/v2.15.x>v2.15.x</option><option value=/docs/v2.14.x>v2.14.x</option><option value=/docs/v2.13.x>v2.13.x</option><option value=/docs/v2.12.x>v2.12.x</option><option value=/docs/v2.11.x>v2.11.x</option><option value=/docs/v2.10.x>v2.10.x</option><option value=/docs/v2.9.x>v2.9.x</option><option value=/docs/v2.8.x>v2.8.x</option><option value=/docs/v2.7.x>v2.7.x</option><option value=/docs/v2.6.x>v2.6.x</option><option value=/docs/v2.5.x>v2.5.x</option><option value=/docs/v2.4.x>v2.4.x</option><option value=/docs/v2.3.x>v2.3.x</option><option value=/docs/v2.2.x>v2.2.x</option><option selected value=/docs/v2.1.x>v2.1.x</option><option value=/docs/v2.0.x>v2.0.x</option><option value=/docs/v1.14.x>v1.14.x</option><option value=/docs/v1.13.x>v1.13.x</option></select></div></div></div></li><div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value" style="border: none;"><option value=/docs/v2.1.x>Documentation</option><option value=/docs/v2.1.x/Benchmarking>Benchmarking</option><option value=/docs/v2.1.x/ContentTypeParser>ContentTypeParser</option><option value=/docs/v2.1.x/Decorators>Decorators</option><option value=/docs/v2.1.x/Ecosystem>Ecosystem</option><option value=/docs/v2.1.x/Errors>Errors</option><option value=/docs/v2.1.x/Fluent-Schema>Fluent-Schema</option><option value=/docs/v2.1.x/Getting-Started>Getting-Started</option><option value=/docs/v2.1.x/HTTP2>HTTP2</option><option value=/docs/v2.1.x/Hooks>Hooks</option><option value=/docs/v2.1.x/LTS>LTS</option><option value=/docs/v2.1.x/Lifecycle>Lifecycle</option><option value=/docs/v2.1.x/Logging>Logging</option><option value=/docs/v2.1.x/Middlewares>Middlewares</option><option selected value=/docs/v2.1.x/Plugins-Guide>Plugins-Guide</option><option value=/docs/v2.1.x/Plugins>Plugins</option><option value=/docs/v2.1.x/Reply>Reply</option><option value=/docs/v2.1.x/Request>Request</option><option value=/docs/v2.1.x/Routes>Routes</option><option value=/docs/v2.1.x/Server>Server</option><option value=/docs/v2.1.x/Testing>Testing</option><option value=/docs/v2.1.x/TypeScript>TypeScript</option><option value=/docs/v2.1.x/Validation-and-Serialization>Validation-and-Serialization</option><option value=/docs/v2.1.x/Write-Plugin>Write-Plugin</option></select></div></div></div></ul></nav><div id=doc-content class=content><h1 id=the-hitchhikers-guide-to-plugins>The hitchhiker&#39;s guide to plugins</h1><p>First of all, <code>DON&#39;T PANIC</code>!</p><p>Fastify was built from the beginning to be an extremely modular system. We built a powerful API that allows you to add methods and utilities to Fastify by creating a namespace. We built a system that creates an encapsulation model that allows you to split your application in multiple microservices at any moment, without the need to refactor the entire application.</p><p><strong>Table of contents</strong></p><ul><li><a href=#register>Register</a></li><li><a href=#decorators>Decorators</a></li><li><a href=#hooks>Hooks</a></li><li><a href=#middlewares>Middlewares</a></li><li><a href=#distribution>How to handle encapsulation and distribution</a></li><li><a href=#handle-errors>Handle errors</a></li><li><a href=#start>Let&#39;s start!</a></li></ul><p><a name=register></a></p><h2 id=register>Register</h2><p>As in JavaScript everything is an object, in Fastify everything is a plugin.<br>Your routes, your utilities and so on are all plugins. To add a new plugin, whatever its functionality is, in Fastify you have a nice and unique api to use: <a href=/docs/v2.1.x/v2.1.x/Plugins><code>register</code></a>.</p><pre><code class=language-js>fastify.register(
  require(&#39;./my-plugin&#39;),
  { options }
)
</code></pre><p><code>register</code> creates a new Fastify context, this means that if you do any change to the Fastify instance, those changes will not be reflected in the context&#39;s ancestors. In other words, encapsulation!</p><p><em>Why is encapsulation important?</em><br>Well, let&#39;s say you are creating a new disruptive startup, what do you do? You create an api server with all your stuff, everything in the same place, a monolith!<br>Ok, you are growing very fast and you want to change your architecture and try microservices. Usually this implies a huge amount of work, because of cross dependencies and the lack of separation of concerns.<br>Fastify helps you a lot in this direction, because thanks to the encapsulation model it will completely avoid cross dependencies, and will help you structure your code in cohesive blocks.</p><p><em>Let&#39;s return to how to correctly use <code>register</code>.</em><br>As you probably know, the required plugins must expose a single function with the following signature</p><pre><code class=language-js>module.exports = function (fastify, options, next) {}
</code></pre><p>Where <code>fastify</code> is (pretty obvious) the encapsulated Fastify instance, <code>options</code> is the options object and <code>next</code> is the function you <strong>must</strong> call when your plugin is ready.</p><p>Fastify&#39;s plugin model is fully reentrant and graph-based, it handles without any kind of problem asynchronous code and it guarantees the load order of the plugins, even the close order! <em>How?</em> Glad you asked, checkout <a href=https://github.com/mcollina/avvio><code>avvio</code></a>! Fastify starts loading the plugin <strong>after</strong> <code>.listen()</code>, <code>.inject()</code> or <code>.ready()</code> are called.</p><p>Inside a plugin you can do whatever you want, register routes, utilities (we&#39;ll see this in a moment) and do nested registers, just remember to call <code>next</code> when everything is set up!</p><pre><code class=language-js>module.exports = function (fastify, options, next) {
  fastify.get(&#39;/plugin&#39;, (request, reply) =&gt; {
    reply.send({ hello: &#39;world&#39; })
  })

  next()
}
</code></pre><p>Well, now you know how to use the <code>register</code> api and how it works, but how do we add new functionality to Fastify and even better, share them with other developers?</p><p><a name=decorators></a></p><h2 id=decorators>Decorators</h2><p>Okay, let&#39;s say that you wrote an utility that is so good that you decided to make it available along all your code. How would you do it? Probably something like the following:</p><pre><code class=language-js>// your-awesome-utility.js
module.exports = function (a, b) {
  return a + b
}
</code></pre><pre><code class=language-js>const util = require(&#39;./your-awesome-utility&#39;)
console.log(util(&#39;that is &#39;, &#39; awesome&#39;))
</code></pre><p>And now you will import your utility in every file you need it. (And don&#39;t forget that you will probably also need it in your test).</p><p>Fastify offers you a way nicer and elegant way to do this, <em>decorators</em>. Create a decorator is extremely easy, just use the <a href=/docs/v2.1.x/v2.1.x/Decorators><code>decorate</code></a> api:</p><pre><code class=language-js>fastify.decorate(&#39;util&#39;, (a, b) =&gt; a + b)
</code></pre><p>Now you can access your utility just by doing <code>fastify.util</code> whenever you need it, even inside your test.<br>And here&#39;s starts the magic; do you remember that few lines above we talked about encapsulation? Well, using <code>register</code> and <code>decorate</code> in conjunction enable exactly that, let me show you an example to clarify this:</p><pre><code class=language-js>fastify.register((instance, opts, next) =&gt; {
  instance.decorate(&#39;util&#39;, (a, b) =&gt; a + b)
  console.log(instance.util(&#39;that is &#39;, &#39; awesome&#39;))

  next()
})

fastify.register((instance, opts, next) =&gt; {
  console.log(instance.util(&#39;that is &#39;, &#39; awesome&#39;)) // this will throw an error

  next()
})
</code></pre><p>Inside the second register call <code>instance.util</code> will throw an error, because <code>util</code> exists only inside the first register context.<br>Let&#39;s step back for a moment and get deeper on this: when using the <code>register</code> api you will create a new context every time and this avoids situations like the one mentioned few line above. But pay attention, the encapsulation works only for the ancestors and the brothers, but not for the sons.</p><pre><code class=language-js>fastify.register((instance, opts, next) =&gt; {
  instance.decorate(&#39;util&#39;, (a, b) =&gt; a + b)
  console.log(instance.util(&#39;that is &#39;, &#39; awesome&#39;))

  fastify.register((instance, opts, next) =&gt; {
    console.log(instance.util(&#39;that is &#39;, &#39; awesome&#39;)) // this will not throw an error
    next()
  })

  next()
})

fastify.register((instance, opts, next) =&gt; {
  console.log(instance.util(&#39;that is &#39;, &#39; awesome&#39;)) // this will throw an error

  next()
})
</code></pre><p><em>Take home message: if you need that an utility is available in every part of your application, pay attention that is declared at the root scope of your application. Otherwise you can use <code>fastify-plugin</code> utility as described <a href=#distribution>here</a>.</em></p><p><code>decorate</code> is not the unique api that you can use to extend the server functionalities, you can also use <code>decorateRequest</code> and <code>decorateReply</code>.</p><p><em><code>decorateRequest</code> and <code>decorateReply</code>? Why do we need them if we already have <code>decorate</code>?</em><br>Good question, we added them to make Fastify more developer-friendly. Let&#39;s see an example:</p><pre><code class=language-js>fastify.decorate(&#39;html&#39;, payload =&gt; {
  return generateHtml(payload)
})

fastify.get(&#39;/html&#39;, (request, reply) =&gt; {
  reply
    .type(&#39;text/html&#39;)
    .send(fastify.html({ hello: &#39;world&#39; }))
})
</code></pre><p>It works, but it can be way better!</p><pre><code class=language-js>fastify.decorateReply(&#39;html&#39;, function (payload) {
  this.type(&#39;text/html&#39;) // this is the &#39;Reply&#39; object
  this.send(generateHtml(payload))
})

fastify.get(&#39;/html&#39;, (request, reply) =&gt; {
  reply.html({ hello: &#39;world&#39; })
})
</code></pre><p>And in the same way you can do this for the <code>request</code> object:</p><pre><code class=language-js>fastify.decorate(&#39;getHeader&#39;, (req, header) =&gt; {
  return req.headers[header]
})

fastify.addHook(&#39;preHandler&#39;, (request, reply, done) =&gt; {
  request.isHappy = fastify.getHeader(request.raw, &#39;happy&#39;)
  done()
})

fastify.get(&#39;/happiness&#39;, (request, reply) =&gt; {
  reply.send({ happy: request.isHappy })
})
</code></pre><p>Again, it works, but it can be way better!</p><pre><code class=language-js>fastify.decorateRequest(&#39;setHeader&#39;, function (header) {
  this.isHappy = this.headers[header]
})

fastify.decorateRequest(&#39;isHappy&#39;, false) // this will be added to the Request object prototype, yay speed!

fastify.addHook(&#39;preHandler&#39;, (request, reply, done) =&gt; {
  request.setHeader(&#39;happy&#39;)
  done()
})

fastify.get(&#39;/happiness&#39;, (request, reply) =&gt; {
  reply.send({ happy: request.isHappy })
})
</code></pre><p>We&#39;ve seen how to extend server functionality and how handle the encapsulation system, but what if you need to add a function that must be executed every time that the server &quot;<a href=/docs/v2.1.x/v2.1.x/Lifecycle>emits</a>&quot; an event?</p><p><a name=hooks></a></p><h2 id=hooks>Hooks</h2><p>You just built an amazing utility, but now you need to execute that for every request, this is what you will likely do:</p><pre><code class=language-js>fastify.decorate(&#39;util&#39;, (request, key, value) =&gt; { request.key = value })

fastify.get(&#39;/plugin1&#39;, (request, reply) =&gt; {
  fastify.util(request, &#39;timestamp&#39;, new Date())
  reply.send(request)
})

fastify.get(&#39;/plugin2&#39;, (request, reply) =&gt; {
  fastify.util(request, &#39;timestamp&#39;, new Date())
  reply.send(request)
})
</code></pre><p>I think we all agree that this is terrible. Code repeat, awful readability and it cannot scale.</p><p>So what can you do to avoid this annoying issue? Yes, you are right, use an <a href=/docs/v2.1.x/v2.1.x/Hooks>hook</a>!<br></p><pre><code class=language-js>fastify.decorate(&#39;util&#39;, (request, key, value) =&gt; { request[key] = value })

fastify.addHook(&#39;preHandler&#39;, (request, reply, done) =&gt; {
  fastify.util(request, &#39;timestamp&#39;, new Date())
  done()
})

fastify.get(&#39;/plugin1&#39;, (request, reply) =&gt; {
  reply.send(request)
})

fastify.get(&#39;/plugin2&#39;, (request, reply) =&gt; {
  reply.send(request)
})
</code></pre><p>Now for every request you will run your utility, it is obvious that you can register as many hooks as you need.<br>It can happen that you want a hook that must be executed just for a subset of routes, how can you do that? Yep, encapsulation!</p><pre><code class=language-js>fastify.register((instance, opts, next) =&gt; {
  instance.decorate(&#39;util&#39;, (request, key, value) =&gt; { request[key] = value })

  instance.addHook(&#39;preHandler&#39;, (request, reply, done) =&gt; {
    instance.util(request, &#39;timestamp&#39;, new Date())
    done()
  })

  instance.get(&#39;/plugin1&#39;, (request, reply) =&gt; {
    reply.send(request)
  })

  next()
})

fastify.get(&#39;/plugin2&#39;, (request, reply) =&gt; {
  reply.send(request)
})
</code></pre><p>Now your hook will run just for the first route!</p><p>As you probably noticed at this time, <code>request</code> and <code>reply</code> are not the standard Nodejs <em>request</em> and <em>response</em> objects, but Fastify&#39;s objects.<br></p><p><a name=middlewares></a></p><h2 id=middlewares>Middlewares</h2><p>Fastify <a href=/docs/v2.1.x/v2.1.x/Middlewares>supports</a> out of the box Express/Restify/Connect middlewares, this means that you can just drop-in your old code and it will work! <em>(faster, by the way)</em><br>Let&#39;s say that you are arriving from Express, and you already have some Middleware that does exactly what you need, and you don&#39;t want to redo all the work. How we can do that? Checkout our middlewares engine, <a href=https://github.com/fastify/middie>middie</a>.</p><pre><code class=language-js>const yourMiddleware = require(&#39;your-middleware&#39;)
fastify.use(yourMiddleware)
</code></pre><p><a name=distribution></a></p><h2 id=how-to-handle-encapsulation-and-distribution>How to handle encapsulation and distribution</h2><p>Perfect, now you know (almost) all the tools that you can use to extend Fastify. But probably there is something you noted when trying out your code.<br>How can you distribute your code?</p><p>The preferred way to distribute a utility is to wrap all your code inside a <code>register</code>, in this way your plugin can support an asynchronous bootstrap <em>(since <code>decorate</code> is a synchronous api)</em>, in the case of a database connection for example.</p><p><em>Wait, what? Didn&#39;t you tell me that <code>register</code> creates an encapsulation and that what I create inside there will not be available outside?</em><br>Yes, I said that. But what I didn&#39;t tell you, is that you can tell to Fastify to avoid this behavior, with the <a href=https://github.com/fastify/fastify-plugin><code>fastify-plugin</code></a> module.</p><pre><code class=language-js>const fp = require(&#39;fastify-plugin&#39;)
const dbClient = require(&#39;db-client&#39;)

function dbPlugin (fastify, opts, next) {
  dbClient.connect(opts.url, (err, conn) =&gt; {
    fastify.decorate(&#39;db&#39;, conn)
    next()
  })
}

module.exports = fp(dbPlugin)
</code></pre><p>You can also tell to <code>fastify-plugin</code> to check the installed version of Fastify, in case of you need a specific api.</p><p>As we mentioned earlier, Fastify starts loading its plugins <strong>after</strong> <code>.listen()</code>, <code>.inject()</code> or <code>.ready()</code> are called and as such, <strong>after</strong> they have been declared. This means that, even though the plugin may inject variables to the external fastify instance via <a href=/docs/v2.1.x/v2.1.x/Decorators><code>decorate</code></a>, the decorated variables will not be accessible before calling <code>.listen()</code>, <code>.inject()</code> or <code>.ready()</code>.</p><p>In case you rely on a variable injected by a preceding plugin and want to pass that in the <code>options</code> argument of <code>register</code>, you can do so by using a function instead of an object:</p><pre><code class=language-js>const fastify = require(&#39;fastify&#39;)()
const fp = require(&#39;fastify-plugin&#39;)
const dbClient = require(&#39;db-client&#39;)

function dbPlugin (fastify, opts, next) {
  dbClient.connect(opts.url, (err, conn) =&gt; {
    fastify.decorate(&#39;db&#39;, conn)
    next()
  })
}

fastify.register(fp(dbPlugin), { url: &#39;https://example.com&#39; })
fastify.register(require(&#39;your-plugin&#39;), parent =&gt; {
  return { connection: parent.db, otherOption: &#39;foo-bar&#39; }
})
</code></pre><p>In the above example, the <code>parent</code> variable of the function passed in as the second argument of <code>register</code> is a copy of the <strong>external fastify instance</strong> that the plugin was registered at. This means that we are able to access any variables that were injected by preceding plugins in the order of declaration.</p><p><a name=handle-errors></a></p><h2 id=handle-errors>Handle errors</h2><p>It can happen that one of your plugins could fail during the startup. Maybe you expect it and you have a custom logic that will be triggered in that case. How can you do this? The <code>after</code> api is what you need. <code>after</code> simply registers a callback that will be executed just after a register, and it can take up to three parameters.<br>The callback changes based on the parameters your are giving:</p><ol><li>If no parameter is given to the callback and there is an error, that error will be passed to the next error handler.</li><li>If one parameter is given to the callback, that parameter will be the error object.</li><li>If two parameters are given to the callback, the first will be the error object, the second will be the done callback.</li><li>If three parameters are given to the callback, the first will be the error object, the second will be the top level context unless you have specified both server and override, in that case the context will be what the override returns, and the third the done callback.</li></ol><p>Let&#39;s see how to use it:</p><pre><code class=language-js>fastify
  .register(require(&#39;./database-connector&#39;))
  .after(err =&gt; {
    if (err) throw err
  })
</code></pre><p><a name=start></a></p><h2 id=lets-start>Let&#39;s start!</h2><p>Awesome, now you know everything you need to know about Fastify and its plugin system to start building your first plugin, and please if you do, tell us! We will add it to the <a href=https://github.com/fastify/fastify#ecosystem><em>ecosystem</em></a> section of our documentation!</p><p>If you want to see some real world example, checkout:</p><ul><li><a href=https://github.com/fastify/point-of-view><code>point-of-view</code></a> Templates rendering (<em>ejs, pug, handlebars, marko</em>) plugin support for Fastify.</li><li><a href=https://github.com/fastify/fastify-mongodb><code>fastify-mongodb</code></a> Fastify MongoDB connection plugin, with this you can share the same MongoDb connection pool in every part of your server.</li><li><a href=https://github.com/fastify/fastify-multipart><code>fastify-multipart</code></a> Multipart support for Fastify</li><li><a href=https://github.com/fastify/fastify-helmet><code>fastify-helmet</code></a> Important security headers for Fastify</li></ul><p><em>Do you feel it&#39;s missing something here? Let us know! :)</em></p></div><hr><nav class=level></nav></div></div></div></section><script>// dynamically creates a submenu for the current section based on the content headers
  var titles = document.querySelectorAll('#doc-content h3, #doc-content h4')
  var currentMenu = document.getElementById('doc-menu-section')
  if (titles.length && currentMenu) {
    var submenu = document.createElement('ul')
    titles.forEach(el => {
      var currentSubmenuItem = document.createElement('li')
      var currentSubmenuLink = document.createElement('a')
      currentSubmenuLink.href = '#' + el.id
      currentSubmenuLink.title = el.textContent
      currentSubmenuLink.append(document.createTextNode(el.textContent))
      currentSubmenuItem.append(currentSubmenuLink)
      submenu.append(currentSubmenuItem)
    })
    currentMenu.append(submenu)
  }

  // dynamically creates header anchor links
  var headers = document.querySelectorAll('#doc-content h3, #doc-content h4')
  headers.forEach(el => {
    var currentAnchorLink = document.createElement('a')
    currentAnchorLink.className = 'anchor'
    currentAnchorLink.href = "#" + el.id
    currentAnchorLink.append(document.createTextNode('¶'))
    el.insertBefore(currentAnchorLink, el.firstChild);
  })</script><script>const contentLoaded = document.addEventListener('DOMContentLoaded', setTOCHeight)
  const resize = window.addEventListener('resize', setTOCHeight)

  function setTOCHeight() {
    const docHeight = window.innerHeight
    const tocSidebar = document.querySelector('#toc') || 0

    const tocHeight = docHeight - tocSidebar.getBoundingClientRect().top

    document.documentElement.style
      .setProperty('--TOC-height', `${tocHeight}px`)
  }

  window.addEventListener('beforeunload', () => {
    document.removeEventListener(contentLoaded)
    window.removeEventListener(resize)
  })</script></main><footer class="grey is-primary footer"><div class=container><div class="content has-text-centered"><p>Fastify, Copyright &copy; 2016-2023 <a href=https://openjsf.org/ target=_blank rel=noopener>OpenJS Foundation</a> and <a href=https://github.com/fastify/fastify#team target=_blank rel=noopener>The Fastify team</a>, Licensed under <a href=https://github.com/fastify/fastify/blob/master/LICENSE target=_blank rel=noopener>MIT</a></p><a href=https://www.netlify.com><img src=https://www.netlify.com/img/global/badges/netlify-color-accent.svg alt="Deploys by Netlify" loading=lazy decoding=async></a><p><small>Icons by simpleicons.org</small></p></div></div></footer><script src=/js/main.1e1d476db6c0b326.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js integrity="sha512-s+tOYYcC3Jybgr9mVsdAxsRYlGNq4mlAurOrfNuGMQ/SCofNPu92tjE7YRZCsdEtWL1yGkqk15fU/ark206YTg==" crossorigin=anonymous></script><script>hljs.highlightAll();</script><script src=https://cdn.jsdelivr.net/npm/@docsearch/js@alpha></script><script type=text/javascript>docsearch({
        appId: 'DMPMC33PLU',
        apiKey: '12d46b3bfeee6511031cfe00778f3e45',
        indexName: 'fastify',
        container: '#algolia-search-input',
        algoliaOptions: { 'facetFilters': ["version:latest", "tags:docs"] }
      });</script></body></html>