<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Database</title><meta name=description content="Fast and low overhead web framework, for Node.js"><link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.ed24c0a19503e080.png><link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.60c285c424d50738.png><link rel=apple-touch-icon sizes=72x72 href=/images/apple-icon-72x72.e49b27cfe1ab1461.png><link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.752f43fc91b8c1f7.png><link rel=apple-touch-icon sizes=114x114 href=/images/apple-icon-114x114.61739fa1d5a7059a.png><link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.7c25de37c5ce2ec1.png><link rel=apple-touch-icon sizes=144x144 href=/images/apple-icon-144x144.04d88fb27bd92cbe.png><link rel=apple-touch-icon sizes=152x152 href=/images/apple-icon-152x152.9364781175671626.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-icon-180x180.67579100928bfcd2.png><link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.37eb7f1ae3853740.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.1e22f0e774bc3cce.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.7e8a68b1b80c1799.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.e534ce05cb727f1a.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content=#ffffff><meta name=msapplication-TileImage content=/images/ms-icon-144x144.png><meta name=theme-color content=#ffffff><meta property=og:url content=https://www.fastify.io/docs/latest/Guides/Database><meta property=og:type content=website><meta property=og:title content=Database><meta property=og:description content="Fast and low overhead web framework, for Node.js"><meta property=og:image content=https://www.fastify.io/images/fastify-fb-share-image.07b6e6860853c758.png><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@fastifyjs><meta name=twitter:creator content=@fastifyjs><meta name=twitter:title content=Database><meta name=twitter:description content="Fast and low overhead web framework, for Node.js"><meta name=twitter:image content=https://www.fastify.io/images/fastify-twitter-share-image.cd9f217b360af3e2.png><link rel=stylesheet href=/css/style.5319a09ba5476762.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css integrity="sha512-kZqGbhf9JTB4bVJ0G8HCkqmaPcRgo88F0dneK30yku5Y/dep7CZfCnNml2Je/sY4lBoqoksXz4PtVXS4GHSUzQ==" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@alpha><link ref=canonical href=/docs/v4.5.x/Guides/Database></head><body><nav id=main-navbar class=navbar><div class=navbar-brand><a class=navbar-item href=/ ><img src=/images/fastify-logo-menu.d13f8da7a965c800.png alt="Fastify: Fast and low overhead web framework, for Node.js" height=28> </a><a class="navbar-item is-hidden-desktop" href=https://github.com/fastify/fastify target=_blank rel=noopener><span class=icon style="color: #333;"><i class="fa fa-github"></i></span></a><div class="navbar-burger burger" data-target=mobileMenu><span></span> <span></span> <span></span></div></div><div class=navbar-menu id=mobileMenu><div class=navbar-start><a class=navbar-item href=/ >Home</a> <a class=navbar-item href=/docs/latest>Docs</a> <a class=navbar-item href=/ecosystem>Ecosystem</a> <a class=navbar-item href=/benchmarks>Benchmarks</a> <a class=navbar-item href=/contribute>Contribute</a> <a class=navbar-item href=https://medium.com/@fastifyjs/ >Blog</a> <a class=navbar-item href=https://github.com/fastify/help>Help</a></div><div class=navbar-end><span id=algolia-search-input class="control has-icons-left navbar-item"></span> <a class=navbar-item href=https://github.com/fastify/fastify target=_blank rel=noopener><span class="fa fa-github"></span>&nbsp;GitHub </a><a class=navbar-item href=https://twitter.com/fastifyjs target=_blank rel=noopener><span class="fa fa-twitter"></span>&nbsp;Twitter</a></div></div></nav><main class=page-content aria-label=Content><section class="hero is-primary" style="background-image: url(/images/bg-pattern-dark.3f8cda863b3bbf52.png)"><div class=hero-body><div class=container><h1 class=title>Documentation (latest — v4.5.1)</h1></div></div></section><section class=section><div class=container><div class=columns><div class="column is-3 is-hidden-mobile sticky-container"><aside class="menu sticky" id=toc><ul class=menu-list></ul><p class=menu-label><a href=/docs/latest/Guides>Guides</a></p><ul class=menu-list><li style="text-transform: capitalize"><a title=Benchmarking href=/docs/latest/Guides/Benchmarking>Benchmarking</a></li><li style="text-transform: capitalize"><a title=Contributing href=/docs/latest/Guides/Contributing>Contributing</a></li><li style="text-transform: capitalize" id=doc-menu-section><a title=Database class=is-active href=/docs/latest/Guides/Database>Database</a></li><li style="text-transform: capitalize"><a title=Delay-Accepting-Requests href=/docs/latest/Guides/Delay-Accepting-Requests>Delay-Accepting-Requests</a></li><li style="text-transform: capitalize"><a title=Ecosystem href=/docs/latest/Guides/Ecosystem>Ecosystem</a></li><li style="text-transform: capitalize"><a title=Fluent-Schema href=/docs/latest/Guides/Fluent-Schema>Fluent-Schema</a></li><li style="text-transform: capitalize"><a title=Getting-Started href=/docs/latest/Guides/Getting-Started>Getting-Started</a></li><li style="text-transform: capitalize"><a title=Migration-Guide-V3 href=/docs/latest/Guides/Migration-Guide-V3>Migration-Guide-V3</a></li><li style="text-transform: capitalize"><a title=Migration-Guide-V4 href=/docs/latest/Guides/Migration-Guide-V4>Migration-Guide-V4</a></li><li style="text-transform: capitalize"><a title=Plugins-Guide href=/docs/latest/Guides/Plugins-Guide>Plugins-Guide</a></li><li style="text-transform: capitalize"><a title=Prototype-Poisoning href=/docs/latest/Guides/Prototype-Poisoning>Prototype-Poisoning</a></li><li style="text-transform: capitalize"><a title=Recommendations href=/docs/latest/Guides/Recommendations>Recommendations</a></li><li style="text-transform: capitalize"><a title=Serverless href=/docs/latest/Guides/Serverless>Serverless</a></li><li style="text-transform: capitalize"><a title=Style-Guide href=/docs/latest/Guides/Style-Guide>Style-Guide</a></li><li style="text-transform: capitalize"><a title=Testing href=/docs/latest/Guides/Testing>Testing</a></li><li style="text-transform: capitalize"><a title=Write-Plugin href=/docs/latest/Guides/Write-Plugin>Write-Plugin</a></li></ul><p class=menu-label><a href=/docs/latest/Reference>Reference</a></p><ul class=menu-list><li style="text-transform: capitalize"><a title=ContentTypeParser href=/docs/latest/Reference/ContentTypeParser>ContentTypeParser</a></li><li style="text-transform: capitalize"><a title=Decorators href=/docs/latest/Reference/Decorators>Decorators</a></li><li style="text-transform: capitalize"><a title=Encapsulation href=/docs/latest/Reference/Encapsulation>Encapsulation</a></li><li style="text-transform: capitalize"><a title=Errors href=/docs/latest/Reference/Errors>Errors</a></li><li style="text-transform: capitalize"><a title=HTTP2 href=/docs/latest/Reference/HTTP2>HTTP2</a></li><li style="text-transform: capitalize"><a title=Hooks href=/docs/latest/Reference/Hooks>Hooks</a></li><li style="text-transform: capitalize"><a title=LTS href=/docs/latest/Reference/LTS>LTS</a></li><li style="text-transform: capitalize"><a title=Lifecycle href=/docs/latest/Reference/Lifecycle>Lifecycle</a></li><li style="text-transform: capitalize"><a title=Logging href=/docs/latest/Reference/Logging>Logging</a></li><li style="text-transform: capitalize"><a title=Middleware href=/docs/latest/Reference/Middleware>Middleware</a></li><li style="text-transform: capitalize"><a title=Plugins href=/docs/latest/Reference/Plugins>Plugins</a></li><li style="text-transform: capitalize"><a title=Reply href=/docs/latest/Reference/Reply>Reply</a></li><li style="text-transform: capitalize"><a title=Request href=/docs/latest/Reference/Request>Request</a></li><li style="text-transform: capitalize"><a title=Routes href=/docs/latest/Reference/Routes>Routes</a></li><li style="text-transform: capitalize"><a title=Server href=/docs/latest/Reference/Server>Server</a></li><li style="text-transform: capitalize"><a title=Type-Providers href=/docs/latest/Reference/Type-Providers>Type-Providers</a></li><li style="text-transform: capitalize"><a title=TypeScript href=/docs/latest/Reference/TypeScript>TypeScript</a></li><li style="text-transform: capitalize"><a title=Validation-and-Serialization href=/docs/latest/Reference/Validation-and-Serialization>Validation-and-Serialization</a></li></ul><div class=content style="margin: .8em; border-top: 1px solid #ccc; padding: .8em 0 0 0">Docs version<div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value"><option selected value=/docs/latest>latest</option><option value=/docs/master>master</option><option value=/docs/v4.5.x>v4.5.x</option><option value=/docs/v4.4.x>v4.4.x</option><option value=/docs/v4.3.x>v4.3.x</option><option value=/docs/v4.2.x>v4.2.x</option><option value=/docs/v4.1.x>v4.1.x</option><option value=/docs/v4.0.x>v4.0.x</option><option value=/docs/v3.29.x>v3.29.x</option><option value=/docs/v3.28.x>v3.28.x</option><option value=/docs/v3.27.x>v3.27.x</option><option value=/docs/v3.26.x>v3.26.x</option><option value=/docs/v3.25.x>v3.25.x</option><option value=/docs/v3.24.x>v3.24.x</option><option value=/docs/v3.23.x>v3.23.x</option><option value=/docs/v3.22.x>v3.22.x</option><option value=/docs/v3.21.x>v3.21.x</option><option value=/docs/v3.20.x>v3.20.x</option><option value=/docs/v3.19.x>v3.19.x</option><option value=/docs/v3.18.x>v3.18.x</option><option value=/docs/v3.17.x>v3.17.x</option><option value=/docs/v3.16.x>v3.16.x</option><option value=/docs/v3.15.x>v3.15.x</option><option value=/docs/v3.14.x>v3.14.x</option><option value=/docs/v3.13.x>v3.13.x</option><option value=/docs/v3.12.x>v3.12.x</option><option value=/docs/v3.11.x>v3.11.x</option><option value=/docs/v3.10.x>v3.10.x</option><option value=/docs/v3.9.x>v3.9.x</option><option value=/docs/v3.8.x>v3.8.x</option><option value=/docs/v3.7.x>v3.7.x</option><option value=/docs/v3.6.x>v3.6.x</option><option value=/docs/v3.5.x>v3.5.x</option><option value=/docs/v3.4.x>v3.4.x</option><option value=/docs/v3.3.x>v3.3.x</option><option value=/docs/v3.2.x>v3.2.x</option><option value=/docs/v3.1.x>v3.1.x</option><option value=/docs/v3.0.x>v3.0.x</option><option value=/docs/v2.15.x>v2.15.x</option><option value=/docs/v2.14.x>v2.14.x</option><option value=/docs/v2.13.x>v2.13.x</option><option value=/docs/v2.12.x>v2.12.x</option><option value=/docs/v2.11.x>v2.11.x</option><option value=/docs/v2.10.x>v2.10.x</option><option value=/docs/v2.9.x>v2.9.x</option><option value=/docs/v2.8.x>v2.8.x</option><option value=/docs/v2.7.x>v2.7.x</option><option value=/docs/v2.6.x>v2.6.x</option><option value=/docs/v2.5.x>v2.5.x</option><option value=/docs/v2.4.x>v2.4.x</option><option value=/docs/v2.3.x>v2.3.x</option><option value=/docs/v2.2.x>v2.2.x</option><option value=/docs/v2.1.x>v2.1.x</option><option value=/docs/v2.0.x>v2.0.x</option><option value=/docs/v1.14.x>v1.14.x</option><option value=/docs/v1.13.x>v1.13.x</option></select></div></div></div></div></aside></div><div class="column is-9"><nav class=breadcrumb><ul><li><a href=/ style="padding-left: 0">Fastify</a></li><li><a href=/docs/latest>Documentation</a></li><li><div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value" style="border: none;"><option selected value=/docs/latest>latest</option><option value=/docs/master>master</option><option value=/docs/v4.5.x>v4.5.x</option><option value=/docs/v4.4.x>v4.4.x</option><option value=/docs/v4.3.x>v4.3.x</option><option value=/docs/v4.2.x>v4.2.x</option><option value=/docs/v4.1.x>v4.1.x</option><option value=/docs/v4.0.x>v4.0.x</option><option value=/docs/v3.29.x>v3.29.x</option><option value=/docs/v3.28.x>v3.28.x</option><option value=/docs/v3.27.x>v3.27.x</option><option value=/docs/v3.26.x>v3.26.x</option><option value=/docs/v3.25.x>v3.25.x</option><option value=/docs/v3.24.x>v3.24.x</option><option value=/docs/v3.23.x>v3.23.x</option><option value=/docs/v3.22.x>v3.22.x</option><option value=/docs/v3.21.x>v3.21.x</option><option value=/docs/v3.20.x>v3.20.x</option><option value=/docs/v3.19.x>v3.19.x</option><option value=/docs/v3.18.x>v3.18.x</option><option value=/docs/v3.17.x>v3.17.x</option><option value=/docs/v3.16.x>v3.16.x</option><option value=/docs/v3.15.x>v3.15.x</option><option value=/docs/v3.14.x>v3.14.x</option><option value=/docs/v3.13.x>v3.13.x</option><option value=/docs/v3.12.x>v3.12.x</option><option value=/docs/v3.11.x>v3.11.x</option><option value=/docs/v3.10.x>v3.10.x</option><option value=/docs/v3.9.x>v3.9.x</option><option value=/docs/v3.8.x>v3.8.x</option><option value=/docs/v3.7.x>v3.7.x</option><option value=/docs/v3.6.x>v3.6.x</option><option value=/docs/v3.5.x>v3.5.x</option><option value=/docs/v3.4.x>v3.4.x</option><option value=/docs/v3.3.x>v3.3.x</option><option value=/docs/v3.2.x>v3.2.x</option><option value=/docs/v3.1.x>v3.1.x</option><option value=/docs/v3.0.x>v3.0.x</option><option value=/docs/v2.15.x>v2.15.x</option><option value=/docs/v2.14.x>v2.14.x</option><option value=/docs/v2.13.x>v2.13.x</option><option value=/docs/v2.12.x>v2.12.x</option><option value=/docs/v2.11.x>v2.11.x</option><option value=/docs/v2.10.x>v2.10.x</option><option value=/docs/v2.9.x>v2.9.x</option><option value=/docs/v2.8.x>v2.8.x</option><option value=/docs/v2.7.x>v2.7.x</option><option value=/docs/v2.6.x>v2.6.x</option><option value=/docs/v2.5.x>v2.5.x</option><option value=/docs/v2.4.x>v2.4.x</option><option value=/docs/v2.3.x>v2.3.x</option><option value=/docs/v2.2.x>v2.2.x</option><option value=/docs/v2.1.x>v2.1.x</option><option value=/docs/v2.0.x>v2.0.x</option><option value=/docs/v1.14.x>v1.14.x</option><option value=/docs/v1.13.x>v1.13.x</option></select></div></div></div></li><div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value" style="border: none;"><option value=/docs/latest>Documentation</option><option value=/docs/latest/Guides>Guides</option><option value=/docs/latest/Guides/Benchmarking>Benchmarking</option><option value=/docs/latest/Guides/Contributing>Contributing</option><option selected value=/docs/latest/Guides/Database>Database</option><option value=/docs/latest/Guides/Delay-Accepting-Requests>Delay-Accepting-Requests</option><option value=/docs/latest/Guides/Ecosystem>Ecosystem</option><option value=/docs/latest/Guides/Fluent-Schema>Fluent-Schema</option><option value=/docs/latest/Guides/Getting-Started>Getting-Started</option><option value=/docs/latest/Guides/Migration-Guide-V3>Migration-Guide-V3</option><option value=/docs/latest/Guides/Migration-Guide-V4>Migration-Guide-V4</option><option value=/docs/latest/Guides/Plugins-Guide>Plugins-Guide</option><option value=/docs/latest/Guides/Prototype-Poisoning>Prototype-Poisoning</option><option value=/docs/latest/Guides/Recommendations>Recommendations</option><option value=/docs/latest/Guides/Serverless>Serverless</option><option value=/docs/latest/Guides/Style-Guide>Style-Guide</option><option value=/docs/latest/Guides/Testing>Testing</option><option value=/docs/latest/Guides/Write-Plugin>Write-Plugin</option><option value=/docs/latest/Reference>Reference</option><option value=/docs/latest/Reference/ContentTypeParser>ContentTypeParser</option><option value=/docs/latest/Reference/Decorators>Decorators</option><option value=/docs/latest/Reference/Encapsulation>Encapsulation</option><option value=/docs/latest/Reference/Errors>Errors</option><option value=/docs/latest/Reference/HTTP2>HTTP2</option><option value=/docs/latest/Reference/Hooks>Hooks</option><option value=/docs/latest/Reference/LTS>LTS</option><option value=/docs/latest/Reference/Lifecycle>Lifecycle</option><option value=/docs/latest/Reference/Logging>Logging</option><option value=/docs/latest/Reference/Middleware>Middleware</option><option value=/docs/latest/Reference/Plugins>Plugins</option><option value=/docs/latest/Reference/Reply>Reply</option><option value=/docs/latest/Reference/Request>Request</option><option value=/docs/latest/Reference/Routes>Routes</option><option value=/docs/latest/Reference/Server>Server</option><option value=/docs/latest/Reference/Type-Providers>Type-Providers</option><option value=/docs/latest/Reference/TypeScript>TypeScript</option><option value=/docs/latest/Reference/Validation-and-Serialization>Validation-and-Serialization</option></select></div></div></div></ul></nav><div id=doc-content class=content><h2 id=database>Database</h2><p>Fastify&#39;s ecosystem provides a handful of plugins for connecting to various database engines. This guide covers engines that have Fastify plugins maintained within the Fastify organization.</p><blockquote><p>If a plugin for your database of choice does not exist you can still use the database as Fastify is database agnostic. By following the examples of the database plugins listed in this guide, a plugin can be written for the missing database engine.</p></blockquote><blockquote><p>If you would like to write your own Fastify plugin please take a look at the <a href=.././Plugins-Guide>plugins guide</a></p></blockquote><h3 id=mysql><a href=https://github.com/fastify/fastify-mysql>MySQL</a></h3><p>Install the plugin by running <code>npm i @fastify/mysql</code>.</p><p><em>Usage:</em></p><pre><code class=language-javascript>const fastify = require(&#39;fastify&#39;)()

fastify.register(require(&#39;@fastify/mysql&#39;), {
  connectionString: &#39;mysql://root@localhost/mysql&#39;
})

fastify.get(&#39;/user/:id&#39;, function(req, reply) {
  fastify.mysql.query(
    &#39;SELECT id, username, hash, salt FROM users WHERE id=?&#39;, [req.params.id],
    function onResult (err, result) {
      reply.send(err || result)
    }
  )
})

fastify.listen({ port: 3000 }, err =&gt; {
  if (err) throw err
  console.log(`server listening on ${fastify.server.address().port}`)
})
</code></pre><h3 id=postgres><a href=https://github.com/fastify/fastify-postgres>Postgres</a></h3><p>Install the plugin by running <code>npm i pg @fastify/postgres</code>.</p><p><em>Example</em>:</p><pre><code class=language-javascript>const fastify = require(&#39;fastify&#39;)()

fastify.register(require(&#39;@fastify/postgres&#39;), {
  connectionString: &#39;postgres://postgres@localhost/postgres&#39;
})

fastify.get(&#39;/user/:id&#39;, function (req, reply) {
  fastify.pg.query(
    &#39;SELECT id, username, hash, salt FROM users WHERE id=$1&#39;, [req.params.id],
    function onResult (err, result) {
      reply.send(err || result)
    }
  )
})

fastify.listen({ port: 3000 }, err =&gt; {
  if (err) throw err
  console.log(`server listening on ${fastify.server.address().port}`)
})
</code></pre><h3 id=redis><a href=https://github.com/fastify/fastify-redis>Redis</a></h3><p>Install the plugin by running <code>npm i @fastify/redis</code></p><p><em>Usage:</em></p><pre><code class=language-javascript>&#39;use strict&#39;

const fastify = require(&#39;fastify&#39;)()

fastify.register(require(&#39;@fastify/redis&#39;), { host: &#39;127.0.0.1&#39; })
// or
fastify.register(require(&#39;@fastify/redis&#39;), { url: &#39;redis://127.0.0.1&#39;, /* other redis options */ })

fastify.get(&#39;/foo&#39;, function (req, reply) {
  const { redis } = fastify
  redis.get(req.query.key, (err, val) =&gt; {
    reply.send(err || val)
  })
})

fastify.post(&#39;/foo&#39;, function (req, reply) {
  const { redis } = fastify
  redis.set(req.body.key, req.body.value, (err) =&gt; {
    reply.send(err || { status: &#39;ok&#39; })
  })
})

fastify.listen({ port: 3000 }, err =&gt; {
  if (err) throw err
  console.log(`server listening on ${fastify.server.address().port}`)
})
</code></pre><p>By default <code>@fastify/redis</code> doesn&#39;t close the client connection when Fastify server shuts down. To opt-in to this behavior, register the client like so:</p><pre><code class=language-javascript>fastify.register(require(&#39;@fastify/redis&#39;), {
  client: redis,
  closeClient: true
})
</code></pre><h3 id=mongo><a href=https://github.com/fastify/fastify-mongodb>Mongo</a></h3><p>Install the plugin by running <code>npm i @fastify/mongodb</code></p><p><em>Usage:</em></p><pre><code class=language-javascript>const fastify = require(&#39;fastify&#39;)()

fastify.register(require(&#39;@fastify/mongodb&#39;), {
  // force to close the mongodb connection when app stopped
  // the default value is false
  forceClose: true,

  url: &#39;mongodb://mongo/mydb&#39;
})

fastify.get(&#39;/user/:id&#39;, function (req, reply) {
  // Or this.mongo.client.db(&#39;mydb&#39;).collection(&#39;users&#39;)
  const users = this.mongo.db.collection(&#39;users&#39;)

  // if the id is an ObjectId format, you need to create a new ObjectId
  const id = this.mongo.ObjectId(req.params.id)
  users.findOne({ id }, (err, user) =&gt; {
    if (err) {
      reply.send(err)
      return
    }
    reply.send(user)
  })
})

fastify.listen({ port: 3000 }, err =&gt; {
  if (err) throw err
})
</code></pre><h3 id=leveldb><a href=https://github.com/fastify/fastify-leveldb>LevelDB</a></h3><p>Install the plugin by running <code>npm i @fastify/leveldb</code></p><p><em>Usage:</em></p><pre><code class=language-javascript>const fastify = require(&#39;fastify&#39;)()

fastify.register(
  require(&#39;@fastify/leveldb&#39;),
  { name: &#39;db&#39; }
)

fastify.get(&#39;/foo&#39;, async function (req, reply) {
  const val = await this.level.db.get(req.query.key)
  return val
})

fastify.post(&#39;/foo&#39;, async function (req, reply) {
  await this.level.db.put(req.body.key, req.body.value)
  return { status: &#39;ok&#39; }
})

fastify.listen({ port: 3000 }, err =&gt; {
  if (err) throw err
  console.log(`server listening on ${fastify.server.address().port}`)
})
</code></pre><h3 id=writing-plugin-for-a-database-library>Writing plugin for a database library</h3><p>We could write a plugin for a database library too (e.g. Knex, Prisma, or TypeORM). We will use <a href=https://knexjs.org/ >Knex</a> in our example.</p><pre><code class=language-javascript>&#39;use strict&#39;

const fp = require(&#39;fastify-plugin&#39;)
const knex = require(&#39;knex&#39;)

function knexPlugin(fastify, options, done) {
  if(!fastify.knex) {
    const knex = knex(options)
    fastify.decorate(&#39;knex&#39;, knex)

    fastify.addHook(&#39;onClose&#39;, (fastify, done) =&gt; {
      if (fastify.knex === knex) {
        fastify.knex.destroy(done)
      }
    })
  }

  done()
}

export default fp(knexPlugin, { name: &#39;fastify-knex-example&#39; })
</code></pre><h3 id=writing-a-plugin-for-a-database-engine>Writing a plugin for a database engine</h3><p>In this example, we will create a basic Fastify MySQL plugin from scratch (it is a stripped-down example, please use the official plugin in production).</p><pre><code class=language-javascript>const fp = require(&#39;fastify-plugin&#39;)
const mysql = require(&#39;mysql2/promise&#39;)

function fastifyMysql(fastify, options, done) {
  const connection = mysql.createConnection(options)

  if (!fastify.mysql) {
    fastify.decorate(&#39;mysql&#39;, connection)
  }

  fastify.addHook(&#39;onClose&#39;, (fastify, done) =&gt; connection.end().then(done).catch(done))

  done()
}

export default fp(fastifyMysql, { name: &#39;fastify-mysql-example&#39; })
</code></pre><h3 id=migrations>Migrations</h3><p>Database schema migrations are an integral part of database management and development. Migrations provide a repeatable and testable way to modify a database&#39;s schema and prevent data loss.</p><p>As stated at the beginning of the guide, Fastify is database agnostic and any NodeJS database migration tool can be used with it. We will give an example of using <a href=https://www.npmjs.com/package/postgrator>Postgrator</a> which has support for Postgres, MySQL, SQL Server and SQLite. For MongoDB migrations, please check <a href=https://www.npmjs.com/package/migrate-mongo>migrate-mongo</a>.</p><h4 id=postgrator><a href=https://www.npmjs.com/package/postgrator>Postgrator</a></h4><p>Postgrator is NodeJS SQL migration tool that uses a directory of SQL scripts to alter the database schema. Each file an migrations folder need to follow the pattern: <code>[version].[action].[optional-description].sql</code>.</p><p><strong>version:</strong> must be an incrementing number (e.g. <code>001</code> or a timestamp).</p><p><strong>action:</strong> should be <code>do</code> or <code>undo</code>. <code>do</code> implements the version, <code>undo</code> reverts it. Think about it like <code>up</code> and <code>down</code> in other migration tools.</p><p><strong>optional-description</strong> describes which changes migration makes. Although optional, it should be used for all migrations as it makes it easier for everyone to know which changes are made in a migration.</p><p>In our example, we are going to have a single migration that creates a <code>users</code> table and we are going to use <code>Postgrator</code> to run the migration.</p><blockquote><p>Run <code>npm i pg postgrator</code> to install dependencies needed for the example.</p></blockquote><pre><code class=language-sql>// 001.do.create-users-table.sql
CREATE TABLE IF NOT EXISTS users (
  id SERIAL PRIMARY KEY NOT NULL,
  created_at DATE NOT NULL DEFAULT CURRENT_DATE,
  firstName TEXT NOT NULL,
  lastName TEXT NOT NULL
);
</code></pre><pre><code class=language-javascript>const pg = require(&#39;pg&#39;)
const Postgrator = require(&#39;postgrator&#39;)
const path = require(&#39;path&#39;)

async function migrate() {
  const client = new pg.Client({
    host: &#39;localhost&#39;,
    port: 5432,
    database: &#39;example&#39;, 
    user: &#39;example&#39;,
    password: &#39;example&#39;,
  });

  try {
    const postgrator = new Postgrator({
      migrationPattern: path.join(__dirname, &#39;/migrations/*&#39;),
      driver: &#39;pg&#39;,
      database: &#39;example&#39;,
      schemaTable: &#39;migrations&#39;,
      currentSchema: &#39;public&#39;, // Postgres and MS SQL Server only
      execQuery: (query) =&gt; client.query(query),
    });

    const result = await postgrator.migrate()

    if (result.length === 0) {
      console.log(
        &#39;No migrations run for schema &quot;public&quot;. Already at the latest one.&#39;
      )
    }

    console.log(&#39;Migration done.&#39;)

    process.exitCode = 0
  } catch(err) {
    console.error(error)
    process.exitCode = 1
  }

  await client.end()
}

migrate()
</code></pre></div><hr><nav class=level></nav></div></div></div></section><script>// dynamically creates a submenu for the current section based on the content headers
  var titles = document.querySelectorAll('#doc-content h3, #doc-content h4')
  var currentMenu = document.getElementById('doc-menu-section')
  if (titles.length && currentMenu) {
    var submenu = document.createElement('ul')
    titles.forEach(el => {
      var currentSubmenuItem = document.createElement('li')
      var currentSubmenuLink = document.createElement('a')
      currentSubmenuLink.href = '#' + el.id
      currentSubmenuLink.title = el.textContent
      currentSubmenuLink.append(document.createTextNode(el.textContent))
      currentSubmenuItem.append(currentSubmenuLink)
      submenu.append(currentSubmenuItem)
    })
    currentMenu.append(submenu)
  }

  // dynamically creates header anchor links
  var headers = document.querySelectorAll('#doc-content h3, #doc-content h4')
  headers.forEach(el => {
    var currentAnchorLink = document.createElement('a')
    currentAnchorLink.className = 'anchor'
    currentAnchorLink.href = "#" + el.id
    currentAnchorLink.append(document.createTextNode('¶'))
    el.insertBefore(currentAnchorLink, el.firstChild);
  })</script><script>const contentLoaded = document.addEventListener('DOMContentLoaded', setTOCHeight)
  const resize = window.addEventListener('resize', setTOCHeight)

  function setTOCHeight() {
    const docHeight = window.innerHeight
    const tocSidebar = document.querySelector('#toc') || 0

    const tocHeight = docHeight - tocSidebar.getBoundingClientRect().top

    document.documentElement.style
      .setProperty('--TOC-height', `${tocHeight}px`)
  }

  window.addEventListener('beforeunload', () => {
    document.removeEventListener(contentLoaded)
    window.removeEventListener(resize)
  })</script></main><footer class="grey is-primary footer"><div class=container><div class="content has-text-centered"><p>Fastify, Copyright &copy; 2016-2022 <a href=https://openjsf.org/ target=_blank rel=noopener>OpenJS Foundation</a> and <a href=https://github.com/fastify/fastify#team target=_blank rel=noopener>The Fastify team</a>, Licensed under <a href=https://github.com/fastify/fastify/blob/master/LICENSE target=_blank rel=noopener>MIT</a></p><a href=https://www.netlify.com><img src=https://www.netlify.com/img/global/badges/netlify-color-accent.svg alt="Deploys by Netlify"></a><p><small>Icons by simpleicons.org</small></p></div></div></footer><script src=/js/main.1e1d476db6c0b326.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js integrity="sha512-s+tOYYcC3Jybgr9mVsdAxsRYlGNq4mlAurOrfNuGMQ/SCofNPu92tjE7YRZCsdEtWL1yGkqk15fU/ark206YTg==" crossorigin=anonymous></script><script>hljs.highlightAll();</script><script src=https://cdn.jsdelivr.net/npm/@docsearch/js@alpha></script><script type=text/javascript>docsearch({
        appId: 'DMPMC33PLU',
        apiKey: '12d46b3bfeee6511031cfe00778f3e45',
        indexName: 'fastify',
        container: '#algolia-search-input',
        algoliaOptions: { 'facetFilters': ["version:latest", "tags:docs"] }
      });</script></body></html>