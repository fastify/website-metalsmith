<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Hooks</title><meta name=description content="Fast and low overhead web framework, for Node.js"><link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.ed24c0a19503e080.png><link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.60c285c424d50738.png><link rel=apple-touch-icon sizes=72x72 href=/images/apple-icon-72x72.e49b27cfe1ab1461.png><link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.752f43fc91b8c1f7.png><link rel=apple-touch-icon sizes=114x114 href=/images/apple-icon-114x114.61739fa1d5a7059a.png><link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.7c25de37c5ce2ec1.png><link rel=apple-touch-icon sizes=144x144 href=/images/apple-icon-144x144.04d88fb27bd92cbe.png><link rel=apple-touch-icon sizes=152x152 href=/images/apple-icon-152x152.9364781175671626.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-icon-180x180.67579100928bfcd2.png><link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.37eb7f1ae3853740.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.1e22f0e774bc3cce.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.7e8a68b1b80c1799.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.e534ce05cb727f1a.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content=#ffffff><meta name=msapplication-TileImage content=/images/ms-icon-144x144.png><meta name=theme-color content=#ffffff><meta property=og:url content=https://www.fastify.io/docs/latest/Reference/Hooks><meta property=og:type content=website><meta property=og:title content=Hooks><meta property=og:description content="Fast and low overhead web framework, for Node.js"><meta property=og:image content=https://www.fastify.io/images/fastify-fb-share-image.07b6e6860853c758.png><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@fastifyjs><meta name=twitter:creator content=@fastifyjs><meta name=twitter:title content=Hooks><meta name=twitter:description content="Fast and low overhead web framework, for Node.js"><meta name=twitter:image content=https://www.fastify.io/images/fastify-twitter-share-image.cd9f217b360af3e2.png><link rel=stylesheet href=/css/style.f4d6592b3a91c5ef.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css integrity="sha512-kZqGbhf9JTB4bVJ0G8HCkqmaPcRgo88F0dneK30yku5Y/dep7CZfCnNml2Je/sY4lBoqoksXz4PtVXS4GHSUzQ==" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@alpha><link ref=canonical href=/docs/v4.18.x/Reference/Hooks></head><body><nav id=main-navbar class=navbar><div class=navbar-brand><a class=navbar-item href=/ ><img src=/images/fastify-logo-menu.d13f8da7a965c800.png alt="Fastify: Fast and low overhead web framework, for Node.js" height=28 decoding=async> </a><a class="navbar-item is-hidden-desktop" href=https://github.com/fastify/fastify target=_blank rel=noopener><span class=icon style="color: #333;"><i class="fa fa-github"></i></span></a><div class="navbar-burger burger" data-target=mobileMenu><span></span> <span></span> <span></span></div></div><div class=navbar-menu id=mobileMenu><div class=navbar-start><a class=navbar-item href=/ >Home</a> <a class=navbar-item href=/docs/latest>Docs</a> <a class=navbar-item href=/ecosystem>Ecosystem</a> <a class=navbar-item href=/benchmarks>Benchmarks</a> <a class=navbar-item href=/contribute>Contribute</a> <a class=navbar-item href=https://medium.com/@fastifyjs/ >Blog</a> <a class=navbar-item href=https://github.com/fastify/help>Help</a></div><div class=navbar-end><span id=algolia-search-input class="control has-icons-left navbar-item"></span> <a class=navbar-item href=https://github.com/fastify/fastify target=_blank rel=noopener><span class="fa fa-github"></span>&nbsp;GitHub </a><a class=navbar-item href=https://twitter.com/fastifyjs target=_blank rel=noopener><span class="fa fa-twitter"></span>&nbsp;Twitter </a><a class=navbar-item rel=me href=https://fosstodon.org/@fastify target=_blank><span class="fa fa-hashtag"></span>&nbsp;Mastodon</a></div></div></nav><main class=page-content aria-label=Content><section class="hero is-primary" style="background-image: url(/images/bg-pattern-dark.3f8cda863b3bbf52.png)"><div class=hero-body><div class=container><h1 class=title>Documentation (latest â€” v4.18.0)</h1></div></div></section><section class=section><div class=container><div class=columns><div class="column is-3 is-hidden-mobile sticky-container"><aside class="menu sticky" id=toc><ul class=menu-list></ul><p class=menu-label><a href=/docs/latest/Guides>Guides</a></p><ul class=menu-list><li style="text-transform: capitalize"><a title=Benchmarking href=/docs/latest/Guides/Benchmarking>Benchmarking</a></li><li style="text-transform: capitalize"><a title=Contributing href=/docs/latest/Guides/Contributing>Contributing</a></li><li style="text-transform: capitalize"><a title=Database href=/docs/latest/Guides/Database>Database</a></li><li style="text-transform: capitalize"><a title=Delay-Accepting-Requests href=/docs/latest/Guides/Delay-Accepting-Requests>Delay-Accepting-Requests</a></li><li style="text-transform: capitalize"><a title=Detecting-When-Clients-Abort href=/docs/latest/Guides/Detecting-When-Clients-Abort>Detecting-When-Clients-Abort</a></li><li style="text-transform: capitalize"><a title=Ecosystem href=/docs/latest/Guides/Ecosystem>Ecosystem</a></li><li style="text-transform: capitalize"><a title=Fluent-Schema href=/docs/latest/Guides/Fluent-Schema>Fluent-Schema</a></li><li style="text-transform: capitalize"><a title=Getting-Started href=/docs/latest/Guides/Getting-Started>Getting-Started</a></li><li style="text-transform: capitalize"><a title=Migration-Guide-V3 href=/docs/latest/Guides/Migration-Guide-V3>Migration-Guide-V3</a></li><li style="text-transform: capitalize"><a title=Migration-Guide-V4 href=/docs/latest/Guides/Migration-Guide-V4>Migration-Guide-V4</a></li><li style="text-transform: capitalize"><a title=Plugins-Guide href=/docs/latest/Guides/Plugins-Guide>Plugins-Guide</a></li><li style="text-transform: capitalize"><a title=Prototype-Poisoning href=/docs/latest/Guides/Prototype-Poisoning>Prototype-Poisoning</a></li><li style="text-transform: capitalize"><a title=Recommendations href=/docs/latest/Guides/Recommendations>Recommendations</a></li><li style="text-transform: capitalize"><a title=Serverless href=/docs/latest/Guides/Serverless>Serverless</a></li><li style="text-transform: capitalize"><a title=Style-Guide href=/docs/latest/Guides/Style-Guide>Style-Guide</a></li><li style="text-transform: capitalize"><a title=Testing href=/docs/latest/Guides/Testing>Testing</a></li><li style="text-transform: capitalize"><a title=Write-Plugin href=/docs/latest/Guides/Write-Plugin>Write-Plugin</a></li><li style="text-transform: capitalize"><a title=Write-Type-Provider href=/docs/latest/Guides/Write-Type-Provider>Write-Type-Provider</a></li></ul><p class=menu-label><a href=/docs/latest/Reference>Reference</a></p><ul class=menu-list><li style="text-transform: capitalize"><a title=ContentTypeParser href=/docs/latest/Reference/ContentTypeParser>ContentTypeParser</a></li><li style="text-transform: capitalize"><a title=Decorators href=/docs/latest/Reference/Decorators>Decorators</a></li><li style="text-transform: capitalize"><a title=Encapsulation href=/docs/latest/Reference/Encapsulation>Encapsulation</a></li><li style="text-transform: capitalize"><a title=Errors href=/docs/latest/Reference/Errors>Errors</a></li><li style="text-transform: capitalize"><a title=HTTP2 href=/docs/latest/Reference/HTTP2>HTTP2</a></li><li style="text-transform: capitalize" id=doc-menu-section><a title=Hooks class=is-active href=/docs/latest/Reference/Hooks>Hooks</a></li><li style="text-transform: capitalize"><a title=LTS href=/docs/latest/Reference/LTS>LTS</a></li><li style="text-transform: capitalize"><a title=Lifecycle href=/docs/latest/Reference/Lifecycle>Lifecycle</a></li><li style="text-transform: capitalize"><a title=Logging href=/docs/latest/Reference/Logging>Logging</a></li><li style="text-transform: capitalize"><a title=Middleware href=/docs/latest/Reference/Middleware>Middleware</a></li><li style="text-transform: capitalize"><a title=Plugins href=/docs/latest/Reference/Plugins>Plugins</a></li><li style="text-transform: capitalize"><a title=Reply href=/docs/latest/Reference/Reply>Reply</a></li><li style="text-transform: capitalize"><a title=Request href=/docs/latest/Reference/Request>Request</a></li><li style="text-transform: capitalize"><a title=Routes href=/docs/latest/Reference/Routes>Routes</a></li><li style="text-transform: capitalize"><a title=Server href=/docs/latest/Reference/Server>Server</a></li><li style="text-transform: capitalize"><a title=Type-Providers href=/docs/latest/Reference/Type-Providers>Type-Providers</a></li><li style="text-transform: capitalize"><a title=TypeScript href=/docs/latest/Reference/TypeScript>TypeScript</a></li><li style="text-transform: capitalize"><a title=Validation-and-Serialization href=/docs/latest/Reference/Validation-and-Serialization>Validation-and-Serialization</a></li></ul><div class=content style="margin: .8em; border-top: 1px solid #ccc; padding: .8em 0 0 0">Docs version<div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value"><option selected value=/docs/latest>latest</option><option value=/docs/master>master</option><option value=/docs/v4.18.x>v4.18.x</option><option value=/docs/v4.17.x>v4.17.x</option><option value=/docs/v4.16.x>v4.16.x</option><option value=/docs/v4.15.x>v4.15.x</option><option value=/docs/v4.14.x>v4.14.x</option><option value=/docs/v4.13.x>v4.13.x</option><option value=/docs/v4.12.x>v4.12.x</option><option value=/docs/v4.11.x>v4.11.x</option><option value=/docs/v4.10.x>v4.10.x</option><option value=/docs/v4.9.x>v4.9.x</option><option value=/docs/v4.8.x>v4.8.x</option><option value=/docs/v4.7.x>v4.7.x</option><option value=/docs/v4.6.x>v4.6.x</option><option value=/docs/v4.5.x>v4.5.x</option><option value=/docs/v4.4.x>v4.4.x</option><option value=/docs/v4.3.x>v4.3.x</option><option value=/docs/v4.2.x>v4.2.x</option><option value=/docs/v4.1.x>v4.1.x</option><option value=/docs/v4.0.x>v4.0.x</option><option value=/docs/v3.29.x>v3.29.x</option><option value=/docs/v3.28.x>v3.28.x</option><option value=/docs/v3.27.x>v3.27.x</option><option value=/docs/v3.26.x>v3.26.x</option><option value=/docs/v3.25.x>v3.25.x</option><option value=/docs/v3.24.x>v3.24.x</option><option value=/docs/v3.23.x>v3.23.x</option><option value=/docs/v3.22.x>v3.22.x</option><option value=/docs/v3.21.x>v3.21.x</option><option value=/docs/v3.20.x>v3.20.x</option><option value=/docs/v3.19.x>v3.19.x</option><option value=/docs/v3.18.x>v3.18.x</option><option value=/docs/v3.17.x>v3.17.x</option><option value=/docs/v3.16.x>v3.16.x</option><option value=/docs/v3.15.x>v3.15.x</option><option value=/docs/v3.14.x>v3.14.x</option><option value=/docs/v3.13.x>v3.13.x</option><option value=/docs/v3.12.x>v3.12.x</option><option value=/docs/v3.11.x>v3.11.x</option><option value=/docs/v3.10.x>v3.10.x</option><option value=/docs/v3.9.x>v3.9.x</option><option value=/docs/v3.8.x>v3.8.x</option><option value=/docs/v3.7.x>v3.7.x</option><option value=/docs/v3.6.x>v3.6.x</option><option value=/docs/v3.5.x>v3.5.x</option><option value=/docs/v3.4.x>v3.4.x</option><option value=/docs/v3.3.x>v3.3.x</option><option value=/docs/v3.2.x>v3.2.x</option><option value=/docs/v3.1.x>v3.1.x</option><option value=/docs/v3.0.x>v3.0.x</option><option value=/docs/v2.15.x>v2.15.x</option><option value=/docs/v2.14.x>v2.14.x</option><option value=/docs/v2.13.x>v2.13.x</option><option value=/docs/v2.12.x>v2.12.x</option><option value=/docs/v2.11.x>v2.11.x</option><option value=/docs/v2.10.x>v2.10.x</option><option value=/docs/v2.9.x>v2.9.x</option><option value=/docs/v2.8.x>v2.8.x</option><option value=/docs/v2.7.x>v2.7.x</option><option value=/docs/v2.6.x>v2.6.x</option><option value=/docs/v2.5.x>v2.5.x</option><option value=/docs/v2.4.x>v2.4.x</option><option value=/docs/v2.3.x>v2.3.x</option><option value=/docs/v2.2.x>v2.2.x</option><option value=/docs/v2.1.x>v2.1.x</option><option value=/docs/v2.0.x>v2.0.x</option><option value=/docs/v1.14.x>v1.14.x</option><option value=/docs/v1.13.x>v1.13.x</option></select></div></div></div></div></aside></div><div class="column is-9"><nav class=breadcrumb><ul><li><a href=/ style="padding-left: 0">Fastify</a></li><li><a href=/docs/latest>Documentation</a></li><li><div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value" style="border: none;"><option selected value=/docs/latest>latest</option><option value=/docs/master>master</option><option value=/docs/v4.18.x>v4.18.x</option><option value=/docs/v4.17.x>v4.17.x</option><option value=/docs/v4.16.x>v4.16.x</option><option value=/docs/v4.15.x>v4.15.x</option><option value=/docs/v4.14.x>v4.14.x</option><option value=/docs/v4.13.x>v4.13.x</option><option value=/docs/v4.12.x>v4.12.x</option><option value=/docs/v4.11.x>v4.11.x</option><option value=/docs/v4.10.x>v4.10.x</option><option value=/docs/v4.9.x>v4.9.x</option><option value=/docs/v4.8.x>v4.8.x</option><option value=/docs/v4.7.x>v4.7.x</option><option value=/docs/v4.6.x>v4.6.x</option><option value=/docs/v4.5.x>v4.5.x</option><option value=/docs/v4.4.x>v4.4.x</option><option value=/docs/v4.3.x>v4.3.x</option><option value=/docs/v4.2.x>v4.2.x</option><option value=/docs/v4.1.x>v4.1.x</option><option value=/docs/v4.0.x>v4.0.x</option><option value=/docs/v3.29.x>v3.29.x</option><option value=/docs/v3.28.x>v3.28.x</option><option value=/docs/v3.27.x>v3.27.x</option><option value=/docs/v3.26.x>v3.26.x</option><option value=/docs/v3.25.x>v3.25.x</option><option value=/docs/v3.24.x>v3.24.x</option><option value=/docs/v3.23.x>v3.23.x</option><option value=/docs/v3.22.x>v3.22.x</option><option value=/docs/v3.21.x>v3.21.x</option><option value=/docs/v3.20.x>v3.20.x</option><option value=/docs/v3.19.x>v3.19.x</option><option value=/docs/v3.18.x>v3.18.x</option><option value=/docs/v3.17.x>v3.17.x</option><option value=/docs/v3.16.x>v3.16.x</option><option value=/docs/v3.15.x>v3.15.x</option><option value=/docs/v3.14.x>v3.14.x</option><option value=/docs/v3.13.x>v3.13.x</option><option value=/docs/v3.12.x>v3.12.x</option><option value=/docs/v3.11.x>v3.11.x</option><option value=/docs/v3.10.x>v3.10.x</option><option value=/docs/v3.9.x>v3.9.x</option><option value=/docs/v3.8.x>v3.8.x</option><option value=/docs/v3.7.x>v3.7.x</option><option value=/docs/v3.6.x>v3.6.x</option><option value=/docs/v3.5.x>v3.5.x</option><option value=/docs/v3.4.x>v3.4.x</option><option value=/docs/v3.3.x>v3.3.x</option><option value=/docs/v3.2.x>v3.2.x</option><option value=/docs/v3.1.x>v3.1.x</option><option value=/docs/v3.0.x>v3.0.x</option><option value=/docs/v2.15.x>v2.15.x</option><option value=/docs/v2.14.x>v2.14.x</option><option value=/docs/v2.13.x>v2.13.x</option><option value=/docs/v2.12.x>v2.12.x</option><option value=/docs/v2.11.x>v2.11.x</option><option value=/docs/v2.10.x>v2.10.x</option><option value=/docs/v2.9.x>v2.9.x</option><option value=/docs/v2.8.x>v2.8.x</option><option value=/docs/v2.7.x>v2.7.x</option><option value=/docs/v2.6.x>v2.6.x</option><option value=/docs/v2.5.x>v2.5.x</option><option value=/docs/v2.4.x>v2.4.x</option><option value=/docs/v2.3.x>v2.3.x</option><option value=/docs/v2.2.x>v2.2.x</option><option value=/docs/v2.1.x>v2.1.x</option><option value=/docs/v2.0.x>v2.0.x</option><option value=/docs/v1.14.x>v1.14.x</option><option value=/docs/v1.13.x>v1.13.x</option></select></div></div></div></li><div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value" style="border: none;"><option value=/docs/latest>Documentation</option><option value=/docs/latest/Guides>Guides</option><option value=/docs/latest/Guides/Benchmarking>Benchmarking</option><option value=/docs/latest/Guides/Contributing>Contributing</option><option value=/docs/latest/Guides/Database>Database</option><option value=/docs/latest/Guides/Delay-Accepting-Requests>Delay-Accepting-Requests</option><option value=/docs/latest/Guides/Detecting-When-Clients-Abort>Detecting-When-Clients-Abort</option><option value=/docs/latest/Guides/Ecosystem>Ecosystem</option><option value=/docs/latest/Guides/Fluent-Schema>Fluent-Schema</option><option value=/docs/latest/Guides/Getting-Started>Getting-Started</option><option value=/docs/latest/Guides/Migration-Guide-V3>Migration-Guide-V3</option><option value=/docs/latest/Guides/Migration-Guide-V4>Migration-Guide-V4</option><option value=/docs/latest/Guides/Plugins-Guide>Plugins-Guide</option><option value=/docs/latest/Guides/Prototype-Poisoning>Prototype-Poisoning</option><option value=/docs/latest/Guides/Recommendations>Recommendations</option><option value=/docs/latest/Guides/Serverless>Serverless</option><option value=/docs/latest/Guides/Style-Guide>Style-Guide</option><option value=/docs/latest/Guides/Testing>Testing</option><option value=/docs/latest/Guides/Write-Plugin>Write-Plugin</option><option value=/docs/latest/Guides/Write-Type-Provider>Write-Type-Provider</option><option value=/docs/latest/Reference>Reference</option><option value=/docs/latest/Reference/ContentTypeParser>ContentTypeParser</option><option value=/docs/latest/Reference/Decorators>Decorators</option><option value=/docs/latest/Reference/Encapsulation>Encapsulation</option><option value=/docs/latest/Reference/Errors>Errors</option><option value=/docs/latest/Reference/HTTP2>HTTP2</option><option selected value=/docs/latest/Reference/Hooks>Hooks</option><option value=/docs/latest/Reference/LTS>LTS</option><option value=/docs/latest/Reference/Lifecycle>Lifecycle</option><option value=/docs/latest/Reference/Logging>Logging</option><option value=/docs/latest/Reference/Middleware>Middleware</option><option value=/docs/latest/Reference/Plugins>Plugins</option><option value=/docs/latest/Reference/Reply>Reply</option><option value=/docs/latest/Reference/Request>Request</option><option value=/docs/latest/Reference/Routes>Routes</option><option value=/docs/latest/Reference/Server>Server</option><option value=/docs/latest/Reference/Type-Providers>Type-Providers</option><option value=/docs/latest/Reference/TypeScript>TypeScript</option><option value=/docs/latest/Reference/Validation-and-Serialization>Validation-and-Serialization</option></select></div></div></div></ul></nav><div id=doc-content class=content><h2 id=hooks>Hooks</h2><p>Hooks are registered with the <code>fastify.addHook</code> method and allow you to listen to specific events in the application or request/response lifecycle. You have to register a hook before the event is triggered, otherwise, the event is lost.</p><p>By using hooks you can interact directly with the lifecycle of Fastify. There are Request/Reply hooks and application hooks:</p><ul><li><a href=#requestreply-hooks>Request/Reply Hooks</a><ul><li><a href=#onrequest>onRequest</a></li><li><a href=#preparsing>preParsing</a></li><li><a href=#prevalidation>preValidation</a></li><li><a href=#prehandler>preHandler</a></li><li><a href=#preserialization>preSerialization</a></li><li><a href=#onerror>onError</a></li><li><a href=#onsend>onSend</a></li><li><a href=#onresponse>onResponse</a></li><li><a href=#ontimeout>onTimeout</a></li><li><a href=#onrequestabort>onRequestAbort</a></li><li><a href=#manage-errors-from-a-hook>Manage Errors from a hook</a></li><li><a href=#respond-to-a-request-from-a-hook>Respond to a request from a hook</a></li></ul></li><li><a href=#application-hooks>Application Hooks</a><ul><li><a href=#onready>onReady</a></li><li><a href=#onclose>onClose</a></li><li><a href=#preclose>preClose</a></li><li><a href=#onroute>onRoute</a></li><li><a href=#onregister>onRegister</a></li></ul></li><li><a href=#scope>Scope</a></li><li><a href=#route-level-hooks>Route level hooks</a></li><li><a href=#using-hooks-to-inject-custom-properties>Using Hooks to Inject Custom Properties</a></li><li><a href=#diagnostics-channel-hooks>Diagnostics Channel Hooks</a></li></ul><p><strong>Notice:</strong> the <code>done</code> callback is not available when using <code>async</code>/<code>await</code> or returning a <code>Promise</code>. If you do invoke a <code>done</code> callback in this situation unexpected behavior may occur, e.g. duplicate invocation of handlers.</p><h2 id=requestreply-hooks>Request/Reply Hooks</h2><p><a href=.././Request>Request</a> and <a href=.././Reply>Reply</a> are the core Fastify objects.</p><p><code>done</code> is the function to continue with the <a href=.././Lifecycle>lifecycle</a>.</p><p>It is easy to understand where each hook is executed by looking at the <a href=.././Lifecycle>lifecycle page</a>.</p><p>Hooks are affected by Fastify&#39;s encapsulation, and can thus be applied to selected routes. See the <a href=#scope>Scopes</a> section for more information.</p><p>There are eight different hooks that you can use in Request/Reply <em>(in order of execution)</em>:</p><h3 id=onrequest>onRequest</h3><pre><code class=language-js>fastify.addHook(&#39;onRequest&#39;, (request, reply, done) =&gt; {
  // Some code
  done()
})
</code></pre><p>Or <code>async/await</code>:</p><pre><code class=language-js>fastify.addHook(&#39;onRequest&#39;, async (request, reply) =&gt; {
  // Some code
  await asyncMethod()
})
</code></pre><p><strong>Notice:</strong> in the <a href=#onrequest>onRequest</a> hook, <code>request.body</code> will always be <code>undefined</code>, because the body parsing happens before the <a href=#prevalidation>preValidation</a> hook.</p><h3 id=preparsing>preParsing</h3><p>If you are using the <code>preParsing</code> hook, you can transform the request payload stream before it is parsed. It receives the request and reply objects as other hooks, and a stream with the current request payload.</p><p>If it returns a value (via <code>return</code> or via the callback function), it must return a stream.</p><p>For instance, you can uncompress the request body:</p><pre><code class=language-js>fastify.addHook(&#39;preParsing&#39;, (request, reply, payload, done) =&gt; {
  // Some code
  done(null, newPayload)
})
</code></pre><p>Or <code>async/await</code>:</p><pre><code class=language-js>fastify.addHook(&#39;preParsing&#39;, async (request, reply, payload) =&gt; {
  // Some code
  await asyncMethod()
  return newPayload
})
</code></pre><p><strong>Notice:</strong> in the <a href=#preparsing>preParsing</a> hook, <code>request.body</code> will always be <code>undefined</code>, because the body parsing happens before the <a href=#prevalidation>preValidation</a> hook.</p><p><strong>Notice:</strong> you should also add a <code>receivedEncodedLength</code> property to the returned stream. This property is used to correctly match the request payload with the <code>Content-Length</code> header value. Ideally, this property should be updated on each received chunk.</p><h3 id=prevalidation>preValidation</h3><p>If you are using the <code>preValidation</code> hook, you can change the payload before it is validated. For example:</p><pre><code class=language-js>fastify.addHook(&#39;preValidation&#39;, (request, reply, done) =&gt; {
  request.body = { ...request.body, importantKey: &#39;randomString&#39; }
  done()
})
</code></pre><p>Or <code>async/await</code>:</p><pre><code class=language-js>fastify.addHook(&#39;preValidation&#39;, async (request, reply) =&gt; {
  const importantKey = await generateRandomString()
  request.body = { ...request.body, importantKey }
})
</code></pre><h3 id=prehandler>preHandler</h3><pre><code class=language-js>fastify.addHook(&#39;preHandler&#39;, (request, reply, done) =&gt; {
  // some code
  done()
})
</code></pre><p>Or <code>async/await</code>:</p><pre><code class=language-js>fastify.addHook(&#39;preHandler&#39;, async (request, reply) =&gt; {
  // Some code
  await asyncMethod()
})
</code></pre><h3 id=preserialization>preSerialization</h3><p>If you are using the <code>preSerialization</code> hook, you can change (or replace) the payload before it is serialized. For example:</p><pre><code class=language-js>fastify.addHook(&#39;preSerialization&#39;, (request, reply, payload, done) =&gt; {
  const err = null
  const newPayload = { wrapped: payload }
  done(err, newPayload)
})
</code></pre><p>Or <code>async/await</code>:</p><pre><code class=language-js>fastify.addHook(&#39;preSerialization&#39;, async (request, reply, payload) =&gt; {
  return { wrapped: payload }
})
</code></pre><p>Note: the hook is NOT called if the payload is a <code>string</code>, a <code>Buffer</code>, a <code>stream</code>, or <code>null</code>.</p><h3 id=onerror>onError</h3><pre><code class=language-js>fastify.addHook(&#39;onError&#39;, (request, reply, error, done) =&gt; {
  // Some code
  done()
})
</code></pre><p>Or <code>async/await</code>:</p><pre><code class=language-js>fastify.addHook(&#39;onError&#39;, async (request, reply, error) =&gt; {
  // Useful for custom error logging
  // You should not use this hook to update the error
})
</code></pre><p>This hook is useful if you need to do some custom error logging or add some specific header in case of error.</p><p>It is not intended for changing the error, and calling <code>reply.send</code> will throw an exception.</p><p>This hook will be executed only after the <code>customErrorHandler</code> has been executed, and only if the <code>customErrorHandler</code> sends an error back to the user <em>(Note that the default <code>customErrorHandler</code> always sends the error back to the user)</em>.</p><p><strong>Notice:</strong> unlike the other hooks, passing an error to the <code>done</code> function is not supported.</p><h3 id=onsend>onSend</h3><p>If you are using the <code>onSend</code> hook, you can change the payload. For example:</p><pre><code class=language-js>fastify.addHook(&#39;onSend&#39;, (request, reply, payload, done) =&gt; {
  const err = null;
  const newPayload = payload.replace(&#39;some-text&#39;, &#39;some-new-text&#39;)
  done(err, newPayload)
})
</code></pre><p>Or <code>async/await</code>:</p><pre><code class=language-js>fastify.addHook(&#39;onSend&#39;, async (request, reply, payload) =&gt; {
  const newPayload = payload.replace(&#39;some-text&#39;, &#39;some-new-text&#39;)
  return newPayload
})
</code></pre><p>You can also clear the payload to send a response with an empty body by replacing the payload with <code>null</code>:</p><pre><code class=language-js>fastify.addHook(&#39;onSend&#39;, (request, reply, payload, done) =&gt; {
  reply.code(304)
  const newPayload = null
  done(null, newPayload)
})
</code></pre><blockquote><p>You can also send an empty body by replacing the payload with the empty string <code>&#39;&#39;</code>, but be aware that this will cause the <code>Content-Length</code> header to be set to <code>0</code>, whereas the <code>Content-Length</code> header will not be set if the payload is <code>null</code>.</p></blockquote><p>Note: If you change the payload, you may only change it to a <code>string</code>, a <code>Buffer</code>, a <code>stream</code>, or <code>null</code>.</p><h3 id=onresponse>onResponse</h3><pre><code class=language-js>fastify.addHook(&#39;onResponse&#39;, (request, reply, done) =&gt; {
  // Some code
  done()
})
</code></pre><p>Or <code>async/await</code>:</p><pre><code class=language-js>fastify.addHook(&#39;onResponse&#39;, async (request, reply) =&gt; {
  // Some code
  await asyncMethod()
})
</code></pre><p>The <code>onResponse</code> hook is executed when a response has been sent, so you will not be able to send more data to the client. It can however be useful for sending data to external services, for example, to gather statistics.</p><p><strong>Note:</strong> setting <code>disableRequestLogging</code> to <code>true</code> will disable any error log inside the <code>onResponse</code> hook. In this case use <code>try - catch</code> to log errors.</p><h3 id=ontimeout>onTimeout</h3><pre><code class=language-js>fastify.addHook(&#39;onTimeout&#39;, (request, reply, done) =&gt; {
  // Some code
  done()
})
</code></pre><p>Or <code>async/await</code>:</p><pre><code class=language-js>fastify.addHook(&#39;onTimeout&#39;, async (request, reply) =&gt; {
  // Some code
  await asyncMethod()
})
</code></pre><p><code>onTimeout</code> is useful if you need to monitor the request timed out in your service (if the <code>connectionTimeout</code> property is set on the Fastify instance). The <code>onTimeout</code> hook is executed when a request is timed out and the HTTP socket has been hung up. Therefore, you will not be able to send data to the client.</p><h3 id=onrequestabort>onRequestAbort</h3><pre><code class=language-js>fastify.addHook(&#39;onRequestAbort&#39;, (request, done) =&gt; {
  // Some code
  done()
})
</code></pre><p>Or <code>async/await</code>:</p><pre><code class=language-js>fastify.addHook(&#39;onRequestAbort&#39;, async (request) =&gt; {
  // Some code
  await asyncMethod()
})
</code></pre><p>The <code>onRequestAbort</code> hook is executed when a client closes the connection before the entire request has been processed. Therefore, you will not be able to send data to the client.</p><p><strong>Notice:</strong> client abort detection is not completely reliable. See: <a href=../../Guides/Detecting-When-Clients-Abort><code>Detecting-When-Clients-Abort.md</code></a></p><h3 id=manage-errors-from-a-hook>Manage Errors from a hook</h3><p>If you get an error during the execution of your hook, just pass it to <code>done()</code> and Fastify will automatically close the request and send the appropriate error code to the user.</p><pre><code class=language-js>fastify.addHook(&#39;onRequest&#39;, (request, reply, done) =&gt; {
  done(new Error(&#39;Some error&#39;))
})
</code></pre><p>If you want to pass a custom error code to the user, just use <code>reply.code()</code>:</p><pre><code class=language-js>fastify.addHook(&#39;preHandler&#39;, (request, reply, done) =&gt; {
  reply.code(400)
  done(new Error(&#39;Some error&#39;))
})
</code></pre><p><em>The error will be handled by <a href=.././Reply#errors><code>Reply</code></a>.</em></p><p>Or if you&#39;re using <code>async/await</code> you can just throw an error:</p><pre><code class=language-js>fastify.addHook(&#39;onRequest&#39;, async (request, reply) =&gt; {
  throw new Error(&#39;Some error&#39;)
})
</code></pre><h3 id=respond-to-a-request-from-a-hook>Respond to a request from a hook</h3><p>If needed, you can respond to a request before you reach the route handler, for example when implementing an authentication hook. Replying from a hook implies that the hook chain is <strong>stopped</strong> and the rest of the hooks and handlers are not executed. If the hook is using the callback approach, i.e. it is not an <code>async</code> function or it returns a <code>Promise</code>, it is as simple as calling <code>reply.send()</code> and avoiding calling the callback. If the hook is <code>async</code>, <code>reply.send()</code> <strong>must</strong> be called <em>before</em> the function returns or the promise resolves, otherwise, the request will proceed. When <code>reply.send()</code> is called outside of the promise chain, it is important to <code>return reply</code> otherwise the request will be executed twice.</p><p>It is important to <strong>not mix callbacks and <code>async</code>/<code>Promise</code></strong>, otherwise the hook chain will be executed twice.</p><p>If you are using <code>onRequest</code> or <code>preHandler</code> use <code>reply.send</code>.</p><pre><code class=language-js>fastify.addHook(&#39;onRequest&#39;, (request, reply, done) =&gt; {
  reply.send(&#39;Early response&#39;)
})

// Works with async functions too
fastify.addHook(&#39;preHandler&#39;, async (request, reply) =&gt; {
  await something()
  reply.send({ hello: &#39;world&#39; })
  return reply // mandatory, so the request is not executed further
})
</code></pre><p>If you want to respond with a stream, you should avoid using an <code>async</code> function for the hook. If you must use an <code>async</code> function, your code will need to follow the pattern in <a href=https://github.com/fastify/fastify/blob/94ea67ef2d8dce8a955d510cd9081aabd036fa85/test/hooks-async.js#L269-L275>test/hooks-async.js</a>.</p><pre><code class=language-js>fastify.addHook(&#39;onRequest&#39;, (request, reply, done) =&gt; {
  const stream = fs.createReadStream(&#39;some-file&#39;, &#39;utf8&#39;)
  reply.send(stream)
})
</code></pre><p>If you are sending a response without <code>await</code> on it, make sure to always <code>return reply</code>:</p><pre><code class=language-js>fastify.addHook(&#39;preHandler&#39;, async (request, reply) =&gt; {
  setImmediate(() =&gt; { reply.send(&#39;hello&#39;) })

  // This is needed to signal the handler to wait for a response
  // to be sent outside of the promise chain
  return reply
})

fastify.addHook(&#39;preHandler&#39;, async (request, reply) =&gt; {
  // the @fastify/static plugin will send a file asynchronously,
  // so we should return reply
  reply.sendFile(&#39;myfile&#39;)
  return reply
})
</code></pre><h2 id=application-hooks>Application Hooks</h2><p>You can hook into the application-lifecycle as well.</p><ul><li><a href=#onready>onReady</a></li><li><a href=#onclose>onClose</a></li><li><a href=#preclose>preClose</a></li><li><a href=#onroute>onRoute</a></li><li><a href=#onregister>onRegister</a></li></ul><h3 id=onready>onReady</h3><p>Triggered before the server starts listening for requests and when <code>.ready()</code> is invoked. It cannot change the routes or add new hooks. Registered hook functions are executed serially. Only after all <code>onReady</code> hook functions have completed will the server start listening for requests. Hook functions accept one argument: a callback, <code>done</code>, to be invoked after the hook function is complete. Hook functions are invoked with <code>this</code> bound to the associated Fastify instance.</p><pre><code class=language-js>// callback style
fastify.addHook(&#39;onReady&#39;, function (done) {
  // Some code
  const err = null;
  done(err)
})

// or async/await style
fastify.addHook(&#39;onReady&#39;, async function () {
  // Some async code
  await loadCacheFromDatabase()
})
</code></pre><h3 id=onclose>onClose</h3><p><a id=on-close></a></p><p>Triggered when <code>fastify.close()</code> is invoked to stop the server, after all in-flight HTTP requests have been completed. It is useful when <a href=.././Plugins>plugins</a> need a &quot;shutdown&quot; event, for example, to close an open connection to a database.</p><p>The hook function takes the Fastify instance as a first argument, and a <code>done</code> callback for synchronous hook functions.</p><pre><code class=language-js>// callback style
fastify.addHook(&#39;onClose&#39;, (instance, done) =&gt; {
  // Some code
  done()
})

// or async/await style
fastify.addHook(&#39;onClose&#39;, async (instance) =&gt; {
  // Some async code
  await closeDatabaseConnections()
})
</code></pre><h3 id=preclose>preClose</h3><p><a id=pre-close></a></p><p>Triggered when <code>fastify.close()</code> is invoked to stop the server, before all in-flight HTTP requests have been completed. It is useful when <a href=.././Plugins>plugins</a> have set up some state attached to the HTTP server that would prevent the server to close. <em>It is unlikely you will need to use this hook</em>, use the <a href=#onclose><code>onClose</code></a> for the most common case.</p><pre><code class=language-js>// callback style
fastify.addHook(&#39;preClose&#39;, (done) =&gt; {
  // Some code
  done()
})

// or async/await style
fastify.addHook(&#39;preClose&#39;, async () =&gt; {
  // Some async code
  await removeSomeServerState()
})
</code></pre><h3 id=onroute>onRoute</h3><p><a id=on-route></a></p><p>Triggered when a new route is registered. Listeners are passed a <a href=.././Routes#routes-options><code>routeOptions</code></a> object as the sole parameter. The interface is synchronous, and, as such, the listeners are not passed a callback. This hook is encapsulated.</p><pre><code class=language-js>fastify.addHook(&#39;onRoute&#39;, (routeOptions) =&gt; {
  //Some code
  routeOptions.method
  routeOptions.schema
  routeOptions.url // the complete URL of the route, it will include the prefix if any
  routeOptions.path // `url` alias
  routeOptions.routePath // the URL of the route without the prefix
  routeOptions.bodyLimit
  routeOptions.logLevel
  routeOptions.logSerializers
  routeOptions.prefix
})
</code></pre><p>If you are authoring a plugin and you need to customize application routes, like modifying the options or adding new route hooks, this is the right place.</p><pre><code class=language-js>fastify.addHook(&#39;onRoute&#39;, (routeOptions) =&gt; {
  function onPreSerialization(request, reply, payload, done) {
    // Your code
    done(null, payload)
  }
  // preSerialization can be an array or undefined
  routeOptions.preSerialization = [...(routeOptions.preSerialization || []), onPreSerialization]
})
</code></pre><p>To add more routes within an onRoute hook, the routes must be tagged correctly. The hook will run into an infinite loop if not tagged. The recommended approach is shown below.</p><pre><code class=language-js>const kRouteAlreadyProcessed = Symbol(&#39;route-already-processed&#39;)

fastify.addHook(&#39;onRoute&#39;, function (routeOptions) {
  const { url, method } = routeOptions

  const isAlreadyProcessed = (routeOptions.custom &amp;&amp; routeOptions.custom[kRouteAlreadyProcessed]) || false

  if (!isAlreadyProcessed) {
    this.route({
      url,
      method,
      custom: {
        [kRouteAlreadyProcessed]: true
      },
      handler: () =&gt; {}
    })
  }
})
</code></pre><p>For more details, see this <a href=https://github.com/fastify/fastify/issues/4319>issue</a>.</p><h3 id=onregister>onRegister</h3><p><a id=on-register></a></p><p>Triggered when a new plugin is registered and a new encapsulation context is created. The hook will be executed <strong>before</strong> the registered code.</p><p>This hook can be useful if you are developing a plugin that needs to know when a plugin context is formed, and you want to operate in that specific context, thus this hook is encapsulated.</p><p><strong>Note:</strong> This hook will not be called if a plugin is wrapped inside <a href=https://github.com/fastify/fastify-plugin><code>fastify-plugin</code></a>.</p><pre><code class=language-js>fastify.decorate(&#39;data&#39;, [])

fastify.register(async (instance, opts) =&gt; {
  instance.data.push(&#39;hello&#39;)
  console.log(instance.data) // [&#39;hello&#39;]

  instance.register(async (instance, opts) =&gt; {
    instance.data.push(&#39;world&#39;)
    console.log(instance.data) // [&#39;hello&#39;, &#39;world&#39;]
  }, { prefix: &#39;/hola&#39; })
}, { prefix: &#39;/ciao&#39; })

fastify.register(async (instance, opts) =&gt; {
  console.log(instance.data) // []
}, { prefix: &#39;/hello&#39; })

fastify.addHook(&#39;onRegister&#39;, (instance, opts) =&gt; {
  // Create a new array from the old one
  // but without keeping the reference
  // allowing the user to have encapsulated
  // instances of the `data` property
  instance.data = instance.data.slice()

  // the options of the new registered instance
  console.log(opts.prefix)
})
</code></pre><h2 id=scope>Scope</h2><p><a id=scope></a></p><p>Except for <a href=#onclose>onClose</a>, all hooks are encapsulated. This means that you can decide where your hooks should run by using <code>register</code> as explained in the <a href=../../Guides/Plugins-Guide>plugins guide</a>. If you pass a function, that function is bound to the right Fastify context and from there you have full access to the Fastify API.</p><pre><code class=language-js>fastify.addHook(&#39;onRequest&#39;, function (request, reply, done) {
  const self = this // Fastify context
  done()
})
</code></pre><p>Note that the Fastify context in each hook is the same as the plugin where the route was registered, for example:</p><pre><code class=language-js>fastify.addHook(&#39;onRequest&#39;, async function (req, reply) {
  if (req.raw.url === &#39;/nested&#39;) {
    assert.strictEqual(this.foo, &#39;bar&#39;)
  } else {
    assert.strictEqual(this.foo, undefined)
  }
})

fastify.get(&#39;/&#39;, async function (req, reply) {
  assert.strictEqual(this.foo, undefined)
  return { hello: &#39;world&#39; }
})

fastify.register(async function plugin (fastify, opts) {
  fastify.decorate(&#39;foo&#39;, &#39;bar&#39;)

  fastify.get(&#39;/nested&#39;, async function (req, reply) {
    assert.strictEqual(this.foo, &#39;bar&#39;)
    return { hello: &#39;world&#39; }
  })
})
</code></pre><p>Warn: if you declare the function with an <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions>arrow function</a>, the <code>this</code> will not be Fastify, but the one of the current scope.</p><h2 id=route-level-hooks>Route level hooks</h2><p><a id=route-hooks></a></p><p>You can declare one or more custom lifecycle hooks (<a href=#onrequest>onRequest</a>, <a href=#onresponse>onResponse</a>, <a href=#preparsing>preParsing</a>, <a href=#prevalidation>preValidation</a>, <a href=#prehandler>preHandler</a>, <a href=#preserialization>preSerialization</a>, <a href=#onsend>onSend</a>, <a href=#ontimeout>onTimeout</a>, and <a href=#onerror>onError</a>) hook(s) that will be <strong>unique</strong> for the route. If you do so, those hooks are always executed as the last hook in their category.</p><p>This can be useful if you need to implement authentication, where the <a href=#preparsing>preParsing</a> or <a href=#prevalidation>preValidation</a> hooks are exactly what you need. Multiple route-level hooks can also be specified as an array.</p><pre><code class=language-js>fastify.addHook(&#39;onRequest&#39;, (request, reply, done) =&gt; {
  // Your code
  done()
})

fastify.addHook(&#39;onResponse&#39;, (request, reply, done) =&gt; {
  // your code
  done()
})

fastify.addHook(&#39;preParsing&#39;, (request, reply, done) =&gt; {
  // Your code
  done()
})

fastify.addHook(&#39;preValidation&#39;, (request, reply, done) =&gt; {
  // Your code
  done()
})

fastify.addHook(&#39;preHandler&#39;, (request, reply, done) =&gt; {
  // Your code
  done()
})

fastify.addHook(&#39;preSerialization&#39;, (request, reply, payload, done) =&gt; {
  // Your code
  done(null, payload)
})

fastify.addHook(&#39;onSend&#39;, (request, reply, payload, done) =&gt; {
  // Your code
  done(null, payload)
})

fastify.addHook(&#39;onTimeout&#39;, (request, reply, done) =&gt; {
  // Your code
  done()
})

fastify.addHook(&#39;onError&#39;, (request, reply, error, done) =&gt; {
  // Your code
  done()
})

fastify.route({
  method: &#39;GET&#39;,
  url: &#39;/&#39;,
  schema: { ... },
  onRequest: function (request, reply, done) {
    // This hook will always be executed after the shared `onRequest` hooks
    done()
  },
  // // Example with an async hook. All hooks support this syntax
  //
  // onRequest: async function (request, reply) {
  //  // This hook will always be executed after the shared `onRequest` hooks
  //  await ...
  // }
  onResponse: function (request, reply, done) {
    // this hook will always be executed after the shared `onResponse` hooks
    done()
  },
  preParsing: function (request, reply, done) {
    // This hook will always be executed after the shared `preParsing` hooks
    done()
  },
  preValidation: function (request, reply, done) {
    // This hook will always be executed after the shared `preValidation` hooks
    done()
  },
  preHandler: function (request, reply, done) {
    // This hook will always be executed after the shared `preHandler` hooks
    done()
  },
  // // Example with an array. All hooks support this syntax.
  //
  // preHandler: [function (request, reply, done) {
  //   // This hook will always be executed after the shared `preHandler` hooks
  //   done()
  // }],
  preSerialization: (request, reply, payload, done) =&gt; {
    // This hook will always be executed after the shared `preSerialization` hooks
    done(null, payload)
  },
  onSend: (request, reply, payload, done) =&gt; {
    // This hook will always be executed after the shared `onSend` hooks
    done(null, payload)
  },
  onTimeout: (request, reply, done) =&gt; {
    // This hook will always be executed after the shared `onTimeout` hooks
    done()
  },
  onError: (request, reply, error, done) =&gt; {
    // This hook will always be executed after the shared `onError` hooks
    done()
  },
  handler: function (request, reply) {
    reply.send({ hello: &#39;world&#39; })
  }
})
</code></pre><p><strong>Note</strong>: both options also accept an array of functions.</p><h2 id=using-hooks-to-inject-custom-properties>Using Hooks to Inject Custom Properties</h2><p><a id=using-hooks-to-inject-custom-properties></a></p><p>You can use a hook to inject custom properties into incoming requests. This is useful for reusing processed data from hooks in controllers.</p><p>A very common use case is, for example, checking user authentication based on their token and then storing their recovered data into the <a href=.././Request>Request</a> instance. This way, your controllers can read it easily with <code>request.authenticatedUser</code> or whatever you want to call it. That&#39;s how it might look like:</p><pre><code class=language-js>fastify.addHook(&#39;preParsing&#39;, async (request) =&gt; {
  request.authenticatedUser = {
    id: 42,
    name: &#39;Jane Doe&#39;,
    role: &#39;admin&#39;
  }
})

fastify.get(&#39;/me/is-admin&#39;, async function (req, reply) {
  return { isAdmin: req.authenticatedUser?.role === &#39;admin&#39; || false }
})
</code></pre><p>Note that <code>.authenticatedUser</code> could actually be any property name chosen by yourself. Using your own custom property prevents you from mutating existing properties, which would be a dangerous and destructive operation. So be careful and make sure your property is entirely new, also using this approach only for very specific and small cases like this example.</p><p>Regarding TypeScript in this example, you&#39;d need to update the <code>FastifyRequest</code> core interface to include your new property typing (for more about it, see <a href=.././TypeScript>TypeScript</a> page), like:</p><pre><code class=language-ts>interface AuthenticatedUser { /* ... */ }

declare module &#39;fastify&#39; {
  export interface FastifyRequest {
    authenticatedUser?: AuthenticatedUser;
  }
}
</code></pre><p>Although this is a very pragmatic approach, if you&#39;re trying to do something more complex that changes these core objects, then consider creating a custom <a href=.././Plugins>Plugin</a> instead.</p><h2 id=diagnostics-channel-hooks>Diagnostics Channel Hooks</h2><blockquote><p><strong>Note:</strong> The <code>diagnostics_channel</code> is currently experimental on Node.js, so its API is subject to change even in semver-patch releases of Node.js. For versions of Node.js supported by Fastify where <code>diagnostics_channel</code> is unavailable, the hook will use the <a href=https://www.npmjs.com/package/diagnostics_channel>polyfill</a> if it is available. Otherwise, this feature will not be present.</p></blockquote><p>Currently, one <a href=https://nodejs.org/api/diagnostics_channel.html><code>diagnostics_channel</code></a> publish event, <code>&#39;fastify.initialization&#39;</code>, happens at initialization time. The Fastify instance is passed into the hook as a property of the object passed in. At this point, the instance can be interacted with to add hooks, plugins, routes, or any other sort of modification.</p><p>For example, a tracing package might do something like the following (which is, of course, a simplification). This would be in a file loaded in the initialization of the tracking package, in the typical &quot;require instrumentation tools first&quot; fashion.</p><pre><code class=language-js>const tracer = /* retrieved from elsewhere in the package */
const dc = require(&#39;diagnostics_channel&#39;)
const channel = dc.channel(&#39;fastify.initialization&#39;)
const spans = new WeakMap()

channel.subscribe(function ({ fastify }) {
  fastify.addHook(&#39;onRequest&#39;, (request, reply, done) =&gt; {
    const span = tracer.startSpan(&#39;fastify.request&#39;)
    spans.set(request, span)
    done()
  })

  fastify.addHook(&#39;onResponse&#39;, (request, reply, done) =&gt; {
    const span = spans.get(request)
    span.finish()
    done()
  })
})
</code></pre></div><hr><nav class=level></nav></div></div></div></section><script>// dynamically creates a submenu for the current section based on the content headers
  var titles = document.querySelectorAll('#doc-content h3, #doc-content h4')
  var currentMenu = document.getElementById('doc-menu-section')
  if (titles.length && currentMenu) {
    var submenu = document.createElement('ul')
    titles.forEach(el => {
      var currentSubmenuItem = document.createElement('li')
      var currentSubmenuLink = document.createElement('a')
      currentSubmenuLink.href = '#' + el.id
      currentSubmenuLink.title = el.textContent
      currentSubmenuLink.append(document.createTextNode(el.textContent))
      currentSubmenuItem.append(currentSubmenuLink)
      submenu.append(currentSubmenuItem)
    })
    currentMenu.append(submenu)
  }

  // dynamically creates header anchor links
  var headers = document.querySelectorAll('#doc-content h3, #doc-content h4')
  headers.forEach(el => {
    var currentAnchorLink = document.createElement('a')
    currentAnchorLink.className = 'anchor'
    currentAnchorLink.href = "#" + el.id
    currentAnchorLink.append(document.createTextNode('Â¶'))
    el.insertBefore(currentAnchorLink, el.firstChild);
  })</script><script>const contentLoaded = document.addEventListener('DOMContentLoaded', setTOCHeight)
  const resize = window.addEventListener('resize', setTOCHeight)

  function setTOCHeight() {
    const docHeight = window.innerHeight
    const tocSidebar = document.querySelector('#toc') || 0

    const tocHeight = docHeight - tocSidebar.getBoundingClientRect().top

    document.documentElement.style
      .setProperty('--TOC-height', `${tocHeight}px`)
  }

  window.addEventListener('beforeunload', () => {
    document.removeEventListener(contentLoaded)
    window.removeEventListener(resize)
  })</script></main><footer class="grey is-primary footer"><div class=container><div class="content has-text-centered"><p>Fastify, Copyright &copy; 2016-2023 <a href=https://openjsf.org/ target=_blank rel=noopener>OpenJS Foundation</a> and <a href=https://github.com/fastify/fastify#team target=_blank rel=noopener>The Fastify team</a>, Licensed under <a href=https://github.com/fastify/fastify/blob/master/LICENSE target=_blank rel=noopener>MIT</a></p><a href=https://www.netlify.com><img src=https://www.netlify.com/img/global/badges/netlify-color-accent.svg alt="Deploys by Netlify" loading=lazy decoding=async></a><p><small>Icons by simpleicons.org</small></p></div></div></footer><script src=/js/main.1e1d476db6c0b326.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js integrity="sha512-s+tOYYcC3Jybgr9mVsdAxsRYlGNq4mlAurOrfNuGMQ/SCofNPu92tjE7YRZCsdEtWL1yGkqk15fU/ark206YTg==" crossorigin=anonymous></script><script>hljs.highlightAll();</script><script src=https://cdn.jsdelivr.net/npm/@docsearch/js@alpha></script><script type=text/javascript>docsearch({
        appId: 'DMPMC33PLU',
        apiKey: '12d46b3bfeee6511031cfe00778f3e45',
        indexName: 'fastify',
        container: '#algolia-search-input',
        algoliaOptions: { 'facetFilters': ["version:latest", "tags:docs"] }
      });</script></body></html>