<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Prototype-Poisoning</title><meta name=description content="Fast and low overhead web framework, for Node.js"><link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.ed24c0a19503e080.png><link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.60c285c424d50738.png><link rel=apple-touch-icon sizes=72x72 href=/images/apple-icon-72x72.e49b27cfe1ab1461.png><link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.752f43fc91b8c1f7.png><link rel=apple-touch-icon sizes=114x114 href=/images/apple-icon-114x114.61739fa1d5a7059a.png><link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.7c25de37c5ce2ec1.png><link rel=apple-touch-icon sizes=144x144 href=/images/apple-icon-144x144.04d88fb27bd92cbe.png><link rel=apple-touch-icon sizes=152x152 href=/images/apple-icon-152x152.9364781175671626.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-icon-180x180.67579100928bfcd2.png><link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.37eb7f1ae3853740.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.1e22f0e774bc3cce.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.7e8a68b1b80c1799.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.e534ce05cb727f1a.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content=#ffffff><meta name=msapplication-TileImage content=/images/ms-icon-144x144.png><meta name=theme-color content=#ffffff><meta property=og:url content=https://www.fastify.io/docs/v4.2.x/Guides/Prototype-Poisoning><meta property=og:type content=website><meta property=og:title content=Prototype-Poisoning><meta property=og:description content="Fast and low overhead web framework, for Node.js"><meta property=og:image content=https://www.fastify.io/images/fastify-fb-share-image.07b6e6860853c758.png><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@fastifyjs><meta name=twitter:creator content=@fastifyjs><meta name=twitter:title content=Prototype-Poisoning><meta name=twitter:description content="Fast and low overhead web framework, for Node.js"><meta name=twitter:image content=https://www.fastify.io/images/fastify-twitter-share-image.cd9f217b360af3e2.png><link rel=stylesheet href=/css/style.f4d6592b3a91c5ef.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css integrity="sha512-kZqGbhf9JTB4bVJ0G8HCkqmaPcRgo88F0dneK30yku5Y/dep7CZfCnNml2Je/sY4lBoqoksXz4PtVXS4GHSUzQ==" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@alpha><meta name=robots content="noindex, nofollow"></head><body><nav id=main-navbar class=navbar><div class=navbar-brand><a class=navbar-item href=/ ><img src=/images/fastify-logo-menu.d13f8da7a965c800.png alt="Fastify: Fast and low overhead web framework, for Node.js" height=28 decoding=async> </a><a class="navbar-item is-hidden-desktop" href=https://github.com/fastify/fastify target=_blank rel=noopener><span class=icon style="color: #333;"><i class="fa fa-github"></i></span></a><div class="navbar-burger burger" data-target=mobileMenu><span></span> <span></span> <span></span></div></div><div class=navbar-menu id=mobileMenu><div class=navbar-start><a class=navbar-item href=/ >Home</a> <a class=navbar-item href=/docs/latest>Docs</a> <a class=navbar-item href=/ecosystem>Ecosystem</a> <a class=navbar-item href=/benchmarks>Benchmarks</a> <a class=navbar-item href=/contribute>Contribute</a> <a class=navbar-item href=https://medium.com/@fastifyjs/ >Blog</a> <a class=navbar-item href=https://github.com/fastify/help>Help</a></div><div class=navbar-end><span id=algolia-search-input class="control has-icons-left navbar-item"></span> <a class=navbar-item href=https://github.com/fastify/fastify target=_blank rel=noopener><span class="fa fa-github"></span>&nbsp;GitHub </a><a class=navbar-item href=https://twitter.com/fastifyjs target=_blank rel=noopener><span class="fa fa-twitter"></span>&nbsp;Twitter </a><a class=navbar-item rel=me href=https://fosstodon.org/@fastify target=_blank><span class="fa fa-hashtag"></span>&nbsp;Mastodon</a></div></div></nav><main class=page-content aria-label=Content><section class="hero is-primary" style="background-image: url(/images/bg-pattern-dark.3f8cda863b3bbf52.png)"><div class=hero-body><div class=container><h1 class=title>Documentation (v4.2.1)</h1></div></div></section><section class=section><div class=container><div class=columns><div class="column is-3 is-hidden-mobile sticky-container"><aside class="menu sticky" id=toc><ul class=menu-list></ul><p class=menu-label><a href=/docs/v4.2.x/Guides>Guides</a></p><ul class=menu-list><li style="text-transform: capitalize"><a title=Benchmarking href=/docs/v4.2.x/Guides/Benchmarking>Benchmarking</a></li><li style="text-transform: capitalize"><a title=Contributing href=/docs/v4.2.x/Guides/Contributing>Contributing</a></li><li style="text-transform: capitalize"><a title=Database href=/docs/v4.2.x/Guides/Database>Database</a></li><li style="text-transform: capitalize"><a title=Delay-Accepting-Requests href=/docs/v4.2.x/Guides/Delay-Accepting-Requests>Delay-Accepting-Requests</a></li><li style="text-transform: capitalize"><a title=Ecosystem href=/docs/v4.2.x/Guides/Ecosystem>Ecosystem</a></li><li style="text-transform: capitalize"><a title=Fluent-Schema href=/docs/v4.2.x/Guides/Fluent-Schema>Fluent-Schema</a></li><li style="text-transform: capitalize"><a title=Getting-Started href=/docs/v4.2.x/Guides/Getting-Started>Getting-Started</a></li><li style="text-transform: capitalize"><a title=Migration-Guide-V3 href=/docs/v4.2.x/Guides/Migration-Guide-V3>Migration-Guide-V3</a></li><li style="text-transform: capitalize"><a title=Migration-Guide-V4 href=/docs/v4.2.x/Guides/Migration-Guide-V4>Migration-Guide-V4</a></li><li style="text-transform: capitalize"><a title=Plugins-Guide href=/docs/v4.2.x/Guides/Plugins-Guide>Plugins-Guide</a></li><li style="text-transform: capitalize" id=doc-menu-section><a title=Prototype-Poisoning class=is-active href=/docs/v4.2.x/Guides/Prototype-Poisoning>Prototype-Poisoning</a></li><li style="text-transform: capitalize"><a title=Recommendations href=/docs/v4.2.x/Guides/Recommendations>Recommendations</a></li><li style="text-transform: capitalize"><a title=Serverless href=/docs/v4.2.x/Guides/Serverless>Serverless</a></li><li style="text-transform: capitalize"><a title=Style-Guide href=/docs/v4.2.x/Guides/Style-Guide>Style-Guide</a></li><li style="text-transform: capitalize"><a title=Testing href=/docs/v4.2.x/Guides/Testing>Testing</a></li><li style="text-transform: capitalize"><a title=Write-Plugin href=/docs/v4.2.x/Guides/Write-Plugin>Write-Plugin</a></li></ul><p class=menu-label><a href=/docs/v4.2.x/Reference>Reference</a></p><ul class=menu-list><li style="text-transform: capitalize"><a title=ContentTypeParser href=/docs/v4.2.x/Reference/ContentTypeParser>ContentTypeParser</a></li><li style="text-transform: capitalize"><a title=Decorators href=/docs/v4.2.x/Reference/Decorators>Decorators</a></li><li style="text-transform: capitalize"><a title=Encapsulation href=/docs/v4.2.x/Reference/Encapsulation>Encapsulation</a></li><li style="text-transform: capitalize"><a title=Errors href=/docs/v4.2.x/Reference/Errors>Errors</a></li><li style="text-transform: capitalize"><a title=HTTP2 href=/docs/v4.2.x/Reference/HTTP2>HTTP2</a></li><li style="text-transform: capitalize"><a title=Hooks href=/docs/v4.2.x/Reference/Hooks>Hooks</a></li><li style="text-transform: capitalize"><a title=LTS href=/docs/v4.2.x/Reference/LTS>LTS</a></li><li style="text-transform: capitalize"><a title=Lifecycle href=/docs/v4.2.x/Reference/Lifecycle>Lifecycle</a></li><li style="text-transform: capitalize"><a title=Logging href=/docs/v4.2.x/Reference/Logging>Logging</a></li><li style="text-transform: capitalize"><a title=Middleware href=/docs/v4.2.x/Reference/Middleware>Middleware</a></li><li style="text-transform: capitalize"><a title=Plugins href=/docs/v4.2.x/Reference/Plugins>Plugins</a></li><li style="text-transform: capitalize"><a title=Reply href=/docs/v4.2.x/Reference/Reply>Reply</a></li><li style="text-transform: capitalize"><a title=Request href=/docs/v4.2.x/Reference/Request>Request</a></li><li style="text-transform: capitalize"><a title=Routes href=/docs/v4.2.x/Reference/Routes>Routes</a></li><li style="text-transform: capitalize"><a title=Server href=/docs/v4.2.x/Reference/Server>Server</a></li><li style="text-transform: capitalize"><a title=Type-Providers href=/docs/v4.2.x/Reference/Type-Providers>Type-Providers</a></li><li style="text-transform: capitalize"><a title=TypeScript href=/docs/v4.2.x/Reference/TypeScript>TypeScript</a></li><li style="text-transform: capitalize"><a title=Validation-and-Serialization href=/docs/v4.2.x/Reference/Validation-and-Serialization>Validation-and-Serialization</a></li></ul><div class=content style="margin: .8em; border-top: 1px solid #ccc; padding: .8em 0 0 0">Docs version<div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value"><option value=/docs/latest>latest</option><option value=/docs/master>master</option><option value=/docs/v4.15.x>v4.15.x</option><option value=/docs/v4.14.x>v4.14.x</option><option value=/docs/v4.13.x>v4.13.x</option><option value=/docs/v4.12.x>v4.12.x</option><option value=/docs/v4.11.x>v4.11.x</option><option value=/docs/v4.10.x>v4.10.x</option><option value=/docs/v4.9.x>v4.9.x</option><option value=/docs/v4.8.x>v4.8.x</option><option value=/docs/v4.7.x>v4.7.x</option><option value=/docs/v4.6.x>v4.6.x</option><option value=/docs/v4.5.x>v4.5.x</option><option value=/docs/v4.4.x>v4.4.x</option><option value=/docs/v4.3.x>v4.3.x</option><option selected value=/docs/v4.2.x>v4.2.x</option><option value=/docs/v4.1.x>v4.1.x</option><option value=/docs/v4.0.x>v4.0.x</option><option value=/docs/v3.29.x>v3.29.x</option><option value=/docs/v3.28.x>v3.28.x</option><option value=/docs/v3.27.x>v3.27.x</option><option value=/docs/v3.26.x>v3.26.x</option><option value=/docs/v3.25.x>v3.25.x</option><option value=/docs/v3.24.x>v3.24.x</option><option value=/docs/v3.23.x>v3.23.x</option><option value=/docs/v3.22.x>v3.22.x</option><option value=/docs/v3.21.x>v3.21.x</option><option value=/docs/v3.20.x>v3.20.x</option><option value=/docs/v3.19.x>v3.19.x</option><option value=/docs/v3.18.x>v3.18.x</option><option value=/docs/v3.17.x>v3.17.x</option><option value=/docs/v3.16.x>v3.16.x</option><option value=/docs/v3.15.x>v3.15.x</option><option value=/docs/v3.14.x>v3.14.x</option><option value=/docs/v3.13.x>v3.13.x</option><option value=/docs/v3.12.x>v3.12.x</option><option value=/docs/v3.11.x>v3.11.x</option><option value=/docs/v3.10.x>v3.10.x</option><option value=/docs/v3.9.x>v3.9.x</option><option value=/docs/v3.8.x>v3.8.x</option><option value=/docs/v3.7.x>v3.7.x</option><option value=/docs/v3.6.x>v3.6.x</option><option value=/docs/v3.5.x>v3.5.x</option><option value=/docs/v3.4.x>v3.4.x</option><option value=/docs/v3.3.x>v3.3.x</option><option value=/docs/v3.2.x>v3.2.x</option><option value=/docs/v3.1.x>v3.1.x</option><option value=/docs/v3.0.x>v3.0.x</option><option value=/docs/v2.15.x>v2.15.x</option><option value=/docs/v2.14.x>v2.14.x</option><option value=/docs/v2.13.x>v2.13.x</option><option value=/docs/v2.12.x>v2.12.x</option><option value=/docs/v2.11.x>v2.11.x</option><option value=/docs/v2.10.x>v2.10.x</option><option value=/docs/v2.9.x>v2.9.x</option><option value=/docs/v2.8.x>v2.8.x</option><option value=/docs/v2.7.x>v2.7.x</option><option value=/docs/v2.6.x>v2.6.x</option><option value=/docs/v2.5.x>v2.5.x</option><option value=/docs/v2.4.x>v2.4.x</option><option value=/docs/v2.3.x>v2.3.x</option><option value=/docs/v2.2.x>v2.2.x</option><option value=/docs/v2.1.x>v2.1.x</option><option value=/docs/v2.0.x>v2.0.x</option><option value=/docs/v1.14.x>v1.14.x</option><option value=/docs/v1.13.x>v1.13.x</option></select></div></div></div></div></aside></div><div class="column is-9"><nav class=breadcrumb><ul><li><a href=/ style="padding-left: 0">Fastify</a></li><li><a href=/docs/v4.2.x>Documentation</a></li><li><div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value" style="border: none;"><option value=/docs/latest>latest</option><option value=/docs/master>master</option><option value=/docs/v4.15.x>v4.15.x</option><option value=/docs/v4.14.x>v4.14.x</option><option value=/docs/v4.13.x>v4.13.x</option><option value=/docs/v4.12.x>v4.12.x</option><option value=/docs/v4.11.x>v4.11.x</option><option value=/docs/v4.10.x>v4.10.x</option><option value=/docs/v4.9.x>v4.9.x</option><option value=/docs/v4.8.x>v4.8.x</option><option value=/docs/v4.7.x>v4.7.x</option><option value=/docs/v4.6.x>v4.6.x</option><option value=/docs/v4.5.x>v4.5.x</option><option value=/docs/v4.4.x>v4.4.x</option><option value=/docs/v4.3.x>v4.3.x</option><option selected value=/docs/v4.2.x>v4.2.x</option><option value=/docs/v4.1.x>v4.1.x</option><option value=/docs/v4.0.x>v4.0.x</option><option value=/docs/v3.29.x>v3.29.x</option><option value=/docs/v3.28.x>v3.28.x</option><option value=/docs/v3.27.x>v3.27.x</option><option value=/docs/v3.26.x>v3.26.x</option><option value=/docs/v3.25.x>v3.25.x</option><option value=/docs/v3.24.x>v3.24.x</option><option value=/docs/v3.23.x>v3.23.x</option><option value=/docs/v3.22.x>v3.22.x</option><option value=/docs/v3.21.x>v3.21.x</option><option value=/docs/v3.20.x>v3.20.x</option><option value=/docs/v3.19.x>v3.19.x</option><option value=/docs/v3.18.x>v3.18.x</option><option value=/docs/v3.17.x>v3.17.x</option><option value=/docs/v3.16.x>v3.16.x</option><option value=/docs/v3.15.x>v3.15.x</option><option value=/docs/v3.14.x>v3.14.x</option><option value=/docs/v3.13.x>v3.13.x</option><option value=/docs/v3.12.x>v3.12.x</option><option value=/docs/v3.11.x>v3.11.x</option><option value=/docs/v3.10.x>v3.10.x</option><option value=/docs/v3.9.x>v3.9.x</option><option value=/docs/v3.8.x>v3.8.x</option><option value=/docs/v3.7.x>v3.7.x</option><option value=/docs/v3.6.x>v3.6.x</option><option value=/docs/v3.5.x>v3.5.x</option><option value=/docs/v3.4.x>v3.4.x</option><option value=/docs/v3.3.x>v3.3.x</option><option value=/docs/v3.2.x>v3.2.x</option><option value=/docs/v3.1.x>v3.1.x</option><option value=/docs/v3.0.x>v3.0.x</option><option value=/docs/v2.15.x>v2.15.x</option><option value=/docs/v2.14.x>v2.14.x</option><option value=/docs/v2.13.x>v2.13.x</option><option value=/docs/v2.12.x>v2.12.x</option><option value=/docs/v2.11.x>v2.11.x</option><option value=/docs/v2.10.x>v2.10.x</option><option value=/docs/v2.9.x>v2.9.x</option><option value=/docs/v2.8.x>v2.8.x</option><option value=/docs/v2.7.x>v2.7.x</option><option value=/docs/v2.6.x>v2.6.x</option><option value=/docs/v2.5.x>v2.5.x</option><option value=/docs/v2.4.x>v2.4.x</option><option value=/docs/v2.3.x>v2.3.x</option><option value=/docs/v2.2.x>v2.2.x</option><option value=/docs/v2.1.x>v2.1.x</option><option value=/docs/v2.0.x>v2.0.x</option><option value=/docs/v1.14.x>v1.14.x</option><option value=/docs/v1.13.x>v1.13.x</option></select></div></div></div></li><div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value" style="border: none;"><option value=/docs/v4.2.x>Documentation</option><option value=/docs/v4.2.x/Guides>Guides</option><option value=/docs/v4.2.x/Guides/Benchmarking>Benchmarking</option><option value=/docs/v4.2.x/Guides/Contributing>Contributing</option><option value=/docs/v4.2.x/Guides/Database>Database</option><option value=/docs/v4.2.x/Guides/Delay-Accepting-Requests>Delay-Accepting-Requests</option><option value=/docs/v4.2.x/Guides/Ecosystem>Ecosystem</option><option value=/docs/v4.2.x/Guides/Fluent-Schema>Fluent-Schema</option><option value=/docs/v4.2.x/Guides/Getting-Started>Getting-Started</option><option value=/docs/v4.2.x/Guides/Migration-Guide-V3>Migration-Guide-V3</option><option value=/docs/v4.2.x/Guides/Migration-Guide-V4>Migration-Guide-V4</option><option value=/docs/v4.2.x/Guides/Plugins-Guide>Plugins-Guide</option><option selected value=/docs/v4.2.x/Guides/Prototype-Poisoning>Prototype-Poisoning</option><option value=/docs/v4.2.x/Guides/Recommendations>Recommendations</option><option value=/docs/v4.2.x/Guides/Serverless>Serverless</option><option value=/docs/v4.2.x/Guides/Style-Guide>Style-Guide</option><option value=/docs/v4.2.x/Guides/Testing>Testing</option><option value=/docs/v4.2.x/Guides/Write-Plugin>Write-Plugin</option><option value=/docs/v4.2.x/Reference>Reference</option><option value=/docs/v4.2.x/Reference/ContentTypeParser>ContentTypeParser</option><option value=/docs/v4.2.x/Reference/Decorators>Decorators</option><option value=/docs/v4.2.x/Reference/Encapsulation>Encapsulation</option><option value=/docs/v4.2.x/Reference/Errors>Errors</option><option value=/docs/v4.2.x/Reference/HTTP2>HTTP2</option><option value=/docs/v4.2.x/Reference/Hooks>Hooks</option><option value=/docs/v4.2.x/Reference/LTS>LTS</option><option value=/docs/v4.2.x/Reference/Lifecycle>Lifecycle</option><option value=/docs/v4.2.x/Reference/Logging>Logging</option><option value=/docs/v4.2.x/Reference/Middleware>Middleware</option><option value=/docs/v4.2.x/Reference/Plugins>Plugins</option><option value=/docs/v4.2.x/Reference/Reply>Reply</option><option value=/docs/v4.2.x/Reference/Request>Request</option><option value=/docs/v4.2.x/Reference/Routes>Routes</option><option value=/docs/v4.2.x/Reference/Server>Server</option><option value=/docs/v4.2.x/Reference/Type-Providers>Type-Providers</option><option value=/docs/v4.2.x/Reference/TypeScript>TypeScript</option><option value=/docs/v4.2.x/Reference/Validation-and-Serialization>Validation-and-Serialization</option></select></div></div></div></ul></nav><div id=doc-content class=content><blockquote><p>The following is an article written by Eran Hammer. It is reproduced here for posterity <a href=https://github.com/fastify/fastify/issues/1426#issuecomment-817957913>with permission</a>. It has been reformatted from the original HTML source to Markdown source, but otherwise remains the same. The original HTML can be retrieved from the above permission link.</p></blockquote><h2 id=a-tale-of-prototype-poisoning>A Tale of (prototype) Poisoning</h2><p><a id=pp></a></p><p>This story is a behind-the-scenes look at the process and drama created by a particularity interesting web security issue. It is also a perfect illustration of the efforts required to maintain popular pieces of open source software and the limitations of existing communication channels.</p><p>But first, if you use a JavaScript framework to process incoming JSON data, take a moment to read up on <a href=https://medium.com/intrinsic/javascript-prototype-poisoning-vulnerabilities-in-the-wild-7bc15347c96>Prototype Poisoning</a> in general, and the specific <a href=https://github.com/hapijs/hapi/issues/3916>technical details</a> of this issue. I&#39;ll explain it all in a bit, but since this could be a critical issue, you might want to verify your own code first. While this story is focused on a specific framework, any solution that uses <code>JSON.parse()</code> to process external data is potentially at risk.</p><h3 id=boom>BOOM</h3><p><a id=pp-boom></a></p><p>Our story begins with a bang.</p><p>The engineering team at Lob (long time generous supporters of my work!) reported a critical security vulnerability they identified in our data validation module — <a href=https://github.com/hapijs/joi>joi</a>. They provided some technical details and a proposed solution.</p><p>The main purpose of a data validation library is to ensure the output fully complies with the rules defined. If it doesn&#39;t, validation fails. If it passes, your can blindly trust that the data you are working with is safe. In fact, most developers treat validated input as completely safe from a system integrity perspective. This is crucial.</p><p>In our case, the Lob team provided an example where some data was able to sneak by the validation logic and pass through undetected. This is the worst possible defect a validation library can have.</p><h3 id=prototype-in-a-nutshell>Prototype in a nutshell</h3><p><a id=pp-nutshell></a></p><p>To understand this story, you need to understand how JavaScript works a bit. Every object in JavaScript can have a prototype. It is a set of methods and properties it &quot;inherits&quot; from another object. I put inherits in quotes because JavaScript isn&#39;t really an object oriented language.</p><p>A long time ago, for a bunch of irrelevant reasons, someone decided that it would be a good idea to use the special property name <code>__proto__</code> to access (and set) an object&#39;s prototype. This has since been deprecated but nevertheless, fully supported.</p><p>To demonstrate:</p><pre><code>&gt; const a = { b: 5 };
&gt; a.b;
5
&gt; a.__proto__ = { c: 6 };
&gt; a.c;
6
&gt; a;
{ b: 5 }
</code></pre><p>As you can see, the object doesn&#39;t have a <code>c</code> property, but its prototype does. When validating the object, the validation library ignores the prototype and only validates the object&#39;s own properties. This allows <code>c</code> to sneak in via the prototype.</p><p>Another important part of this story is the way <code>JSON.parse()</code> — a utility provided by the language to convert JSON formatted text into objects  —  handles this magic <code>__proto__</code> property name.</p><pre><code>&gt; const text = &#39;{ &quot;b&quot;: 5, &quot;__proto__&quot;: { &quot;c&quot;: 6 } }&#39;;
&gt; const a = JSON.parse(text);
&gt; a;
{ b: 5, __proto__: { c: 6 } }
</code></pre><p>Notice how <code>a</code> has a <code>__proto__</code> property. This is not a prototype reference. It is a simple object property key, just like <code>b</code>. As we&#39;ve seen from the first example, we can&#39;t actually create this key through assignment as that invokes the prototype magic and sets an actual prototype. <code>JSON.parse()</code> however, sets a simple property with that poisonous name.</p><p>By itself, the object created by <code>JSON.parse()</code> is perfectly safe. It doesn&#39;t have a prototype of its own. It has a seemingly harmless property that just happens to overlap with a built-in JavaScript magic name.</p><p>However, other methods are not as lucky:</p><pre><code>&gt; const x = Object.assign({}, a);
&gt; x;
{ b: 5}
&gt; x.c;
6;
</code></pre><p>If we take the <code>a</code> object created earlier by <code>JSON.parse()</code> and pass it to the helpful <code>Object.assign()</code> method (used to perform a shallow copy of all the top level properties of <code>a</code> into the provided empty <code>{}</code> object), the magic <code>__proto__</code> property &quot;leaks&quot; and becomes <code>x</code> &#39;s actual prototype.</p><p>Surprise!</p><p>Put together, if you get some external text input, parse it with <code>JSON.parse()</code> then perform some simple manipulation of that object (say, shallow clone and add an <code>id</code> ), and then pass it to our validation library, anything passed through via <code>__proto__</code> would sneak in undetected.</p><h3 id=oh-joi>Oh joi!</h3><p><a id=pp-oh-joi></a></p><p>The first question is, of course, why does the validation module <strong>joi</strong> ignore the prototype and let potentially harmful data through? We asked ourselves the same question and our instant thought was &quot;it was an oversight&quot;. A bug. A really big mistake. The joi module should not have allowed this to happen. But…</p><p>While joi is used primarily for validating web input data, it also has a significant user base using it to validate internal objects, some of which have prototypes. The fact that joi ignores the prototype is a helpful &quot;feature&quot;. It allows validating the object&#39;s own properties while ignoring what could be a very complicated prototype structure (with many methods and literal properties).</p><p>Any solution at the joi level would mean breaking some currently working code.</p><h3 id=the-right-thing>The right thing</h3><p><a id=pp-right-thing></a></p><p>At this point, we were looking at a devastatingly bad security vulnerability. Right up there in the upper echelons of epic security failures. All we knew is that our extremely popular data validation library fails to block harmful data, and that this data is trivial to sneak through. All you need to do is add <code>__proto__</code> and some crap to a JSON input and send it on its way to an application built using our tools.</p><p>(Dramatic pause)</p><p>We knew we had to fix joi to prevent this but given the scale of this issue, we had to do it in a way that will put a fix out without drawing too much attention to it — without making it too easy to exploit — at least for a few days until most systems received the update.</p><p>Sneaking a fix isn&#39;t the hardest thing to accomplish. If you combine it with an otherwise purposeless refactor of the code, and throw in a few unrelated bug fixes and maybe a cool new feature, you can publish a new version without drawing attention to the real issue being fixed.</p><p>The problem was, the right fix was going to break valid use cases. You see, joi has no way of knowing if you want it to ignore the prototype you set, or block the prototype set by an attacker. A solution that fixes the exploit will break code and breaking code tends to get a lot of attention.</p><p>On the other hand, if we released a proper (<a href=https://semver.org/ >semantically versioned</a>) fix, mark it as a breaking change, and add a new API to explicitly tell joi what you want it to do with the prototype, we will share with the world how to exploit this vulnerability while also making it more time consuming for systems to upgrade (breaking changes never get applied automatically by build tools).</p><p>Lose — Lose.</p><h3 id=a-detour>A detour</h3><p><a id=pp-detour></a></p><p>While the issue at hand was about incoming request payloads, we had to pause and check if it could also impact data coming via the query string, cookies, and headers. Basically, anything that gets serialized into objects from text.</p><p>We quickly confirmed node default query string parser was fine as well as its header parser. I identified one potential issue with base64-encoded JSON cookies as well as the usage of custom query string parsers. We also wrote some tests to confirm that the most popular third-party query string parser  — <a href=https://www.npmjs.com/package/qs>qs</a> —  was not vulnerable (it is not!).</p><h3 id=a-development>A development</h3><p><a id=pp-a-development></a></p><p>Throughout this triage, we just assumed that the offending input with its poisoned prototype was coming into joi from hapi, the web framework connecting the hapi.js ecosystem. Further investigation by the Lob team found that the problem was a bit more nuanced.</p><p>hapi used <code>JSON.parse()</code> to process incoming data. It first set the result object as a <code>payload</code> property of the incoming request, and then passed that same object for validation by joi before being passed to the application business logic for processing. Since <code>JSON.parse()</code> doesn&#39;t actually leak the <code>__proto__</code> property, it would arrive to joi with an invalid key and fail validation.</p><p>However, hapi provides two extension points where the payload data can be inspected (and processed) prior to validation. It is all properly documented and well understood by most developers. The extension points are there to allow you to interact with the raw inputs prior to validation for legitimate (and often security related) reasons.</p><p>If during one of these two extension points, a developer used <code>Object.assign()</code> or a similar method on the payload, the <code>__proto__</code> property would leak and become an actual prototype.</p><h3 id=sigh-of-relief>Sigh of relief</h3><p><a id=pp-sigh-of-relief></a></p><p>We were now dealing with a much different level of awfulness. Manipulating the payload object prior to validation is not common which meant this was no longer a doomsday scenario. It was still potentially catastrophic but the exposure dropped from every joi user to some very specific implementations.</p><p>We were no longer looking at a secretive joi release. The issue in joi is still there, but we can now address it properly with a new API and breaking release over the next few weeks.</p><p>We also knew that we can easily mitigate this vulnerability at the framework level since it knows which data is coming from the outside and which is internally generated. The framework is really the only piece that can protect developers against making such unexpected mistakes.</p><h3 id=good-news-bad-news-no-news>Good news, bad news, no news?</h3><p><a id=pp-good-news-no-news></a></p><p>The good news was that this wasn&#39;t our fault. It wasn&#39;t a bug in hapi or joi. It was only possible through a complex combination of actions that was not unique to hapi or joi. This can happen with every other JavaScript framework. If hapi is broken, then the world is broken.</p><p>Great — we solved the blame game.</p><p>The bad news is that when there is nothing to blame (other than JavaScript itself), it is much harder getting it fixed.</p><p>The first question people ask once a security issue is found is if there is going to be a CVE published. A CVE — Common Vulnerabilities and Exposures — is a <a href=https://cve.mitre.org/ >database</a> of known security issues. It is a critical component of web security. The benefit of publishing a CVE is that it immediately triggers alarms and informs and often breaks automated builds until the issue is resolved.</p><p>But what do we pin this to?</p><p>Probably, nothing. We are still debating whether we should tag some versions of hapi with a warning. The &quot;we&quot; is the node security process. Since we now have a new version of hapi that mitigate the problem by default, it can be considered a fix. But because the fix isn&#39;t to a problem in hapi itself, it is not exactly kosher to declare older versions harmful.</p><p>Publishing an advisory on previous versions of hapi for the sole purpose of nudging people into awareness and upgrade is an abuse of the advisory process. I&#39;m personally fine with abusing it for the purpose of improving security but that&#39;s not my call. As of this writing, it is still being debated.</p><h3 id=the-solution-business>The solution business</h3><p><a id=pp-solution-business></a></p><p>Mitigating the issue wasn&#39;t hard. Making it scale and safe was a bit more involved. Since we knew where harmful data can enter the system, and we knew where we used the problematic <code>JSON.parse()</code> we could replace it with a safe implementation.</p><p>One problem. Validating data can be costly and we are now planning on validating every incoming JSON text. The built-in <code>JSON.parse()</code> implementation is fast. Really really fast. It is unlikely we can build a replacement that will be more secure and anywhere as fast. Especially not overnight and without introducing new bugs.</p><p>It was obvious we were going to wrap the existing <code>JSON.parse()</code> method with some additional logic. We just had to make sure it was not adding too much overhead. This isn&#39;t just a performance consideration but also a security one. If we make it easy to slow down a system by simply sending specific data, we make it easy to execute a <a href=https://en.wikipedia.org/wiki/Denial-of-service_attack>DoS attack</a> at very low cost.</p><p>I came up with a stupidly simple solution: first parse the text using the existing tools. If this didn&#39;t fail, scan the original raw text for the offending string &quot;<strong>proto</strong>&quot;. Only if we find it, perform an actual scan of the object. We can&#39;t block every reference to &quot;<strong>proto</strong>&quot; — sometimes it is perfectly valid value (like when writing about it here and sending this text over to Medium for publication).</p><p>This made the &quot;happy path&quot; practically as fast as before. It just added one function call, a quick text scan (again, very fast built-in implementation), and a conditional return. The solution had negligible impact on the vast majority of data expected to pass through it.</p><p>Next problem. The prototype property doesn&#39;t have to be at the top level of the incoming object. It can be nested deep inside. This means we cannot just check for the presence of it at the top level. We need to recursively iterate through the object.</p><p>While recursive functions are a favorite tool, they could be disastrous when writing security-conscious code. You see, recursive function increase the size of the runtime call stack. The more times you loop, the longer the call stack gets. At some point — KABOOM— you reach the maximum length and the process dies.</p><p>If you cannot guarantee the shape of the incoming data, recursive iteration becomes an open threat. An attacker only needs to craft a deep enough object to crash your servers.</p><p>I used a flat loop implementation that is both more memory efficient (less function calls, less passing of temporary arguments) and more secure. I am not pointing this out to brag, but to highlight how basic engineering practices can create (or avoid) security pitfalls.</p><h3 id=putting-it-to-the-test>Putting it to the test</h3><p><a id=pp-putting-to-test></a></p><p>I sent the code to two people. First to <a href=https://github.com/nlf>Nathan LaFreniere</a> to double check the security properties of the solution, and then to <a href=https://github.com/mcollina>Matteo Collina</a> to review the performance. They are among the very best at what they do and often my go-to people.</p><p>The performance benchmarks confirmed that the &quot;happy path&quot; was practically unaffected. The interesting findings was that removing the offending values was faster then throwing an exception. This raised the question of what should be the default behavior of the new module — which I called <a href=https://github.com/hapijs/bourne><strong>bourne</strong></a> —  error or sanitize.</p><p>The concern, again, was exposing the application to a DoS attack. If sending a request with <code>__proto__</code> makes things 500% slower, that could be an easy vector to exploit. But after a bit more testing we confirmed that sending <strong>any</strong> invalid JSON text was creating a very similar cost.</p><p>In other words, if you parse JSON, invalid values are going to cost you more, regardless of what makes them invalid. It is also important to remember that while the benchmark showed the significant % cost of scanning suspected objects, the actual cost in CPU time was still in the fraction of milliseconds. Important to note and measure but not actually harmful.</p><h3 id=hapi-ever-after>hapi ever-after</h3><p><a id=pp-hapi-ever-after></a></p><p>There are a bunch of things to be grateful for.</p><p>The initial disclosure by the Lob team was perfect. It was reported privately, to the right people, with the right information. They followed up with additional findings, and gave us the time and space to resolve it the right way. Lob also was a major sponsor of my work on hapi over the years and that financial support is critical to allow everything else to happen. More on that in a bit.</p><p>Triage was stressful but staffed with the right people. Having folks like <a href=https://github.com/Marsup>Nicolas Morel</a>, Nathan, and Matteo, available and eager to help is critical. This isn&#39;t easy to deal with without the pressure, but with it, mistakes are likely without proper team collaboration.</p><p>We got lucky with the actual vulnerability. What started up looking like a catastrophic problem, ended up being a delicate but straight-forward problem to address.</p><p>We also got lucky by having full access to mitigate it at the source — didn&#39;t need to send emails to some unknown framework maintainer and hope for a quick answer. hapi&#39;s total control over all of its dependencies proved its usefulness and security again. Not using <a href=https://hapi.dev>hapi</a>? <a href=https://hueniverse.com/why-you-should-consider-hapi-6163689bd7c2>Maybe you should</a>.</p><h3 id=the-after-in-happy-ever-after>The after in happy ever-after</h3><p><a id=pp-after-ever-after></a></p><p>This is where I have to take advantage of this incident to reiterate the cost and need for sustainable and secure open source.</p><p>My time alone on this one issue exceeded 20 hours. That&#39;s half a working week. It came at the end of a month were I already spent over 30 hours publishing a new major release of hapi (most of the work was done in December). This puts me at a personal financial loss of over $5000 this month (I had to cut back on paid client work to make time for it).</p><p>If you rely on code I maintain, this is exactly the level of support, quality, and commitment you want (and lets be honest — expect). Most of you take it for granted — not just my work but the work of hundreds of other dedicated open source maintainers.</p><p>Because this work is important, I decided to try and make it not just financially sustainable but to grow and expand it. There is so much to improve. This is exactly what motivates me to implement the new <a href=https://web.archive.org/web/20190201220503/https://hueniverse.com/on-hapi-licensing-a-preview-f982662ee898>commercial licensing plan</a> coming in March. You can read more about it <a href=https://web.archive.org/web/20190201220503/https://hueniverse.com/on-hapi-licensing-a-preview-f982662ee898>here</a>.</p><p>Of all the time consuming things, security is at the very top. I hope this story successfully conveyed not just the technical details, but also the human drama and what it takes to keep the web secure.</p></div><hr><nav class=level></nav></div></div></div></section><script>// dynamically creates a submenu for the current section based on the content headers
  var titles = document.querySelectorAll('#doc-content h3, #doc-content h4')
  var currentMenu = document.getElementById('doc-menu-section')
  if (titles.length && currentMenu) {
    var submenu = document.createElement('ul')
    titles.forEach(el => {
      var currentSubmenuItem = document.createElement('li')
      var currentSubmenuLink = document.createElement('a')
      currentSubmenuLink.href = '#' + el.id
      currentSubmenuLink.title = el.textContent
      currentSubmenuLink.append(document.createTextNode(el.textContent))
      currentSubmenuItem.append(currentSubmenuLink)
      submenu.append(currentSubmenuItem)
    })
    currentMenu.append(submenu)
  }

  // dynamically creates header anchor links
  var headers = document.querySelectorAll('#doc-content h3, #doc-content h4')
  headers.forEach(el => {
    var currentAnchorLink = document.createElement('a')
    currentAnchorLink.className = 'anchor'
    currentAnchorLink.href = "#" + el.id
    currentAnchorLink.append(document.createTextNode('¶'))
    el.insertBefore(currentAnchorLink, el.firstChild);
  })</script><script>const contentLoaded = document.addEventListener('DOMContentLoaded', setTOCHeight)
  const resize = window.addEventListener('resize', setTOCHeight)

  function setTOCHeight() {
    const docHeight = window.innerHeight
    const tocSidebar = document.querySelector('#toc') || 0

    const tocHeight = docHeight - tocSidebar.getBoundingClientRect().top

    document.documentElement.style
      .setProperty('--TOC-height', `${tocHeight}px`)
  }

  window.addEventListener('beforeunload', () => {
    document.removeEventListener(contentLoaded)
    window.removeEventListener(resize)
  })</script></main><footer class="grey is-primary footer"><div class=container><div class="content has-text-centered"><p>Fastify, Copyright &copy; 2016-2023 <a href=https://openjsf.org/ target=_blank rel=noopener>OpenJS Foundation</a> and <a href=https://github.com/fastify/fastify#team target=_blank rel=noopener>The Fastify team</a>, Licensed under <a href=https://github.com/fastify/fastify/blob/master/LICENSE target=_blank rel=noopener>MIT</a></p><a href=https://www.netlify.com><img src=https://www.netlify.com/img/global/badges/netlify-color-accent.svg alt="Deploys by Netlify" loading=lazy decoding=async></a><p><small>Icons by simpleicons.org</small></p></div></div></footer><script src=/js/main.1e1d476db6c0b326.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js integrity="sha512-s+tOYYcC3Jybgr9mVsdAxsRYlGNq4mlAurOrfNuGMQ/SCofNPu92tjE7YRZCsdEtWL1yGkqk15fU/ark206YTg==" crossorigin=anonymous></script><script>hljs.highlightAll();</script><script src=https://cdn.jsdelivr.net/npm/@docsearch/js@alpha></script><script type=text/javascript>docsearch({
        appId: 'DMPMC33PLU',
        apiKey: '12d46b3bfeee6511031cfe00778f3e45',
        indexName: 'fastify',
        container: '#algolia-search-input',
        algoliaOptions: { 'facetFilters': ["version:latest", "tags:docs"] }
      });</script></body></html>