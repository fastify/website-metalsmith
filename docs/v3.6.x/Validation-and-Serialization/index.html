<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Validation-and-Serialization</title><meta name=description content="Fast and low overhead web framework, for Node.js"><link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.ed24c0a19503e080.png><link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.60c285c424d50738.png><link rel=apple-touch-icon sizes=72x72 href=/images/apple-icon-72x72.e49b27cfe1ab1461.png><link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.752f43fc91b8c1f7.png><link rel=apple-touch-icon sizes=114x114 href=/images/apple-icon-114x114.61739fa1d5a7059a.png><link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.7c25de37c5ce2ec1.png><link rel=apple-touch-icon sizes=144x144 href=/images/apple-icon-144x144.04d88fb27bd92cbe.png><link rel=apple-touch-icon sizes=152x152 href=/images/apple-icon-152x152.9364781175671626.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-icon-180x180.67579100928bfcd2.png><link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.37eb7f1ae3853740.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.1e22f0e774bc3cce.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.7e8a68b1b80c1799.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.e534ce05cb727f1a.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content=#ffffff><meta name=msapplication-TileImage content=/images/ms-icon-144x144.png><meta name=theme-color content=#ffffff><meta property=og:url content=https://www.fastify.io/docs/v3.6.x/Validation-and-Serialization><meta property=og:type content=website><meta property=og:title content=Validation-and-Serialization><meta property=og:description content="Fast and low overhead web framework, for Node.js"><meta property=og:image content=https://www.fastify.io/images/fastify-fb-share-image.07b6e6860853c758.png><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@fastifyjs><meta name=twitter:creator content=@fastifyjs><meta name=twitter:title content=Validation-and-Serialization><meta name=twitter:description content="Fast and low overhead web framework, for Node.js"><meta name=twitter:image content=https://www.fastify.io/images/fastify-twitter-share-image.cd9f217b360af3e2.png><link rel=stylesheet href=/css/style.7b9a86078f3cc4f5.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css integrity="sha512-kZqGbhf9JTB4bVJ0G8HCkqmaPcRgo88F0dneK30yku5Y/dep7CZfCnNml2Je/sY4lBoqoksXz4PtVXS4GHSUzQ==" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css crossorigin=anonymous><meta name=robots content="noindex, nofollow"></head><body><nav id=main-navbar class=navbar><div class=navbar-brand><a class=navbar-item href=/ ><img src=/images/fastify-logo-menu.d13f8da7a965c800.png alt="Fastify: Fast and low overhead web framework, for Node.js" height=28> </a><a class="navbar-item is-hidden-desktop" href=https://github.com/fastify/fastify target=_blank rel=noopener><span class=icon style="color: #333;"><i class="fa fa-github"></i></span></a><div class="navbar-burger burger" data-target=mobileMenu><span></span> <span></span> <span></span></div></div><div class=navbar-menu id=mobileMenu><div class=navbar-start><a class=navbar-item href=/ >Home</a> <a class=navbar-item href=/docs/latest>Docs</a> <a class=navbar-item href=/ecosystem>Ecosystem</a> <a class=navbar-item href=/benchmarks>Benchmarks</a> <a class=navbar-item href=/contribute>Contribute</a> <a class=navbar-item href=https://medium.com/@fastifyjs/ >Blog</a> <a class=navbar-item href=https://github.com/fastify/help>Help</a></div><div class=navbar-end><span class="control has-icons-left navbar-item"><input id=algolia-search-input class=input type=search placeholder=""> <span class="icon is-medium is-left"><i class="fa fa-search"></i> </span></span><a class=navbar-item href=https://github.com/fastify/fastify target=_blank rel=noopener><span class="fa fa-github"></span>&nbsp;GitHub </a><a class=navbar-item href=https://twitter.com/fastifyjs target=_blank rel=noopener><span class="fa fa-twitter"></span>&nbsp;Twitter</a></div></div></nav><main class=page-content aria-label=Content><section class="hero is-primary" style="background-image: url(/images/bg-pattern-dark.3f8cda863b3bbf52.png)"><div class=hero-body><div class=container><h1 class=title>Documentation (v3.6.0)</h1></div></div></section><section class=section><div class=container><div class=columns><div class="column is-3 is-hidden-mobile" data-sticky-container><aside class="menu sticky"><ul class=menu-list><li><a title=Benchmarking href=/docs/v3.6.x/Benchmarking>Benchmarking</a></li><li><a title=ContentTypeParser href=/docs/v3.6.x/ContentTypeParser>ContentTypeParser</a></li><li><a title=Decorators href=/docs/v3.6.x/Decorators>Decorators</a></li><li><a title=Ecosystem href=/docs/v3.6.x/Ecosystem>Ecosystem</a></li><li><a title=Errors href=/docs/v3.6.x/Errors>Errors</a></li><li><a title=Fluent-Schema href=/docs/v3.6.x/Fluent-Schema>Fluent-Schema</a></li><li><a title=Getting-Started href=/docs/v3.6.x/Getting-Started>Getting-Started</a></li><li><a title=HTTP2 href=/docs/v3.6.x/HTTP2>HTTP2</a></li><li><a title=Hooks href=/docs/v3.6.x/Hooks>Hooks</a></li><li><a title=LTS href=/docs/v3.6.x/LTS>LTS</a></li><li><a title=Lifecycle href=/docs/v3.6.x/Lifecycle>Lifecycle</a></li><li><a title=Logging href=/docs/v3.6.x/Logging>Logging</a></li><li><a title=Middleware href=/docs/v3.6.x/Middleware>Middleware</a></li><li><a title=Migration-Guide-V3 href=/docs/v3.6.x/Migration-Guide-V3>Migration-Guide-V3</a></li><li><a title=Plugins-Guide href=/docs/v3.6.x/Plugins-Guide>Plugins-Guide</a></li><li><a title=Plugins href=/docs/v3.6.x/Plugins>Plugins</a></li><li><a title=Recommendations href=/docs/v3.6.x/Recommendations>Recommendations</a></li><li><a title=Reply href=/docs/v3.6.x/Reply>Reply</a></li><li><a title=Request href=/docs/v3.6.x/Request>Request</a></li><li><a title=Routes href=/docs/v3.6.x/Routes>Routes</a></li><li><a title=Server href=/docs/v3.6.x/Server>Server</a></li><li><a title=Serverless href=/docs/v3.6.x/Serverless>Serverless</a></li><li><a title=Testing href=/docs/v3.6.x/Testing>Testing</a></li><li><a title=TypeScript href=/docs/v3.6.x/TypeScript>TypeScript</a></li><li id=doc-menu-section><a title=Validation-and-Serialization class=is-active href=/docs/v3.6.x/Validation-and-Serialization>Validation-and-Serialization</a></li><li><a title=Write-Plugin href=/docs/v3.6.x/Write-Plugin>Write-Plugin</a></li></ul><div class=content style="margin: .8em; border-top: 1px solid #ccc; padding: .8em 0 0 0">Docs version<div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value"><option value=/docs/latest>latest</option><option value=/docs/master>master</option><option value=/docs/v3.21.x>v3.21.x</option><option value=/docs/v3.20.x>v3.20.x</option><option value=/docs/v3.19.x>v3.19.x</option><option value=/docs/v3.18.x>v3.18.x</option><option value=/docs/v3.17.x>v3.17.x</option><option value=/docs/v3.16.x>v3.16.x</option><option value=/docs/v3.15.x>v3.15.x</option><option value=/docs/v3.14.x>v3.14.x</option><option value=/docs/v3.13.x>v3.13.x</option><option value=/docs/v3.12.x>v3.12.x</option><option value=/docs/v3.11.x>v3.11.x</option><option value=/docs/v3.10.x>v3.10.x</option><option value=/docs/v3.9.x>v3.9.x</option><option value=/docs/v3.8.x>v3.8.x</option><option value=/docs/v3.7.x>v3.7.x</option><option selected value=/docs/v3.6.x>v3.6.x</option><option value=/docs/v3.5.x>v3.5.x</option><option value=/docs/v3.4.x>v3.4.x</option><option value=/docs/v3.3.x>v3.3.x</option><option value=/docs/v3.2.x>v3.2.x</option><option value=/docs/v3.1.x>v3.1.x</option><option value=/docs/v3.0.x>v3.0.x</option><option value=/docs/v2.15.x>v2.15.x</option><option value=/docs/v2.14.x>v2.14.x</option><option value=/docs/v2.13.x>v2.13.x</option><option value=/docs/v2.12.x>v2.12.x</option><option value=/docs/v2.11.x>v2.11.x</option><option value=/docs/v2.10.x>v2.10.x</option><option value=/docs/v2.9.x>v2.9.x</option><option value=/docs/v2.8.x>v2.8.x</option><option value=/docs/v2.7.x>v2.7.x</option><option value=/docs/v2.6.x>v2.6.x</option><option value=/docs/v2.5.x>v2.5.x</option><option value=/docs/v2.4.x>v2.4.x</option><option value=/docs/v2.3.x>v2.3.x</option><option value=/docs/v2.2.x>v2.2.x</option><option value=/docs/v2.1.x>v2.1.x</option><option value=/docs/v2.0.x>v2.0.x</option><option value=/docs/v1.14.x>v1.14.x</option><option value=/docs/v1.13.x>v1.13.x</option></select></div></div></div></div></aside></div><div class="column is-9"><nav class=breadcrumb><ul><li><a href=/ style="padding-left: 0">Fastify</a></li><li><a href=/docs/ >Documentation</a></li><li><div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value" style="border: none;"><option value=/docs/latest>latest</option><option value=/docs/master>master</option><option value=/docs/v3.21.x>v3.21.x</option><option value=/docs/v3.20.x>v3.20.x</option><option value=/docs/v3.19.x>v3.19.x</option><option value=/docs/v3.18.x>v3.18.x</option><option value=/docs/v3.17.x>v3.17.x</option><option value=/docs/v3.16.x>v3.16.x</option><option value=/docs/v3.15.x>v3.15.x</option><option value=/docs/v3.14.x>v3.14.x</option><option value=/docs/v3.13.x>v3.13.x</option><option value=/docs/v3.12.x>v3.12.x</option><option value=/docs/v3.11.x>v3.11.x</option><option value=/docs/v3.10.x>v3.10.x</option><option value=/docs/v3.9.x>v3.9.x</option><option value=/docs/v3.8.x>v3.8.x</option><option value=/docs/v3.7.x>v3.7.x</option><option selected value=/docs/v3.6.x>v3.6.x</option><option value=/docs/v3.5.x>v3.5.x</option><option value=/docs/v3.4.x>v3.4.x</option><option value=/docs/v3.3.x>v3.3.x</option><option value=/docs/v3.2.x>v3.2.x</option><option value=/docs/v3.1.x>v3.1.x</option><option value=/docs/v3.0.x>v3.0.x</option><option value=/docs/v2.15.x>v2.15.x</option><option value=/docs/v2.14.x>v2.14.x</option><option value=/docs/v2.13.x>v2.13.x</option><option value=/docs/v2.12.x>v2.12.x</option><option value=/docs/v2.11.x>v2.11.x</option><option value=/docs/v2.10.x>v2.10.x</option><option value=/docs/v2.9.x>v2.9.x</option><option value=/docs/v2.8.x>v2.8.x</option><option value=/docs/v2.7.x>v2.7.x</option><option value=/docs/v2.6.x>v2.6.x</option><option value=/docs/v2.5.x>v2.5.x</option><option value=/docs/v2.4.x>v2.4.x</option><option value=/docs/v2.3.x>v2.3.x</option><option value=/docs/v2.2.x>v2.2.x</option><option value=/docs/v2.1.x>v2.1.x</option><option value=/docs/v2.0.x>v2.0.x</option><option value=/docs/v1.14.x>v1.14.x</option><option value=/docs/v1.13.x>v1.13.x</option></select></div></div></div></li><li class=is-active><a>Validation-and-Serialization</a></li></ul></nav><div id=doc-content class=content><h2 id=validation-and-serialization>Validation and Serialization</h2><p>Fastify uses a schema-based approach, and even if it is not mandatory we recommend using <a href=http://json-schema.org/ >JSON Schema</a> to validate your routes and serialize your outputs. Internally, Fastify compiles the schema into a highly performant function.</p><blockquote><h2 id=⚠--security-notice>⚠ Security Notice</h2><p>Treat the schema definition as application code. As both validation and serialization features dynamically evaluate code with <code>new Function()</code>, it is not safe to use user-provided schemas. See <a href=http://npm.im/ajv>Ajv</a> and <a href=http://npm.im/fast-json-stringify>fast-json-stringify</a> for more details.</p></blockquote><h3 id=core-concepts>Core concepts</h3><p>The validation and the serialization tasks are processed by two different, and customizable, actors:</p><ul><li><a href=https://www.npmjs.com/package/ajv>Ajv</a> for the validation of a request</li><li><a href=https://www.npmjs.com/package/fast-json-stringify>fast-json-stringify</a> for the serialization of a response&#39;s body</li></ul><p>These two separate entities share only the JSON schemas added to Fastify&#39;s instance through <code>.addSchema(schema)</code>.</p><p><a name=shared-schema></a></p><h4 id=adding-a-shared-schema>Adding a shared schema</h4><p>Thanks to the <code>addSchema</code> API, you can add multiple schemas to the Fastify instance and then reuse them in multiple parts of your application. As usual, this API is encapsulated.</p><p>The shared schemas can be reused through the JSON Schema <a href=https://tools.ietf.org/html/draft-handrews-json-schema-01#section-8><strong><code>$ref</code></strong></a> keyword. Here an overview on <em>how</em> references work:</p><ul><li><code>myField: { $ref: &#39;#foo&#39;}</code> will search for field with <code>$id: &#39;#foo&#39;</code> inside the current schema</li><li><code>myField: { $ref: &#39;#/definitions/foo&#39;}</code> will search for field <code>definitions.foo</code> inside the current schema</li><li><code>myField: { $ref: &#39;http://url.com/sh.json#&#39;}</code> will search for a shared schema added with <code>$id: &#39;http://url.com/sh.json&#39;</code></li><li><code>myField: { $ref: &#39;http://url.com/sh.json#/definitions/foo&#39;}</code> will search for a shared schema added with <code>$id: &#39;http://url.com/sh.json&#39;</code> and will use the field <code>definitions.foo</code></li><li><code>myField: { $ref: &#39;http://url.com/sh.json#foo&#39;}</code> will search for a shared schema added with <code>$id: &#39;http://url.com/sh.json&#39;</code> and it will look inside of it for object with <code>$id: &#39;#foo&#39;</code></li></ul><p><strong>Simple usage:</strong></p><pre><code class=language-js>fastify.addSchema({
  $id: &#39;http://example.com/&#39;,
  type: &#39;object&#39;,
  properties: {
    hello: { type: &#39;string&#39; }
  }
})

fastify.post(&#39;/&#39;, {
  handler () {},
  schema: {
    body: {
      type: &#39;array&#39;,
      items: { $ref: &#39;http://example.com#/properties/hello&#39; }
    }
  }
})
</code></pre><p><strong><code>$ref</code> as root reference:</strong></p><pre><code class=language-js>fastify.addSchema({
  $id: &#39;commonSchema&#39;,
  type: &#39;object&#39;,
  properties: {
    hello: { type: &#39;string&#39; }
  }
})

fastify.post(&#39;/&#39;, {
  handler () {},
  schema: {
    body: { $ref: &#39;commonSchema#&#39; },
    headers: { $ref: &#39;commonSchema#&#39; }
  }
})
</code></pre><p><a name=get-shared-schema></a></p><h4 id=retrieving-the-shared-schemas>Retrieving the shared schemas</h4><p>If the validator and the serializer are customized, the <code>.addSchema</code> method will not be useful since the actors are no longer controlled by Fastify. So, to access the schemas added to the Fastify instance, you can simply use <code>.getSchemas()</code>:</p><pre><code class=language-js>fastify.addSchema({
  $id: &#39;schemaId&#39;,
  type: &#39;object&#39;,
  properties: {
    hello: { type: &#39;string&#39; }
  }
})

const mySchemas = fastify.getSchemas()
const mySchema = fastify.getSchema(&#39;schemaId&#39;)
</code></pre><p>As usual, the function <code>getSchemas</code> is encapsulated and returns the shared schemas available in the selected scope:</p><pre><code class=language-js>fastify.addSchema({ $id: &#39;one&#39;, my: &#39;hello&#39; })
// will return only `one` schema
fastify.get(&#39;/&#39;, (request, reply) =&gt; { reply.send(fastify.getSchemas()) }) 

fastify.register((instance, opts, done) =&gt; {
  instance.addSchema({ $id: &#39;two&#39;, my: &#39;ciao&#39; })
  // will return `one` and `two` schemas
  instance.get(&#39;/sub&#39;, (request, reply) =&gt; { reply.send(instance.getSchemas()) })

  instance.register((subinstance, opts, done) =&gt; {
    subinstance.addSchema({ $id: &#39;three&#39;, my: &#39;hola&#39; })
    // will return `one`, `two` and `three`
    subinstance.get(&#39;/deep&#39;, (request, reply) =&gt; { reply.send(subinstance.getSchemas()) })
    done()
  })
  done()
})
</code></pre><h3 id=validation>Validation</h3><p>The route validation internally relies upon <a href=https://www.npmjs.com/package/ajv>Ajv</a>, which is a high-performance JSON Schema validator. Validating the input is very easy: just add the fields that you need inside the route schema, and you are done!</p><p>The supported validations are:</p><ul><li><code>body</code>: validates the body of the request if it is a POST or a PUT.</li><li><code>querystring</code> or <code>query</code>: validates the query string.</li><li><code>params</code>: validates the route params.</li><li><code>headers</code>: validates the request headers.</li></ul><p>All the validations can be a complete JSON Schema object (with a <code>type</code> property of <code>&#39;object&#39;</code> and a <code>&#39;properties&#39;</code> object containing parameters) or a simpler variation in which the <code>type</code> and <code>properties</code> attributes are forgone and the parameters are listed at the top level (see the example below).</p><p>Example:</p><pre><code class=language-js>const bodyJsonSchema = {
  type: &#39;object&#39;,
  required: [&#39;requiredKey&#39;],
  properties: {
    someKey: { type: &#39;string&#39; },
    someOtherKey: { type: &#39;number&#39; },
    requiredKey: {
      type: &#39;array&#39;,
      maxItems: 3,
      items: { type: &#39;integer&#39; }
    },
    nullableKey: { type: [&#39;number&#39;, &#39;null&#39;] }, // or { type: &#39;number&#39;, nullable: true }
    multipleTypesKey: { type: [&#39;boolean&#39;, &#39;number&#39;] },
    multipleRestrictedTypesKey: {
      oneOf: [
        { type: &#39;string&#39;, maxLength: 5 },
        { type: &#39;number&#39;, minimum: 10 }
      ]
    },
    enumKey: {
      type: &#39;string&#39;,
      enum: [&#39;John&#39;, &#39;Foo&#39;]
    },
    notTypeKey: {
      not: { type: &#39;array&#39; }
    }
  }
}

const queryStringJsonSchema = {
  type: &#39;object&#39;,
  properties: {
    name: { type: &#39;string&#39; },
    excitement: { type: &#39;integer&#39; }
  }
}

const paramsJsonSchema = {
  type: &#39;object&#39;,
  properties: {
    par1: { type: &#39;string&#39; },
    par2: { type: &#39;number&#39; }
  }
}

const headersJsonSchema = {
  type: &#39;object&#39;,
  properties: {
    &#39;x-foo&#39;: { type: &#39;string&#39; }
  },
  required: [&#39;x-foo&#39;]
}

const schema = {
  body: bodyJsonSchema,
  querystring: queryStringJsonSchema,
  params: paramsJsonSchema,
  headers: headersJsonSchema
}

fastify.post(&#39;/the/url&#39;, { schema }, handler)
</code></pre><p><em>Note that Ajv will try to <a href=https://github.com/epoberezkin/ajv#coercing-data-types>coerce</a> the values to the types specified in your schema <code>type</code> keywords, both to pass the validation and to use the correctly typed data afterwards.</em></p><p><a name=ajv-plugins></a></p><h4 id=ajv-plugins>Ajv Plugins</h4><p>You can provide a list of plugins you want to use with Ajv:</p><blockquote><p>Refer to <a href=/docs/v3.6.x/Server#ajv><code>ajv options</code></a> to check plugins format</p></blockquote><pre><code class=language-js>const fastify = require(&#39;fastify&#39;)({
  ajv: {
    plugins: [
      require(&#39;ajv-merge-patch&#39;)
    ]
  }
})

fastify.post(&#39;/&#39;, {
  handler (req, reply) { reply.send({ ok: 1 }) },
  schema: {
    body: {
      $patch: {
        source: {
          type: &#39;object&#39;,
          properties: {
            q: {
              type: &#39;string&#39;
            }
          }
        },
        with: [
          {
            op: &#39;add&#39;,
            path: &#39;/properties/q&#39;,
            value: { type: &#39;number&#39; }
          }
        ]
      }
    }
  }
})

fastify.post(&#39;/foo&#39;, {
  handler (req, reply) { reply.send({ ok: 1 }) },
  schema: {
    body: {
      $merge: {
        source: {
          type: &#39;object&#39;,
          properties: {
            q: {
              type: &#39;string&#39;
            }
          }
        },
        with: {
          required: [&#39;q&#39;]
        }
      }
    }
  }
})
</code></pre><p><a name=schema-validator></a></p><h4 id=validator-compiler>Validator Compiler</h4><p>The <code>validatorCompiler</code> is a function that returns a function that validates the body, url parameters, headers, and query string. The default <code>validatorCompiler</code> returns a function that implements the <a href=https://ajv.js.org/ >ajv</a> validation interface. Fastify uses it internally to speed the validation up.</p><p>Fastify&#39;s <a href=https://github.com/epoberezkin/ajv#options-to-modify-validated-data>baseline ajv configuration</a> is:</p><pre><code class=language-js>{
  removeAdditional: true, // remove additional properties
  useDefaults: true, // replace missing properties and items with the values from corresponding default keyword
  coerceTypes: true, // change data type of data to match type keyword
  nullable: true     // support keyword &quot;nullable&quot; from Open API 3 specification.
}
</code></pre><p>This baseline configuration can be modified by providing <a href=/docs/v3.6.x/Server#factory-ajv><code>ajv.customOptions</code></a> to your Fastify factory.</p><p>If you want to change or set additional config options, you will need to create your own instance and override the existing one like:</p><pre><code class=language-js>const fastify = require(&#39;fastify&#39;)()
const Ajv = require(&#39;ajv&#39;)
const ajv = new Ajv({
  // the fastify defaults (if needed)
  removeAdditional: true,
  useDefaults: true,
  coerceTypes: true,
  nullable: true,
  // any other options
  // ...
})
fastify.setValidatorCompiler(({ schema, method, url, httpPart }) =&gt; {
  return ajv.compile(schema)
})
</code></pre><p><em><strong>Note:</strong> If you use a custom instance of any validator (even Ajv), you have to add schemas to the validator instead of fastify, since fastify&#39;s default validator is no longer used, and fastify&#39;s <code>addSchema</code> method has no idea what validator you are using.</em></p><p><a name=using-other-validation-libraries></a></p><h5 id=using-other-validation-libraries>Using other validation libraries</h5><p>The <code>setValidatorCompiler</code> function makes it easy to substitute <code>ajv</code> with almost any Javascript validation library (<a href=https://github.com/hapijs/joi/ >joi</a>, <a href=https://github.com/jquense/yup/ >yup</a>, ...) or a custom one:</p><pre><code class=language-js>const Joi = require(&#39;@hapi/joi&#39;)

fastify.post(&#39;/the/url&#39;, {
  schema: {
    body: Joi.object().keys({
      hello: Joi.string().required()
    }).required()
  },
  validatorCompiler: ({ schema, method, url, httpPart }) =&gt; {
    return data =&gt; schema.validate(data)
  }
}, handler)
</code></pre><pre><code class=language-js>const yup = require(&#39;yup&#39;)
// Validation options to match ajv&#39;s baseline options used in Fastify
const yupOptions = {
  strict: false,
  abortEarly: false, // return all errors
  stripUnknown: true, // remove additional properties
  recursive: true
}

fastify.post(&#39;/the/url&#39;, {
  schema: {
    body: yup.object({
      age: yup.number().integer().required(),
      sub: yup.object().shape({
        name: yup.string().required()
      }).required()
    })
  },
  validatorCompiler: ({ schema, method, url, httpPart }) =&gt; {
    return function (data) {
      // with option strict = false, yup `validateSync` function returns the coerced value if validation was successful, or throws if validation failed
      try {
        const result = schema.validateSync(data, yupOptions)
        return { value: result }
      } catch (e) {
        return { error: e }
      }
    }
  }
}, handler)
</code></pre><h5 id=validation-messages-with-other-validation-libraries>Validation messages with other validation libraries</h5><p>Fastify&#39;s validation error messages are tightly coupled to the default validation engine: errors returned from <code>ajv</code> are eventually run through the <code>schemaErrorsText</code> function which is responsible for building human-friendly error messages. However, the <code>schemaErrorsText</code> function is written with <code>ajv</code> in mind : as a result, you may run into odd or incomplete error messages when using other validation libraries.</p><p>To circumvent this issue, you have 2 main options :</p><ol><li>make sure your validation function (returned by your custom <code>schemaCompiler</code>) returns errors in the exact same structure and format as <code>ajv</code> (although this could prove to be difficult and tricky due to differences between validation engines)</li><li>or use a custom <code>errorHandler</code> to intercept and format your &#39;custom&#39; validation errors</li></ol><p>To help you in writing a custom <code>errorHandler</code>, Fastify adds 2 properties to all validation errors:</p><ul><li>validation: the content of the <code>error</code> property of the object returned by the validation function (returned by your custom <code>schemaCompiler</code>)</li><li>validationContext: the &#39;context&#39; (body, params, query, headers) where the validation error occurred</li></ul><p>A very contrived example of such a custom <code>errorHandler</code> handling validation errors is shown below:</p><pre><code class=language-js>const errorHandler = (error, request, reply) =&gt; {
  const statusCode = error.statusCode
  let response

  const { validation, validationContext } = error

  // check if we have a validation error
  if (validation) {
    response = {
      // validationContext will be &#39;body&#39; or &#39;params&#39; or &#39;headers&#39; or &#39;query&#39;
      message: `A validation error occurred when validating the ${validationContext}...`,
      // this is the result of your validation library...
      errors: validation
    }
  } else {
    response = {
      message: &#39;An error occurred...&#39;
    }
  }

  // any additional work here, eg. log error
  // ...

  reply.status(statusCode).send(response)
}
</code></pre><p><a name=serialization></a></p><h3 id=serialization>Serialization</h3><p>Usually you will send your data to the clients as JSON, and Fastify has a powerful tool to help you, <a href=https://www.npmjs.com/package/fast-json-stringify>fast-json-stringify</a>, which is used if you have provided an output schema in the route options. We encourage you to use an output schema, as it can drastically increase throughput and help prevent accidental disclosure of sensitive information.</p><p>Example:</p><pre><code class=language-js>const schema = {
  response: {
    200: {
      type: &#39;object&#39;,
      properties: {
        value: { type: &#39;string&#39; },
        otherValue: { type: &#39;boolean&#39; }
      }
    }
  }
}

fastify.post(&#39;/the/url&#39;, { schema }, handler)
</code></pre><p>As you can see, the response schema is based on the status code. If you want to use the same schema for multiple status codes, you can use <code>&#39;2xx&#39;</code>, for example:</p><pre><code class=language-js>const schema = {
  response: {
    &#39;2xx&#39;: {
      type: &#39;object&#39;,
      properties: {
        value: { type: &#39;string&#39; },
        otherValue: { type: &#39;boolean&#39; }
      }
    },
    201: {
      // the contract syntax
      value: { type: &#39;string&#39; }
    }
  }
}

fastify.post(&#39;/the/url&#39;, { schema }, handler)
</code></pre><p><a name=schema-serializer></a></p><h4 id=serializer-compiler>Serializer Compiler</h4><p>The <code>serializerCompiler</code> is a function that returns a function that must return a string from an input object. You must provide a function to serialize every route where you have defined a <code>response</code> JSON Schema.</p><pre><code class=language-js>fastify.setSerializerCompiler(({ schema, method, url, httpStatus }) =&gt; {
  return data =&gt; JSON.stringify(data)
})

fastify.get(&#39;/user&#39;, {
  handler (req, reply) {
    reply.send({ id: 1, name: &#39;Foo&#39;, image: &#39;BIG IMAGE&#39; })
  },
  schema: {
    response: {
      &#39;2xx&#39;: {
        id: { type: &#39;number&#39; },
        name: { type: &#39;string&#39; }
      }
    }
  }
})
</code></pre><p><em>If you need a custom serializer in a very specific part of your code, you can set one with <a href=/docs/v3.6.x/Reply#serializerfunc><code>reply.serializer(...)</code></a>.</em></p><h3 id=error-handling>Error Handling</h3><p>When schema validation fails for a request, Fastify will automatically return a status 400 response including the result from the validator in the payload. As an example, if you have the following schema for your route</p><pre><code class=language-js>const schema = {
  body: {
    type: &#39;object&#39;,
    properties: {
      name: { type: &#39;string&#39; }
    },
    required: [&#39;name&#39;]
  }
}
</code></pre><p>and fail to satisfy it, the route will immediately return a response with the following payload</p><pre><code class=language-js>{ 
  &quot;statusCode&quot;: 400,
  &quot;error&quot;: &quot;Bad Request&quot;,
  &quot;message&quot;: &quot;body should have required property &#39;name&#39;&quot; 
}
</code></pre><p>If you want to handle errors inside the route, you can specify the <code>attachValidation</code> option for your route. If there is a <em>validation error</em>, the <code>validationError</code> property of the request will contain the <code>Error</code> object with the raw <code>validation</code> result as shown below</p><pre><code class=language-js>const fastify = Fastify()

fastify.post(&#39;/&#39;, { schema, attachValidation: true }, function (req, reply) {
  if (req.validationError) {
    // `req.validationError.validation` contains the raw validation error
    reply.code(400).send(req.validationError)
  }
})
</code></pre><p>If you want to format errors yourself, you can provide a sync function that must return an error as the <code>schemaErrorFormatter</code> option to Fastify when instantiating.</p><p><code>errors</code> is an array of Fastify schema errors <code>FastifySchemaValidationError</code>. <code>dataVar</code> is the currently validated part of the schema. (params | body | querystring | headers).</p><pre><code class=language-js>const fastify = Fastify({
  schemaErrorFormatter: (errors, dataVar) =&gt; {
    // ... my formatting logic 
    return new Error(myErrorMessage)
  }
})
</code></pre><p>You can also use <a href=https://www.fastify.io/docs/latest/Server/#seterrorhandler>setErrorHandler</a> to define a custom response for validation errors such as</p><pre><code class=language-js>fastify.setErrorHandler(function (error, request, reply) {
  if (error.validation) {
     reply.status(422).send(new Error(&#39;validation failed&#39;))
  }
})
</code></pre><p>If you want custom error response in schema without headaches and quickly, you can take a look at <a href=https://github.com/epoberezkin/ajv-errors><code>ajv-errors</code></a>. Checkout the <a href=https://github.com/fastify/example/blob/master/validation-messages/custom-errors-messages.js>example</a> usage.</p><p>Below is an example showing how to add <strong>custom error messages for each property</strong> of a schema by supplying custom AJV options. Inline comments in the schema below describe how to configure it to show a different error message for each case:</p><pre><code class=language-js>const fastify = Fastify({
  ajv: {
    customOptions: { jsonPointers: true },
    plugins: [
      require(&#39;ajv-errors&#39;)
    ]
  }
})

const schema = {
  body: {
    type: &#39;object&#39;,
    properties: {
      name: {
        type: &#39;string&#39;,
        errorMessage: {
          type: &#39;Bad name&#39;
        }
      },
      age: {
        type: &#39;number&#39;,
        errorMessage: {
          type: &#39;Bad age&#39;, // specify custom message for
          min: &#39;Too young&#39; // all constraints except required
        }
      }
    },
    required: [&#39;name&#39;, &#39;age&#39;],
    errorMessage: {
      required: {
        name: &#39;Why no name!&#39;, // specify error message for when the
        age: &#39;Why no age!&#39; // property is missing from input
      }
    }
  }
}

fastify.post(&#39;/&#39;, { schema, }, (request, reply) =&gt; {
  reply.send({
    hello: &#39;world&#39;
  })
})
</code></pre><p>If you want to return localized error messages, take a look at <a href=https://github.com/epoberezkin/ajv-i18n>ajv-i18n</a></p><pre><code class=language-js>const localize = require(&#39;ajv-i18n&#39;)

const fastify = Fastify()

const schema = {
  body: {
    type: &#39;object&#39;,
    properties: {
      name: {
        type: &#39;string&#39;,
      },
      age: {
        type: &#39;number&#39;,
      }
    },
    required: [&#39;name&#39;, &#39;age&#39;],
  }
}

fastify.setErrorHandler(function (error, request, reply) {
  if (error.validation) {
    localize.ru(error.validation)
    reply.status(400).send(error.validation)
    return
  }
  reply.send(error)
})
</code></pre><h3 id=json-schema-support>JSON Schema support</h3><p>JSON Schema has some type of utilities in order to optimize your schemas that, in conjunction with the Fastify&#39;s shared schema, let you reuse all your schemas easily.</p><table><thead><tr><th>Use Case</th><th>Validator</th><th>Serializer</th></tr></thead><tbody><tr><td><code>$ref</code> to <code>$id</code></td><td>️️✔️</td><td>✔️</td></tr><tr><td><code>$ref</code> to <code>/definitions</code></td><td>✔️</td><td>✔️</td></tr><tr><td><code>$ref</code> to shared schema <code>$id</code></td><td>✔️</td><td>✔️</td></tr><tr><td><code>$ref</code> to shared schema <code>/definitions</code></td><td>✔️</td><td>✔️</td></tr></tbody></table><h4 id=examples>Examples</h4><h5 id=usage-of-ref-to-id-in-same-json-schema>Usage of <code>$ref</code> to <code>$id</code> in same JSON Schema</h5><pre><code class=language-js>const refToId = {
  type: &#39;object&#39;,
  definitions: {
    foo: {
      $id: &#39;#address&#39;,
      type: &#39;object&#39;,
      properties: {
        city: { type: &#39;string&#39; }
      }
    }
  },
  properties: {
    home: { $ref: &#39;#address&#39; },
    work: { $ref: &#39;#address&#39; }
  }
}
</code></pre><h5 id=usage-of-ref-to-definitions-in-same-json-schema>Usage of <code>$ref</code> to <code>/definitions</code> in same JSON Schema</h5><pre><code class=language-js>const refToDefinitions = {
  type: &#39;object&#39;,
  definitions: {
    foo: {
      $id: &#39;#address&#39;,
      type: &#39;object&#39;,
      properties: {
        city: { type: &#39;string&#39; }
      }
    }
  },
  properties: {
    home: { $ref: &#39;#/definitions/foo&#39; },
    work: { $ref: &#39;#/definitions/foo&#39; }
  }
}
</code></pre><h5 id=usage-ref-to-a-shared-schema-id-as-external-schema>Usage <code>$ref</code> to a shared schema <code>$id</code> as external schema</h5><pre><code class=language-js>fastify.addSchema({
  $id: &#39;http://foo/common.json&#39;,
  type: &#39;object&#39;,
  definitions: {
    foo: {
      $id: &#39;#address&#39;,
      type: &#39;object&#39;,
      properties: {
        city: { type: &#39;string&#39; }
      }
    }
  }
})

const refToSharedSchemaId = {
  type: &#39;object&#39;,
  properties: {
    home: { $ref: &#39;http://foo/common.json#address&#39; },
    work: { $ref: &#39;http://foo/common.json#address&#39; }
  }
}
</code></pre><h5 id=usage-ref-to-a-shared-schema-definitions-as-external-schema>Usage <code>$ref</code> to a shared schema <code>/definitions</code> as external schema</h5><pre><code class=language-js>fastify.addSchema({
  $id: &#39;http://foo/shared.json&#39;,
  type: &#39;object&#39;,
  definitions: {
    foo: {
      type: &#39;object&#39;,
      properties: {
        city: { type: &#39;string&#39; }
      }
    }
  }
})

const refToSharedSchemaDefinitions = {
  type: &#39;object&#39;,
  properties: {
    home: { $ref: &#39;http://foo/shared.json#/definitions/foo&#39; },
    work: { $ref: &#39;http://foo/shared.json#/definitions/foo&#39; }
  }
}
</code></pre><p><a name=resources></a></p><h3 id=resources>Resources</h3><ul><li><a href=http://json-schema.org/ >JSON Schema</a></li><li><a href=https://spacetelescope.github.io/understanding-json-schema/ >Understanding JSON Schema</a></li><li><a href=https://github.com/fastify/fast-json-stringify>fast-json-stringify documentation</a></li><li><a href=https://github.com/epoberezkin/ajv/blob/master/README.md>Ajv documentation</a></li><li><a href=https://github.com/epoberezkin/ajv-i18n>Ajv i18n</a></li><li><a href=https://github.com/epoberezkin/ajv-errors>Ajv custom errors</a></li><li>Custom error handling with core methods with error file dumping <a href=https://github.com/fastify/example/tree/master/validation-messages>example</a></li></ul></div><hr><nav class=level></nav></div></div></div></section><script>// dynamically creates a submenu for the current section based on the content headers
  var titles = document.querySelectorAll('#doc-content h3, #doc-content h4')
  var currentMenu = document.getElementById('doc-menu-section')
  if (titles.length && currentMenu) {
    var submenu = document.createElement('ul')
    titles.forEach(el => {
      var currentSubmenuItem = document.createElement('li')
      var currentSubmenuLink = document.createElement('a')
      currentSubmenuLink.href = '#' + el.id
      currentSubmenuLink.title = el.textContent
      currentSubmenuLink.append(document.createTextNode(el.textContent))
      currentSubmenuItem.append(currentSubmenuLink)
      submenu.append(currentSubmenuItem)
    })
    currentMenu.append(submenu)
  }

  // dynamically creates header anchor links
  var headers = document.querySelectorAll('#doc-content h3, #doc-content h4')
  headers.forEach(el => {
    var currentAnchorLink = document.createElement('a')
    currentAnchorLink.className = 'anchor'
    currentAnchorLink.href = "#" + el.id
    currentAnchorLink.append(document.createTextNode('¶'))
    el.insertBefore(currentAnchorLink, el.firstChild);
  })</script></main><footer class="grey is-primary footer"><div class=container><div class="content has-text-centered"><p>Fastify, Copyright &copy; 2016-2021 <a href=https://openjsf.org/ target=_blank rel=noopener>OpenJS Foundation</a> and <a href=https://github.com/fastify/fastify#team target=_blank rel=noopener>The Fastify team</a>, Licensed under <a href=https://github.com/fastify/fastify/blob/master/LICENSE target=_blank rel=noopener>MIT</a></p><p><small>Icons by simpleicons.org</small></p></div></div></footer><script src=/js/main.97eeabf1df4ff87e.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js integrity="sha512-s+tOYYcC3Jybgr9mVsdAxsRYlGNq4mlAurOrfNuGMQ/SCofNPu92tjE7YRZCsdEtWL1yGkqk15fU/ark206YTg==" crossorigin=anonymous></script><script>hljs.highlightAll();</script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js></script><script type=text/javascript>docsearch({
        apiKey: 'f7c62ddab40e653f67a6e15be761d951',
        indexName: 'fastify',
        inputSelector: '#algolia-search-input',
        algoliaOptions: { 'facetFilters': ["version:latest", "tags:docs"] },
        debug: false // Set debug to true if you want to inspect the dropdown
      });</script></body></html>