<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Hooks</title>
  <meta name="description" content="Fast and low overhead web framework, for Node.js">

  <link rel="apple-touch-icon" sizes="57x57" href="/images/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/images/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/images/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/images/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.5.1/css/bulma.min.css" integrity="sha256-CDVQJfU+jJGU/oyDzvnzuGXbv0rz+SyBsPQwyn7x/jQ=" crossorigin="anonymous" />
  <link rel="stylesheet" href="/css/style.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" integrity="sha256-Zd1icfZ72UBmsId/mUcagrmN7IN5Qkrvh75ICHIQVTk=" crossorigin="anonymous" />

  

  
</head>


  <body>
    <nav id="main-navbar" class="navbar">
  <div class="navbar-brand">
    <a class="navbar-item" href="/">
      <img src="/images/fastify-logo-menu.png" alt="Fastify: Fast and low overhead web framework, for Node.js" height="28">
    </a>

    <a class="navbar-item is-hidden-desktop" href="https://github.com/fastify/fastify" target="_blank">
      <span class="icon" style="color: #333;">
        <i class="fa fa-github"></i>
      </span>
    </a>

    <div class="navbar-burger burger" data-target="mobileMenu">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>

  <div class="navbar-menu" id="mobileMenu">
    <div class="navbar-start">
      <a class="navbar-item " href="/">Home</a>
      <a class="navbar-item " href="/docs/latest">Docs</a>
      <a class="navbar-item " href="/ecosystem">Ecosystem</a>
      <a class="navbar-item " href="/benchmarks">Benchmarks</a>
    </div>

    <div class="navbar-end">
      <a class="navbar-item" href="https://github.com/fastify/fastify" target="_blank">
        <span class="fa fa-github"> </span>&nbsp;Github
      </a>
    </div>
  </div>
</nav>


    <main class="page-content" aria-label="Content">
      
<section class="hero is-primary" style="background-image: url('/images/bg-pattern-bright.png')">
  <div class="hero-body">
      <div class="container">
        <h1 class="title">
          Documentation
        </h1>
      </div>
  </div>
</section>

<div class="container">
  <section class="section">
    <div class="columns">

      <div class="column is-3 is-hidden-mobile" data-sticky-container>
        <aside class="menu sticky">
          <p class="menu-label">
            Table of contents
          </p>
          <ul class="menu-list">
            
              <li >
                <a  href="/docs/master/Getting-Started">Getting Started</a>
              </li>
            
              <li >
                <a  href="/docs/master/Server-Methods">Server Methods</a>
              </li>
            
              <li >
                <a  href="/docs/master/Routes">Routes</a>
              </li>
            
              <li >
                <a  href="/docs/master/Logging">Logging</a>
              </li>
            
              <li >
                <a  href="/docs/master/Middlewares">Middlewares</a>
              </li>
            
              <li id="doc-menu-section">
                <a class="is-active" href="/docs/master/Hooks">Hooks</a>
              </li>
            
              <li >
                <a  href="/docs/master/Decorators">Decorators</a>
              </li>
            
              <li >
                <a  href="/docs/master/Validation-and-Serialization">Validation and Serialization</a>
              </li>
            
              <li >
                <a  href="/docs/master/Lifecycle">Lifecycle</a>
              </li>
            
              <li >
                <a  href="/docs/master/Reply">Reply</a>
              </li>
            
              <li >
                <a  href="/docs/master/Request">Request</a>
              </li>
            
              <li >
                <a  href="/docs/master/ContentTypeParser">Content Type Parser</a>
              </li>
            
              <li >
                <a  href="/docs/master/Plugins">Plugins</a>
              </li>
            
              <li >
                <a  href="/docs/master/Testing">Testing</a>
              </li>
            
              <li >
                <a  href="/docs/master/Benchmarking">Benchmarking</a>
              </li>
            
              <li >
                <a  href="/docs/master/Plugins-Guide">Plugins Guide</a>
              </li>
            
              <li >
                <a  href="/docs/master/HTTP2">HTTP2</a>
              </li>
            
          </ul>
          <div class="content" style="margin: .8em; border-top: 1px solid #ccc; padding: .8em 0 0 0">
            Docs version
            <div class="field">
              <div class="control">
                <div class="select">
                  <select onchange="if (this.value) window.location.href=this.value">
                    
                      
                        
                        
                          <option selected="selected" value="/docs/master">master</option>
                      
                    
                      
                        
                        
                          
                        
                          <option  value="/docs/v0.39.x">v0.39.x</option>
                      
                    
                      
                        
                        
                          <option  value="/docs/v0.38.x">v0.38.x</option>
                      
                    
                      
                        
                        
                          <option  value="/docs/v0.37.x">v0.37.x</option>
                      
                    
                      
                        
                        
                          <option  value="/docs/v0.36.x">v0.36.x</option>
                      
                    
                      
                        
                        
                          <option  value="/docs/v0.35.x">v0.35.x</option>
                      
                    
                      
                        
                        
                          <option  value="/docs/v0.34.x">v0.34.x</option>
                      
                    
                      
                        
                        
                          <option  value="/docs/v0.33.x">v0.33.x</option>
                      
                    
                      
                        
                        
                          <option  value="/docs/v0.32.x">v0.32.x</option>
                      
                    
                      
                        
                        
                          <option  value="/docs/v0.31.x">v0.31.x</option>
                      
                    
                      
                        
                        
                          <option  value="/docs/v0.30.x">v0.30.x</option>
                      
                    
                      
                        
                        
                          <option  value="/docs/v0.29.x">v0.29.x</option>
                      
                    
                      
                        
                        
                          <option  value="/docs/v0.28.x">v0.28.x</option>
                      
                    
                      
                        
                        
                          <option  value="/docs/v0.27.x">v0.27.x</option>
                      
                    
                      
                        
                        
                          <option  value="/docs/v0.26.x">v0.26.x</option>
                      
                    
                      
                    
                  </select>
                </div>
              </div>
            </div>
          </div>
        </aside>
      </div>

      <div class="column">
        <nav class="breadcrumb">
          <ul>
            <li><a href="/" style="padding-left: 0">Fastify</a></li>
            <li><a href="/docs/">Documentation</a></li>
            <li>
              <div class="field">
                <div class="control">
                  <div class="select">
                    <select onchange="if (this.value) window.location.href=this.value" style="border: none;">
                      
                        
                          
                          <option selected="selected" value="/docs/master">master</option>
                        
                      
                        
                          
                          <option  value="/docs/v0.39.x">v0.39.x</option>
                        
                      
                        
                          
                          <option  value="/docs/v0.38.x">v0.38.x</option>
                        
                      
                        
                          
                          <option  value="/docs/v0.37.x">v0.37.x</option>
                        
                      
                        
                          
                          <option  value="/docs/v0.36.x">v0.36.x</option>
                        
                      
                        
                          
                          <option  value="/docs/v0.35.x">v0.35.x</option>
                        
                      
                        
                          
                          <option  value="/docs/v0.34.x">v0.34.x</option>
                        
                      
                        
                          
                          <option  value="/docs/v0.33.x">v0.33.x</option>
                        
                      
                        
                          
                          <option  value="/docs/v0.32.x">v0.32.x</option>
                        
                      
                        
                          
                          <option  value="/docs/v0.31.x">v0.31.x</option>
                        
                      
                        
                          
                          <option  value="/docs/v0.30.x">v0.30.x</option>
                        
                      
                        
                          
                          <option  value="/docs/v0.29.x">v0.29.x</option>
                        
                      
                        
                          
                          <option  value="/docs/v0.28.x">v0.28.x</option>
                        
                      
                        
                          
                          <option  value="/docs/v0.27.x">v0.27.x</option>
                        
                      
                        
                          
                          <option  value="/docs/v0.26.x">v0.26.x</option>
                        
                      
                        
                      
                    </select>
                  </div>
                </div>
              </div>
            </li>
            <li class="is-active"><a>Hooks</a></li>
          </ul>
        </nav>

        <div id="doc-content" class="content">
          <h2 id="hooks">Hooks</h2>
<p>Hooks are registered with the <code>fastify.addHook</code> method and allow you to listen to specific events in the application or request/response lifecycle. You have to register a hook before the event is triggered otherwise the event is lost.</p>
<h2 id="request-response-hooks">Request/Response Hooks</h2>
<p>By using the hooks you can interact directly inside the lifecycle of Fastify. There are five different Hooks that you can use <em>(in order of execution)</em>:</p>
<ul>
<li><code>&#39;onRequest&#39;</code></li>
<li><code>&#39;preHandler&#39;</code></li>
<li><code>&#39;onSend&#39;</code></li>
<li><code>&#39;onResponse&#39;</code></li>
</ul>
<p>Example:</p>
<pre><code class="lang-js">fastify.addHook(&#39;onRequest&#39;, (req, res, next) =&gt; {
  // some code
  next()
})

fastify.addHook(&#39;preHandler&#39;, (request, reply, next) =&gt; {
  // some code
  next()
})

fastify.addHook(&#39;onSend&#39;, (request, reply, payload, next) =&gt; {
  // some code
  next()
})

fastify.addHook(&#39;onResponse&#39;, (res, next) =&gt; {
  // some code
  next()
})
</code></pre>
<p>Or <code>async/await</code></p>
<pre><code class="lang-js">fastify.addHook(&#39;onRequest&#39;, async (req, res) =&gt; {
  // some code
  await asyncMethod()
  // error occurred
  if (err) {
    throw new Error(&#39;some errors occurred.&#39;)
  }
  return
})

fastify.addHook(&#39;preHandler&#39;, async (request, reply) =&gt; {
  // some code
  await asyncMethod()
  // error occurred
  if (err) {
    throw new Error(&#39;some errors occurred.&#39;)
  }
  return
})

fastify.addHook(&#39;onSend&#39;, async (request, reply, payload) =&gt; {
  // some code
  await asyncMethod()
  // error occurred
  if (err) {
    throw new Error(&#39;some errors occurred.&#39;)
  }
  return
})

fastify.addHook(&#39;onResponse&#39;, async (res) =&gt; {
  // some code
  await asyncMethod()
  // error occurred
  if (err) {
    throw new Error(&#39;some errors occurred.&#39;)
  }
  return
})
</code></pre>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>req</td>
<td>Node.js <a href="https://nodejs.org/api/http.html#http_class_http_incomingmessage">IncomingMessage</a></td>
</tr>
<tr>
<td>res</td>
<td>Node.js <a href="https://nodejs.org/api/http.html#http_class_http_serverresponse">ServerResponse</a></td>
</tr>
<tr>
<td>request</td>
<td>Fastify <a href="/docs/master/Request">Request</a> interface</td>
</tr>
<tr>
<td>reply</td>
<td>Fastify <a href="/docs/master/Reply">Reply</a> interface</td>
</tr>
<tr>
<td>next</td>
<td>Function to continue with the <a href="/docs/master/Lifecycle">lifecycle</a></td>
</tr>
</tbody>
</table>
<p>It is pretty easy to understand where each hook is executed by looking at the <a href="/docs/master/Lifecycle">lifecycle page</a>.<br>
Hooks are affected by Fastify&#39;s encapsulation, and can thus be applied to selected routes. See the <a href="#scope">Scopes</a> section for more information.</p>
<p>If you get an error during the execution of you hook, just pass it to <code>next()</code> and Fastify will automatically close the request and send the appropriate error code to the user.</p>
<pre><code class="lang-js">fastify.addHook(&#39;onRequest&#39;, (req, res, next) =&gt; {
  next(new Error(&#39;some error&#39;))
})
</code></pre>
<p>If you want to pass a custom error code to the user, just use <code>reply.code()</code>:</p>
<pre><code class="lang-js">fastify.addHook(&#39;preHandler&#39;, (request, reply, next) =&gt; {
  reply.code(500)
  next(new Error(&#39;some error&#39;))
})
</code></pre>
<p><em>The error will be handled by <a href="/docs/master/Reply#errors"><code>Reply</code></a>.</em></p>
<p>Note that in the <code>&#39;preHandler&#39;</code> and <code>&#39;onSend&#39;</code> hook the request and reply objects are different from <code>&#39;onRequest&#39;</code>, because the two arguments are <a href="/docs/master/Request"><code>request</code></a> and <a href="/docs/master/Reply"><code>reply</code></a> core Fastify objects.</p>
<p>If you are using the <code>onSend</code> hook you can update the payload, for example:</p>
<pre><code class="lang-js">
fastify.addHook(&#39;onSend&#39;, (request, reply, payload, next) =&gt; {
  var err = null;
  payload.hello = &#39;world&#39;
  next(err, payload)
})

// Or
fastify.addHook(&#39;onSend&#39;, (request, reply, payload, next) =&gt; {
  var err = null;
  var newPayload = payload.replace(&#39;some-text&#39;, &#39;some-new-text&#39;)
  next(err, newPayload)
})
</code></pre>
<h2 id="application-hooks">Application Hooks</h2>
<p>You are able to hook into the application-lifecycle as well. It&#39;s important to note that these hooks aren&#39;t fully encapsulated. The <code>this</code> inside the hooks are encapsulated but the handlers can respond to an event outside the encapsulation boundaries.</p>
<ul>
<li><code>&#39;onClose&#39;</code></li>
<li><code>&#39;onRoute&#39;</code></li>
</ul>
<p><a name="on-close"></a>
<strong>&#39;onClose&#39;</strong><br>
Triggered when <code>fastify.close()</code> is invoked to stop the server. It is useful when <a href="/docs/master/Plugins">plugins</a> need a &quot;shutdown&quot; event, such as a connection to a database.<br>
The first argument is the Fastify instance, the second one the <code>done</code> callback.</p>
<pre><code class="lang-js">fastify.addHook(&#39;onClose&#39;, (instance, done) =&gt; {
  // some code
  done()
})
</code></pre>
<p><a name="on-route"></a>
<strong>&#39;onRoute&#39;</strong><br>
Triggered when a new route is registered. Listeners are passed a <code>routeOptions</code> object as the sole parameter. The interface is synchronous, and, as such, the listeners do not get passed a callback.</p>
<pre><code class="lang-js">fastify.addHook(&#39;onRoute&#39;, (routeOptions) =&gt; {
  // some code
  routeOptions.method
  routeOptions.schema
  routeOptions.url
  routeOptions.jsonBodyLimit
  routeOptions.logLevel
  routeOptions.prefix
})
</code></pre>
<p><a name="scope"></a></p>
<h3 id="scope">Scope</h3>
<p>Except for <a href="#application-hooks">Application Hooks</a>, all hooks are encapsulated. This means that you can decide where your hooks should run by using <code>register</code> as explained in the <a href="/docs/master/Plugins-Guide">plugins guide</a>. If you pass a function, that function is bound to the right Fastify context and from there you have full access to the Fastify API.</p>
<pre><code class="lang-js">fastify.addHook(&#39;onRequest&#39;, function (req, res, next) {
  const self = this // Fastify context
  next()
})
</code></pre>
<p>Note: using an arrow function will break the binding of this to the Fastify instance.</p>
<p><a name="before-handler"></a></p>
<h3 id="beforehandler">beforeHandler</h3>
<p>Despite the name, <code>beforeHandler</code> is not a standard hook like <code>preHandler</code>, but is a function that your register right in the route option that will be executed only in the specified route. Can be useful if you need to handle the authentication at route level instead of at hook level (<code>preHandler</code> for example.), it could also be an array of functions.<br>
<strong><code>beforeHandler</code> is executed always after the <code>preHandler</code> hook.</strong></p>
<pre><code class="lang-js">fastify.addHook(&#39;preHandler&#39;, (request, reply, done) =&gt; {
  // your code
  done()
})

fastify.route({
  method: &#39;GET&#39;,
  url: &#39;/&#39;,
  schema: { ... },
  beforeHandler: function (request, reply, done) {
    // your code
    done()
  },
  handler: function (request, reply) {
    reply.send({ hello: &#39;world&#39; })
  }
})

fastify.route({
  method: &#39;GET&#39;,
  url: &#39;/&#39;,
  schema: { ... },
  beforeHandler: [
    function first (request, reply, done) {
      // your code
      done()
    },
    function second (request, reply, done) {
      // your code
      done()
    }
  ],
  handler: function (request, reply) {
    reply.send({ hello: &#39;world&#39; })
  }
})
</code></pre>

        </div>

        <hr/>
        <nav class="level">
        
          
        
          
        
          
        
          
        
          
        
          
            <div class="level-left">
              <div class="level-item">
                
                  
                  
                  <a href="/docs/master/Middlewares" class="button prev">≪ Middlewares</a>
                
              </div>
            </div>
            <div class="level-right">
              <div class="level-item">
                
                  
                  
                  <a href="/docs/master/Decorators" class="button next">Decorators ≫</a>
                
              </div>
            </div>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        </nav>
      </div>
    </div>
  </section>

  <script>
    // dynamically creates a submenu for the current section based on the content headers
    var titles = document.querySelectorAll('#doc-content h3')
    var currentMenu = document.getElementById('doc-menu-section')
    if (titles.length && currentMenu) {
      var submenu = document.createElement('ul')
      titles.forEach(el => {
        var currentSubmenuItem = document.createElement('li')
        var currentSubmenuLink = document.createElement('a')
        currentSubmenuLink.href = '#' + el.id
        currentSubmenuLink.append(document.createTextNode(el.textContent))
        currentSubmenuItem.append(currentSubmenuLink)
        submenu.append(currentSubmenuItem)
      })
      currentMenu.append(submenu)
    }
  </script>
</div>

    </main>

    <footer class="grey is-primary footer">
  <div class="container">
    <div class="content has-text-centered">
    
      <p><em>Found a typo or want to improve this page?</em> <a href="https://github.com/fastify/fastify/blob/master/docs/Hooks.md">Submit a PR on GitHub</a></p>
    
      <p>Fastify, Copyright &copy; 2016-2017 Matteo Collina and the <a href="https://github.com/fastify/fastify#team" target="_blank">Fastify team</a>, Licensed under <a href="https://github.com/fastify/fastify/blob/master/LICENSE" target="_blank">MIT</a></p>
    </div>
  </div>
</footer>


    <script src="/js/main.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    
  </body>

</html>
