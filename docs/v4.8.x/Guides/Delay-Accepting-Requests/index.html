<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Delay-Accepting-Requests</title><meta name=description content="Fast and low overhead web framework, for Node.js"><link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.ed24c0a19503e080.png><link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.60c285c424d50738.png><link rel=apple-touch-icon sizes=72x72 href=/images/apple-icon-72x72.e49b27cfe1ab1461.png><link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.752f43fc91b8c1f7.png><link rel=apple-touch-icon sizes=114x114 href=/images/apple-icon-114x114.61739fa1d5a7059a.png><link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.7c25de37c5ce2ec1.png><link rel=apple-touch-icon sizes=144x144 href=/images/apple-icon-144x144.04d88fb27bd92cbe.png><link rel=apple-touch-icon sizes=152x152 href=/images/apple-icon-152x152.9364781175671626.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-icon-180x180.67579100928bfcd2.png><link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.37eb7f1ae3853740.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.1e22f0e774bc3cce.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.7e8a68b1b80c1799.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.e534ce05cb727f1a.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content=#ffffff><meta name=msapplication-TileImage content=/images/ms-icon-144x144.png><meta name=theme-color content=#ffffff><meta property=og:url content=https://www.fastify.io/docs/v4.8.x/Guides/Delay-Accepting-Requests><meta property=og:type content=website><meta property=og:title content=Delay-Accepting-Requests><meta property=og:description content="Fast and low overhead web framework, for Node.js"><meta property=og:image content=https://www.fastify.io/images/fastify-fb-share-image.07b6e6860853c758.png><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@fastifyjs><meta name=twitter:creator content=@fastifyjs><meta name=twitter:title content=Delay-Accepting-Requests><meta name=twitter:description content="Fast and low overhead web framework, for Node.js"><meta name=twitter:image content=https://www.fastify.io/images/fastify-twitter-share-image.cd9f217b360af3e2.png><link rel=stylesheet href=/css/style.f4d6592b3a91c5ef.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css integrity="sha512-kZqGbhf9JTB4bVJ0G8HCkqmaPcRgo88F0dneK30yku5Y/dep7CZfCnNml2Je/sY4lBoqoksXz4PtVXS4GHSUzQ==" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@alpha><meta name=robots content="noindex, nofollow"></head><body><nav id=main-navbar class=navbar><div class=navbar-brand><a class=navbar-item href=/ ><img src=/images/fastify-logo-menu.d13f8da7a965c800.png alt="Fastify: Fast and low overhead web framework, for Node.js" height=28 decoding=async> </a><a class="navbar-item is-hidden-desktop" href=https://github.com/fastify/fastify target=_blank rel=noopener><span class=icon style="color: #333;"><i class="fa fa-github"></i></span></a><div class="navbar-burger burger" data-target=mobileMenu><span></span> <span></span> <span></span></div></div><div class=navbar-menu id=mobileMenu><div class=navbar-start><a class=navbar-item href=/ >Home</a> <a class=navbar-item href=/docs/latest>Docs</a> <a class=navbar-item href=/ecosystem>Ecosystem</a> <a class=navbar-item href=/benchmarks>Benchmarks</a> <a class=navbar-item href=/contribute>Contribute</a> <a class=navbar-item href=https://medium.com/@fastifyjs/ >Blog</a> <a class=navbar-item href=https://github.com/fastify/help>Help</a></div><div class=navbar-end><span id=algolia-search-input class="control has-icons-left navbar-item"></span> <a class=navbar-item href=https://github.com/fastify/fastify target=_blank rel=noopener><span class="fa fa-github"></span>&nbsp;GitHub </a><a class=navbar-item href=https://twitter.com/fastifyjs target=_blank rel=noopener><span class="fa fa-twitter"></span>&nbsp;Twitter </a><a class=navbar-item rel=me href=https://fosstodon.org/@fastify target=_blank><span class="fa fa-hashtag"></span>&nbsp;Mastodon</a></div></div></nav><main class=page-content aria-label=Content><section class="hero is-primary" style="background-image: url(/images/bg-pattern-dark.3f8cda863b3bbf52.png)"><div class=hero-body><div class=container><h1 class=title>Documentation (v4.8.1)</h1></div></div></section><section class=section><div class=container><div class=columns><div class="column is-3 is-hidden-mobile sticky-container"><aside class="menu sticky" id=toc><ul class=menu-list></ul><p class=menu-label><a href=/docs/v4.8.x/Guides>Guides</a></p><ul class=menu-list><li style="text-transform: capitalize"><a title=Benchmarking href=/docs/v4.8.x/Guides/Benchmarking>Benchmarking</a></li><li style="text-transform: capitalize"><a title=Contributing href=/docs/v4.8.x/Guides/Contributing>Contributing</a></li><li style="text-transform: capitalize"><a title=Database href=/docs/v4.8.x/Guides/Database>Database</a></li><li style="text-transform: capitalize" id=doc-menu-section><a title=Delay-Accepting-Requests class=is-active href=/docs/v4.8.x/Guides/Delay-Accepting-Requests>Delay-Accepting-Requests</a></li><li style="text-transform: capitalize"><a title=Ecosystem href=/docs/v4.8.x/Guides/Ecosystem>Ecosystem</a></li><li style="text-transform: capitalize"><a title=Fluent-Schema href=/docs/v4.8.x/Guides/Fluent-Schema>Fluent-Schema</a></li><li style="text-transform: capitalize"><a title=Getting-Started href=/docs/v4.8.x/Guides/Getting-Started>Getting-Started</a></li><li style="text-transform: capitalize"><a title=Migration-Guide-V3 href=/docs/v4.8.x/Guides/Migration-Guide-V3>Migration-Guide-V3</a></li><li style="text-transform: capitalize"><a title=Migration-Guide-V4 href=/docs/v4.8.x/Guides/Migration-Guide-V4>Migration-Guide-V4</a></li><li style="text-transform: capitalize"><a title=Plugins-Guide href=/docs/v4.8.x/Guides/Plugins-Guide>Plugins-Guide</a></li><li style="text-transform: capitalize"><a title=Prototype-Poisoning href=/docs/v4.8.x/Guides/Prototype-Poisoning>Prototype-Poisoning</a></li><li style="text-transform: capitalize"><a title=Recommendations href=/docs/v4.8.x/Guides/Recommendations>Recommendations</a></li><li style="text-transform: capitalize"><a title=Serverless href=/docs/v4.8.x/Guides/Serverless>Serverless</a></li><li style="text-transform: capitalize"><a title=Style-Guide href=/docs/v4.8.x/Guides/Style-Guide>Style-Guide</a></li><li style="text-transform: capitalize"><a title=Testing href=/docs/v4.8.x/Guides/Testing>Testing</a></li><li style="text-transform: capitalize"><a title=Write-Plugin href=/docs/v4.8.x/Guides/Write-Plugin>Write-Plugin</a></li></ul><p class=menu-label><a href=/docs/v4.8.x/Reference>Reference</a></p><ul class=menu-list><li style="text-transform: capitalize"><a title=ContentTypeParser href=/docs/v4.8.x/Reference/ContentTypeParser>ContentTypeParser</a></li><li style="text-transform: capitalize"><a title=Decorators href=/docs/v4.8.x/Reference/Decorators>Decorators</a></li><li style="text-transform: capitalize"><a title=Encapsulation href=/docs/v4.8.x/Reference/Encapsulation>Encapsulation</a></li><li style="text-transform: capitalize"><a title=Errors href=/docs/v4.8.x/Reference/Errors>Errors</a></li><li style="text-transform: capitalize"><a title=HTTP2 href=/docs/v4.8.x/Reference/HTTP2>HTTP2</a></li><li style="text-transform: capitalize"><a title=Hooks href=/docs/v4.8.x/Reference/Hooks>Hooks</a></li><li style="text-transform: capitalize"><a title=LTS href=/docs/v4.8.x/Reference/LTS>LTS</a></li><li style="text-transform: capitalize"><a title=Lifecycle href=/docs/v4.8.x/Reference/Lifecycle>Lifecycle</a></li><li style="text-transform: capitalize"><a title=Logging href=/docs/v4.8.x/Reference/Logging>Logging</a></li><li style="text-transform: capitalize"><a title=Middleware href=/docs/v4.8.x/Reference/Middleware>Middleware</a></li><li style="text-transform: capitalize"><a title=Plugins href=/docs/v4.8.x/Reference/Plugins>Plugins</a></li><li style="text-transform: capitalize"><a title=Reply href=/docs/v4.8.x/Reference/Reply>Reply</a></li><li style="text-transform: capitalize"><a title=Request href=/docs/v4.8.x/Reference/Request>Request</a></li><li style="text-transform: capitalize"><a title=Routes href=/docs/v4.8.x/Reference/Routes>Routes</a></li><li style="text-transform: capitalize"><a title=Server href=/docs/v4.8.x/Reference/Server>Server</a></li><li style="text-transform: capitalize"><a title=Type-Providers href=/docs/v4.8.x/Reference/Type-Providers>Type-Providers</a></li><li style="text-transform: capitalize"><a title=TypeScript href=/docs/v4.8.x/Reference/TypeScript>TypeScript</a></li><li style="text-transform: capitalize"><a title=Validation-and-Serialization href=/docs/v4.8.x/Reference/Validation-and-Serialization>Validation-and-Serialization</a></li></ul><div class=content style="margin: .8em; border-top: 1px solid #ccc; padding: .8em 0 0 0">Docs version<div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value"><option value=/docs/latest>latest</option><option value=/docs/master>master</option><option value=/docs/v4.18.x>v4.18.x</option><option value=/docs/v4.17.x>v4.17.x</option><option value=/docs/v4.16.x>v4.16.x</option><option value=/docs/v4.15.x>v4.15.x</option><option value=/docs/v4.14.x>v4.14.x</option><option value=/docs/v4.13.x>v4.13.x</option><option value=/docs/v4.12.x>v4.12.x</option><option value=/docs/v4.11.x>v4.11.x</option><option value=/docs/v4.10.x>v4.10.x</option><option value=/docs/v4.9.x>v4.9.x</option><option selected value=/docs/v4.8.x>v4.8.x</option><option value=/docs/v4.7.x>v4.7.x</option><option value=/docs/v4.6.x>v4.6.x</option><option value=/docs/v4.5.x>v4.5.x</option><option value=/docs/v4.4.x>v4.4.x</option><option value=/docs/v4.3.x>v4.3.x</option><option value=/docs/v4.2.x>v4.2.x</option><option value=/docs/v4.1.x>v4.1.x</option><option value=/docs/v4.0.x>v4.0.x</option><option value=/docs/v3.29.x>v3.29.x</option><option value=/docs/v3.28.x>v3.28.x</option><option value=/docs/v3.27.x>v3.27.x</option><option value=/docs/v3.26.x>v3.26.x</option><option value=/docs/v3.25.x>v3.25.x</option><option value=/docs/v3.24.x>v3.24.x</option><option value=/docs/v3.23.x>v3.23.x</option><option value=/docs/v3.22.x>v3.22.x</option><option value=/docs/v3.21.x>v3.21.x</option><option value=/docs/v3.20.x>v3.20.x</option><option value=/docs/v3.19.x>v3.19.x</option><option value=/docs/v3.18.x>v3.18.x</option><option value=/docs/v3.17.x>v3.17.x</option><option value=/docs/v3.16.x>v3.16.x</option><option value=/docs/v3.15.x>v3.15.x</option><option value=/docs/v3.14.x>v3.14.x</option><option value=/docs/v3.13.x>v3.13.x</option><option value=/docs/v3.12.x>v3.12.x</option><option value=/docs/v3.11.x>v3.11.x</option><option value=/docs/v3.10.x>v3.10.x</option><option value=/docs/v3.9.x>v3.9.x</option><option value=/docs/v3.8.x>v3.8.x</option><option value=/docs/v3.7.x>v3.7.x</option><option value=/docs/v3.6.x>v3.6.x</option><option value=/docs/v3.5.x>v3.5.x</option><option value=/docs/v3.4.x>v3.4.x</option><option value=/docs/v3.3.x>v3.3.x</option><option value=/docs/v3.2.x>v3.2.x</option><option value=/docs/v3.1.x>v3.1.x</option><option value=/docs/v3.0.x>v3.0.x</option><option value=/docs/v2.15.x>v2.15.x</option><option value=/docs/v2.14.x>v2.14.x</option><option value=/docs/v2.13.x>v2.13.x</option><option value=/docs/v2.12.x>v2.12.x</option><option value=/docs/v2.11.x>v2.11.x</option><option value=/docs/v2.10.x>v2.10.x</option><option value=/docs/v2.9.x>v2.9.x</option><option value=/docs/v2.8.x>v2.8.x</option><option value=/docs/v2.7.x>v2.7.x</option><option value=/docs/v2.6.x>v2.6.x</option><option value=/docs/v2.5.x>v2.5.x</option><option value=/docs/v2.4.x>v2.4.x</option><option value=/docs/v2.3.x>v2.3.x</option><option value=/docs/v2.2.x>v2.2.x</option><option value=/docs/v2.1.x>v2.1.x</option><option value=/docs/v2.0.x>v2.0.x</option><option value=/docs/v1.14.x>v1.14.x</option><option value=/docs/v1.13.x>v1.13.x</option></select></div></div></div></div></aside></div><div class="column is-9"><nav class=breadcrumb><ul><li><a href=/ style="padding-left: 0">Fastify</a></li><li><a href=/docs/v4.8.x>Documentation</a></li><li><div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value" style="border: none;"><option value=/docs/latest>latest</option><option value=/docs/master>master</option><option value=/docs/v4.18.x>v4.18.x</option><option value=/docs/v4.17.x>v4.17.x</option><option value=/docs/v4.16.x>v4.16.x</option><option value=/docs/v4.15.x>v4.15.x</option><option value=/docs/v4.14.x>v4.14.x</option><option value=/docs/v4.13.x>v4.13.x</option><option value=/docs/v4.12.x>v4.12.x</option><option value=/docs/v4.11.x>v4.11.x</option><option value=/docs/v4.10.x>v4.10.x</option><option value=/docs/v4.9.x>v4.9.x</option><option selected value=/docs/v4.8.x>v4.8.x</option><option value=/docs/v4.7.x>v4.7.x</option><option value=/docs/v4.6.x>v4.6.x</option><option value=/docs/v4.5.x>v4.5.x</option><option value=/docs/v4.4.x>v4.4.x</option><option value=/docs/v4.3.x>v4.3.x</option><option value=/docs/v4.2.x>v4.2.x</option><option value=/docs/v4.1.x>v4.1.x</option><option value=/docs/v4.0.x>v4.0.x</option><option value=/docs/v3.29.x>v3.29.x</option><option value=/docs/v3.28.x>v3.28.x</option><option value=/docs/v3.27.x>v3.27.x</option><option value=/docs/v3.26.x>v3.26.x</option><option value=/docs/v3.25.x>v3.25.x</option><option value=/docs/v3.24.x>v3.24.x</option><option value=/docs/v3.23.x>v3.23.x</option><option value=/docs/v3.22.x>v3.22.x</option><option value=/docs/v3.21.x>v3.21.x</option><option value=/docs/v3.20.x>v3.20.x</option><option value=/docs/v3.19.x>v3.19.x</option><option value=/docs/v3.18.x>v3.18.x</option><option value=/docs/v3.17.x>v3.17.x</option><option value=/docs/v3.16.x>v3.16.x</option><option value=/docs/v3.15.x>v3.15.x</option><option value=/docs/v3.14.x>v3.14.x</option><option value=/docs/v3.13.x>v3.13.x</option><option value=/docs/v3.12.x>v3.12.x</option><option value=/docs/v3.11.x>v3.11.x</option><option value=/docs/v3.10.x>v3.10.x</option><option value=/docs/v3.9.x>v3.9.x</option><option value=/docs/v3.8.x>v3.8.x</option><option value=/docs/v3.7.x>v3.7.x</option><option value=/docs/v3.6.x>v3.6.x</option><option value=/docs/v3.5.x>v3.5.x</option><option value=/docs/v3.4.x>v3.4.x</option><option value=/docs/v3.3.x>v3.3.x</option><option value=/docs/v3.2.x>v3.2.x</option><option value=/docs/v3.1.x>v3.1.x</option><option value=/docs/v3.0.x>v3.0.x</option><option value=/docs/v2.15.x>v2.15.x</option><option value=/docs/v2.14.x>v2.14.x</option><option value=/docs/v2.13.x>v2.13.x</option><option value=/docs/v2.12.x>v2.12.x</option><option value=/docs/v2.11.x>v2.11.x</option><option value=/docs/v2.10.x>v2.10.x</option><option value=/docs/v2.9.x>v2.9.x</option><option value=/docs/v2.8.x>v2.8.x</option><option value=/docs/v2.7.x>v2.7.x</option><option value=/docs/v2.6.x>v2.6.x</option><option value=/docs/v2.5.x>v2.5.x</option><option value=/docs/v2.4.x>v2.4.x</option><option value=/docs/v2.3.x>v2.3.x</option><option value=/docs/v2.2.x>v2.2.x</option><option value=/docs/v2.1.x>v2.1.x</option><option value=/docs/v2.0.x>v2.0.x</option><option value=/docs/v1.14.x>v1.14.x</option><option value=/docs/v1.13.x>v1.13.x</option></select></div></div></div></li><div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value" style="border: none;"><option value=/docs/v4.8.x>Documentation</option><option value=/docs/v4.8.x/Guides>Guides</option><option value=/docs/v4.8.x/Guides/Benchmarking>Benchmarking</option><option value=/docs/v4.8.x/Guides/Contributing>Contributing</option><option value=/docs/v4.8.x/Guides/Database>Database</option><option selected value=/docs/v4.8.x/Guides/Delay-Accepting-Requests>Delay-Accepting-Requests</option><option value=/docs/v4.8.x/Guides/Ecosystem>Ecosystem</option><option value=/docs/v4.8.x/Guides/Fluent-Schema>Fluent-Schema</option><option value=/docs/v4.8.x/Guides/Getting-Started>Getting-Started</option><option value=/docs/v4.8.x/Guides/Migration-Guide-V3>Migration-Guide-V3</option><option value=/docs/v4.8.x/Guides/Migration-Guide-V4>Migration-Guide-V4</option><option value=/docs/v4.8.x/Guides/Plugins-Guide>Plugins-Guide</option><option value=/docs/v4.8.x/Guides/Prototype-Poisoning>Prototype-Poisoning</option><option value=/docs/v4.8.x/Guides/Recommendations>Recommendations</option><option value=/docs/v4.8.x/Guides/Serverless>Serverless</option><option value=/docs/v4.8.x/Guides/Style-Guide>Style-Guide</option><option value=/docs/v4.8.x/Guides/Testing>Testing</option><option value=/docs/v4.8.x/Guides/Write-Plugin>Write-Plugin</option><option value=/docs/v4.8.x/Reference>Reference</option><option value=/docs/v4.8.x/Reference/ContentTypeParser>ContentTypeParser</option><option value=/docs/v4.8.x/Reference/Decorators>Decorators</option><option value=/docs/v4.8.x/Reference/Encapsulation>Encapsulation</option><option value=/docs/v4.8.x/Reference/Errors>Errors</option><option value=/docs/v4.8.x/Reference/HTTP2>HTTP2</option><option value=/docs/v4.8.x/Reference/Hooks>Hooks</option><option value=/docs/v4.8.x/Reference/LTS>LTS</option><option value=/docs/v4.8.x/Reference/Lifecycle>Lifecycle</option><option value=/docs/v4.8.x/Reference/Logging>Logging</option><option value=/docs/v4.8.x/Reference/Middleware>Middleware</option><option value=/docs/v4.8.x/Reference/Plugins>Plugins</option><option value=/docs/v4.8.x/Reference/Reply>Reply</option><option value=/docs/v4.8.x/Reference/Request>Request</option><option value=/docs/v4.8.x/Reference/Routes>Routes</option><option value=/docs/v4.8.x/Reference/Server>Server</option><option value=/docs/v4.8.x/Reference/Type-Providers>Type-Providers</option><option value=/docs/v4.8.x/Reference/TypeScript>TypeScript</option><option value=/docs/v4.8.x/Reference/Validation-and-Serialization>Validation-and-Serialization</option></select></div></div></div></ul></nav><div id=doc-content class=content><h1 id=delay-accepting-requests>Delay Accepting Requests</h1><h2 id=introduction>Introduction</h2><p>Fastify provides several <a href=../../Reference/Hooks>hooks</a> useful for a variety of situations. One of them is the <a href=../../Reference/Hooks#onready><code>onReady</code></a> hook, which is useful for executing tasks <em>right before</em> the server starts accepting new requests. There isn&#39;t, though, a direct mechanism to handle scenarios in which you&#39;d like the server to start accepting <strong>specific</strong> requests and denying all others, at least up to some point.</p><p>Say, for instance, your server needs to authenticate with an OAuth provider to start serving requests. To do that it&#39;d need to engage in the <a href=https://auth0.com/docs/get-started/authentication-and-authorization-flow/authorization-code-flow>OAuth Authorization Code Flow</a>, which would require it to listen to two requests from the authentication provider:</p><ol><li>the Authorization Code webhook</li><li>the tokens webhook</li></ol><p>Until the authorization flow is done you wouldn&#39;t be able to serve customer requests. What to do then?</p><p>There are several solutions for achieving that kind of behavior. Here we&#39;ll introduce one of such techniques and, hopefully, you&#39;ll be able to get things rolling asap!</p><h2 id=solution>Solution</h2><h3 id=overview>Overview</h3><p>The proposed solution is one of many possible ways of dealing with this scenario and many similar to it. It relies solely on Fastify, so no fancy infrastructure tricks or third-party libraries will be necessary.</p><p>To simplify things we won&#39;t be dealing with a precise OAuth flow but, instead, simulate a scenario in which some key is needed to serve a request and that key can only be retrieved in runtime by authenticating with an external provider.</p><p>The main goal here is to deny requests that would otherwise fail <strong>as early as possible</strong> and with some <strong>meaningful context</strong>. That&#39;s both useful for the server (fewer resources allocated to a bound-to-fail task) and for the client (they get some meaningful information and don&#39;t need to wait long for it).</p><p>That will be achieved by wrapping into a custom plugin two main features:</p><ol><li>the mechanism for authenticating with the provider <a href=../../Reference/Decorators>decorating</a> the <code>fastify</code> object with the authentication key (<code>magicKey</code> from here onwards)</li><li>the mechanism for denying requests that would, otherwise, fail</li></ol><h3 id=hands-on>Hands-on</h3><p>For this sample solution we&#39;ll be using the following:</p><ul><li><code>node.js v16.14.2</code></li><li><code>npm 8.5.0</code></li><li><code>fastify 4.0.0-rc.1</code></li><li><code>fastify-plugin 3.0.1</code></li><li><code>undici 5.0.0</code></li></ul><p>Say we have the following base server set up at first:</p><pre><code class=language-js>const Fastify = require(&#39;fastify&#39;)

const provider = require(&#39;./provider&#39;)

const server = Fastify({ logger: true })
const USUAL_WAIT_TIME_MS = 5000

server.get(&#39;/ping&#39;, function (request, reply) {
  reply.send({ error: false, ready: request.server.magicKey !== null })
})

server.post(&#39;/webhook&#39;, function (request, reply) {
  // It&#39;s good practice to validate webhook requests really come from
  // whoever you expect. This is skipped in this sample for the sake
  // of simplicity

  const { magicKey } = request.body
  request.server.magicKey = magicKey
  request.log.info(&#39;Ready for customer requests!&#39;)

  reply.send({ error: false })
})

server.get(&#39;/v1*&#39;, async function (request, reply) {
  try {
    const data = await provider.fetchSensitiveData(request.server.magicKey)
    return { customer: true, error: false }
  } catch (error) {
    request.log.error({
      error,
      message: &#39;Failed at fetching sensitive data from provider&#39;,
    })

    reply.statusCode = 500
    return { customer: null, error: true }
  }
})

server.decorate(&#39;magicKey&#39;, null)

server.listen({ port: &#39;1234&#39; }, () =&gt; {
  provider.thirdPartyMagicKeyGenerator(USUAL_WAIT_TIME_MS)
    .catch((error) =&gt; {
      server.log.error({
        error,
        message: &#39;Got an error while trying to get the magic key!&#39;
      })

      // Since we won&#39;t be able to serve requests, might as well wrap
      // things up
      server.close(() =&gt; process.exit(1))
    })
})
</code></pre><p>Our code is simply setting up a Fastify server with a few routes:</p><ul><li>a <code>/ping</code> route that specifies whether the service is ready or not to serve requests by checking if the <code>magicKey</code> has been set up</li><li>a <code>/webhook</code> endpoint for our provider to reach back to us when they&#39;re ready to share the <code>magicKey</code>. The <code>magicKey</code> is, then, saved into the previously set decorator on the <code>fastify</code> object</li><li>a catchall <code>/v1*</code> route to simulate what would have been customer-initiated requests. These requests rely on us having a valid <code>magicKey</code></li></ul><p>The <code>provider.js</code> file, simulating actions of an external provider, is as follows:</p><pre><code class=language-js>const { fetch } = require(&#39;undici&#39;)
const { setTimeout } = require(&#39;timers/promises&#39;)

const MAGIC_KEY = &#39;12345&#39;

const delay = setTimeout

exports.thirdPartyMagicKeyGenerator = async (ms) =&gt; {
  // Simulate processing delay
  await delay(ms)

  // Simulate webhook request to our server
  const { status } = await fetch(
    &#39;http://localhost:1234/webhook&#39;,
    {
      body: JSON.stringify({ magicKey: MAGIC_KEY }),
      method: &#39;POST&#39;,
      headers: {
        &#39;content-type&#39;: &#39;application/json&#39;,
      },
    },
  )

  if (status !== 200) {
    throw new Error(&#39;Failed to fetch magic key&#39;)
  }
}

exports.fetchSensitiveData = async (key) =&gt; {
  // Simulate processing delay
  await delay(700)
  const data = { sensitive: true }

  if (key === MAGIC_KEY) {
    return data
  }

  throw new Error(&#39;Invalid key&#39;)
}
</code></pre><p>The most important snippet here is the <code>thirdPartyMagicKeyGenerator</code> function, which will wait for 5 seconds and, then, make the POST request to our <code>/webhook</code> endpoint.</p><p>When our server spins up we start listening to new connections without having our <code>magicKey</code> set up. Until we receive the webhook request from our external provider (in this example we&#39;re simulating a 5 second delay) all our requests under the <code>/v1*</code> path (customer requests) will fail. Worse than that: they&#39;ll fail after we&#39;ve reached out to our provider with an invalid key and got an error from them. That wasted time and resources for us and our customers. Depending on the kind of application we&#39;re running and on the request rate we&#39;re expecting this delay is not acceptable or, at least, very annoying.</p><p>Of course, that could be simply mitigated by checking whether or not the <code>magicKey</code> has been set up before hitting the provider in the <code>/v1*</code> handler. Sure, but that would lead to bloat in the code. And imagine we have dozens of different routes, with different controllers, that require that key. Should we repeatedly add that check to all of them? That&#39;s error-prone and there are more elegant solutions.</p><p>What we&#39;ll do to improve this setup overall is create a <a href=../../Reference/Plugins><code>Plugin</code></a> that&#39;ll be solely responsible for making sure we both:</p><ul><li>do not accept requests that would otherwise fail until we&#39;re ready for them</li><li>make sure we reach out to our provider as soon as possible</li></ul><p>This way we&#39;ll make sure all our setup regarding this specific <em>business rule</em> is placed on a single entity, instead of scattered all across our code base.</p><p>With the changes to improve this behavior, the code will look like this:</p><h5 id=indexjs>index.js</h5><pre><code class=language-js>const Fastify = require(&#39;fastify&#39;)

const customerRoutes = require(&#39;./customer-routes&#39;)
const { setup, delay } = require(&#39;./delay-incoming-requests&#39;)

const server = new Fastify({ logger: true })

server.register(setup)

// Non-blocked URL
server.get(&#39;/ping&#39;, function (request, reply) {
  reply.send({ error: false, ready: request.server.magicKey !== null })
})

// Webhook to handle the provider&#39;s response - also non-blocked
server.post(&#39;/webhook&#39;, function (request, reply) {
  // It&#39;s good practice to validate webhook requests really come from
  // whoever you expect. This is skipped in this sample for the sake
  // of simplicity

  const { magicKey } = request.body
  request.server.magicKey = magicKey
  request.log.info(&#39;Ready for customer requests!&#39;)

  reply.send({ error: false })
})

// Blocked URLs
// Mind we&#39;re building a new plugin by calling the `delay` factory with our
// customerRoutes plugin
server.register(delay(customerRoutes), { prefix: &#39;/v1&#39; })

server.listen({ port: &#39;1234&#39; })
</code></pre><h5 id=providerjs>provider.js</h5><pre><code class=language-js>const { fetch } = require(&#39;undici&#39;)
const { setTimeout } = require(&#39;timers/promises&#39;)

const MAGIC_KEY = &#39;12345&#39;

const delay = setTimeout

exports.thirdPartyMagicKeyGenerator = async (ms) =&gt; {
  // Simulate processing delay
  await delay(ms)

  // Simulate webhook request to our server
  const { status } = await fetch(
    &#39;http://localhost:1234/webhook&#39;,
    {
      body: JSON.stringify({ magicKey: MAGIC_KEY }),
      method: &#39;POST&#39;,
      headers: {
        &#39;content-type&#39;: &#39;application/json&#39;,
      },
    },
  )

  if (status !== 200) {
    throw new Error(&#39;Failed to fetch magic key&#39;)
  }
}

exports.fetchSensitiveData = async (key) =&gt; {
  // Simulate processing delay
  await delay(700)
  const data = { sensitive: true }

  if (key === MAGIC_KEY) {
    return data
  }

  throw new Error(&#39;Invalid key&#39;)
}
</code></pre><h5 id=delay-incoming-requestsjs>delay-incoming-requests.js</h5><pre><code class=language-js>const fp = require(&#39;fastify-plugin&#39;)

const provider = require(&#39;./provider&#39;)

const USUAL_WAIT_TIME_MS = 5000

async function setup(fastify) {
  // As soon as we&#39;re listening for requests, let&#39;s work our magic
  fastify.server.on(&#39;listening&#39;, doMagic)

  // Set up the placeholder for the magicKey
  fastify.decorate(&#39;magicKey&#39;, null)

  // Our magic -- important to make sure errors are handled. Beware of async
  // functions outside `try/catch` blocks
  // If an error is thrown at this point and not captured it&#39;ll crash the
  // application
  function doMagic() {
    fastify.log.info(&#39;Doing magic!&#39;)

    provider.thirdPartyMagicKeyGenerator(USUAL_WAIT_TIME_MS)
      .catch((error) =&gt; {
        fastify.log.error({
          error,
          message: &#39;Got an error while trying to get the magic key!&#39;
        })

        // Since we won&#39;t be able to serve requests, might as well wrap
        // things up
        fastify.close(() =&gt; process.exit(1))
      })
  }
}

const delay = (routes) =&gt;
  function (fastify, opts, done) {
    // Make sure customer requests won&#39;t be accepted if the magicKey is not
    // available
    fastify.addHook(&#39;onRequest&#39;, function (request, reply, next) {
      if (!request.server.magicKey) {
        reply.statusCode = 503
        reply.header(&#39;Retry-After&#39;, USUAL_WAIT_TIME_MS)
        reply.send({ error: true, retryInMs: USUAL_WAIT_TIME_MS })
      }

      next()
    })

    // Register to-be-delayed routes
    fastify.register(routes, opts)

    done()
  }

module.exports = {
  setup: fp(setup),
  delay,
}
</code></pre><h5 id=customer-routesjs>customer-routes.js</h5><pre><code class=language-js>const fp = require(&#39;fastify-plugin&#39;)

const provider = require(&#39;./provider&#39;)

module.exports = fp(async function (fastify) {
  fastify.get(&#39;*&#39;, async function (request ,reply) {
    try {
      const data = await provider.fetchSensitiveData(request.server.magicKey)
      return { customer: true, error: false }
    } catch (error) {
      request.log.error({
        error,
        message: &#39;Failed at fetching sensitive data from provider&#39;,
      })

      reply.statusCode = 500
      return { customer: null, error: true }
    }
  })
})
</code></pre><p>There is a very specific change on the previously existing files that is worth mentioning: Beforehand we were using the <code>server.listen</code> callback to start the authentication process with the external provider and we were decorating the <code>server</code> object right before initializing the server. That was bloating our server initialization setup with unnecessary code and didn&#39;t have much to do with starting the Fastify server. It was a business logic that didn&#39;t have its specific place in the code base.</p><p>Now we&#39;ve implemented the <code>delayIncomingRequests</code> plugin in the <code>delay-incoming-requests.js</code> file. That&#39;s, in truth, a module split into two different plugins that will build up to a single use-case. That&#39;s the brains of our operation. Let&#39;s walk through what the plugins do:</p><h5 id=setup>setup</h5><p>The <code>setup</code> plugin is responsible for making sure we reach out to our provider asap and store the <code>magicKey</code> somewhere available to all our handlers.</p><pre><code class=language-js>  fastify.server.on(&#39;listening&#39;, doMagic)
</code></pre><p>As soon as the server starts listening (very similar behavior to adding a piece of code to the <code>server.listen</code>&#39;s callback function) a <code>listening</code> event is emitted (for more info refer to <a href=https://nodejs.org/api/net.html#event-listening>https://nodejs.org/api/net.html#event-listening</a>). We use that to reach out to our provider as soon as possible, with the <code>doMagic</code> function.</p><pre><code class=language-js>  fastify.decorate(&#39;magicKey&#39;, null)
</code></pre><p>The <code>magicKey</code> decoration is also part of the plugin now. We initialize it with a placeholder, waiting for the valid value to be retrieved.</p><h5 id=delay>delay</h5><p><code>delay</code> is not a plugin itself. It&#39;s actually a plugin <em>factory</em>. It expects a Fastify plugin with <code>routes</code> and exports the actual plugin that&#39;ll handle enveloping those routes with an <code>onRequest</code> hook that will make sure no requests are handled until we&#39;re ready for them.</p><pre><code class=language-js>const delay = (routes) =&gt;
  function (fastify, opts, done) {
    // Make sure customer requests won&#39;t be accepted if the magicKey is not
    // available
    fastify.addHook(&#39;onRequest&#39;, function (request, reply, next) {
      if (!request.server.magicKey) {
        reply.statusCode = 503
        reply.header(&#39;Retry-After&#39;, USUAL_WAIT_TIME_MS)
        reply.send({ error: true, retryInMs: USUAL_WAIT_TIME_MS })
      }

      next()
    })

    // Register to-be-delayed routes
    fastify.register(routes, opts)

    done()
  }
</code></pre><p>Instead of updating every single controller that might use the <code>magicKey</code>, we simply make sure that no route that&#39;s related to customer requests will be served until we have everything ready. And there&#39;s more: we fail <strong>FAST</strong> and have the possibility of giving the customer meaningful information, like how long they should wait before retrying the request. Going even further, by issuing a <a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/503><code>503</code> status code</a> we&#39;re signaling to our infrastructure components (namely load balancers) we&#39;re still not ready to take incoming requests and they should redirect traffic to other instances, if available, besides in how long we estimate that will be solved. All of that in a few simple lines!</p><p>It&#39;s noteworthy that we didn&#39;t use the <code>fastify-plugin</code> wrapper in the <code>delay</code> factory. That&#39;s because we wanted the <code>onRequest</code> hook to only be set within that specific scope and not to the scope that called it (in our case, the main <code>server</code> object defined in <code>index.js</code>). <code>fastify-plugin</code> sets the <code>skip-override</code> hidden property, which has a practical effect of making whatever changes we make to our <code>fastify</code> object available to the upper scope. That&#39;s also why we used it with the <code>customerRoutes</code> plugin: we wanted those routes to be available to its calling scope, the <code>delay</code> plugin. For more info on that subject refer to <a href=../../Reference/Plugins#handle-the-scope>Plugins</a>.</p><p>Let&#39;s see how that behaves in action. If we fired our server up with <code>node index.js</code> and made a few requests to test things out. These were the logs we&#39;d see (some bloat was removed to ease things up):</p><pre><code class=language-sh>{&quot;time&quot;:1650063793316,&quot;msg&quot;:&quot;Doing magic!&quot;}
{&quot;time&quot;:1650063793316,&quot;msg&quot;:&quot;Server listening at http://127.0.0.1:1234&quot;}
{&quot;time&quot;:1650063795030,&quot;reqId&quot;:&quot;req-1&quot;,&quot;req&quot;:{&quot;method&quot;:&quot;GET&quot;,&quot;url&quot;:&quot;/v1&quot;,&quot;hostname&quot;:&quot;localhost:1234&quot;,&quot;remoteAddress&quot;:&quot;127.0.0.1&quot;,&quot;remotePort&quot;:51928},&quot;msg&quot;:&quot;incoming request&quot;}
{&quot;time&quot;:1650063795033,&quot;reqId&quot;:&quot;req-1&quot;,&quot;res&quot;:{&quot;statusCode&quot;:503},&quot;responseTime&quot;:2.5721680000424385,&quot;msg&quot;:&quot;request completed&quot;}
{&quot;time&quot;:1650063796248,&quot;reqId&quot;:&quot;req-2&quot;,&quot;req&quot;:{&quot;method&quot;:&quot;GET&quot;,&quot;url&quot;:&quot;/ping&quot;,&quot;hostname&quot;:&quot;localhost:1234&quot;,&quot;remoteAddress&quot;:&quot;127.0.0.1&quot;,&quot;remotePort&quot;:51930},&quot;msg&quot;:&quot;incoming request&quot;}
{&quot;time&quot;:1650063796248,&quot;reqId&quot;:&quot;req-2&quot;,&quot;res&quot;:{&quot;statusCode&quot;:200},&quot;responseTime&quot;:0.4802369996905327,&quot;msg&quot;:&quot;request completed&quot;}
{&quot;time&quot;:1650063798377,&quot;reqId&quot;:&quot;req-3&quot;,&quot;req&quot;:{&quot;method&quot;:&quot;POST&quot;,&quot;url&quot;:&quot;/webhook&quot;,&quot;hostname&quot;:&quot;localhost:1234&quot;,&quot;remoteAddress&quot;:&quot;127.0.0.1&quot;,&quot;remotePort&quot;:51932},&quot;msg&quot;:&quot;incoming request&quot;}
{&quot;time&quot;:1650063798379,&quot;reqId&quot;:&quot;req-3&quot;,&quot;msg&quot;:&quot;Ready for customer requests!&quot;}
{&quot;time&quot;:1650063798379,&quot;reqId&quot;:&quot;req-3&quot;,&quot;res&quot;:{&quot;statusCode&quot;:200},&quot;responseTime&quot;:1.3567829988896847,&quot;msg&quot;:&quot;request completed&quot;}
{&quot;time&quot;:1650063799858,&quot;reqId&quot;:&quot;req-4&quot;,&quot;req&quot;:{&quot;method&quot;:&quot;GET&quot;,&quot;url&quot;:&quot;/v1&quot;,&quot;hostname&quot;:&quot;localhost:1234&quot;,&quot;remoteAddress&quot;:&quot;127.0.0.1&quot;,&quot;remotePort&quot;:51934},&quot;msg&quot;:&quot;incoming request&quot;}
{&quot;time&quot;:1650063800561,&quot;reqId&quot;:&quot;req-4&quot;,&quot;res&quot;:{&quot;statusCode&quot;:200},&quot;responseTime&quot;:702.4662979990244,&quot;msg&quot;:&quot;request completed&quot;}
</code></pre><p>Let&#39;s focus on a few parts:</p><pre><code class=language-sh>{&quot;time&quot;:1650063793316,&quot;msg&quot;:&quot;Doing magic!&quot;}
{&quot;time&quot;:1650063793316,&quot;msg&quot;:&quot;Server listening at http://127.0.0.1:1234&quot;}
</code></pre><p>These are the initial logs we&#39;d see as soon as the server started. We reach out to the external provider as early as possible within a valid time window (we couldn&#39;t do that before the server was ready to receive connections).</p><p>While the server is still not ready, a few requests are attempted:</p><pre><code class=language-sh>{&quot;time&quot;:1650063795030,&quot;reqId&quot;:&quot;req-1&quot;,&quot;req&quot;:{&quot;method&quot;:&quot;GET&quot;,&quot;url&quot;:&quot;/v1&quot;,&quot;hostname&quot;:&quot;localhost:1234&quot;,&quot;remoteAddress&quot;:&quot;127.0.0.1&quot;,&quot;remotePort&quot;:51928},&quot;msg&quot;:&quot;incoming request&quot;}
{&quot;time&quot;:1650063795033,&quot;reqId&quot;:&quot;req-1&quot;,&quot;res&quot;:{&quot;statusCode&quot;:503},&quot;responseTime&quot;:2.5721680000424385,&quot;msg&quot;:&quot;request completed&quot;}
{&quot;time&quot;:1650063796248,&quot;reqId&quot;:&quot;req-2&quot;,&quot;req&quot;:{&quot;method&quot;:&quot;GET&quot;,&quot;url&quot;:&quot;/ping&quot;,&quot;hostname&quot;:&quot;localhost:1234&quot;,&quot;remoteAddress&quot;:&quot;127.0.0.1&quot;,&quot;remotePort&quot;:51930},&quot;msg&quot;:&quot;incoming request&quot;}
{&quot;time&quot;:1650063796248,&quot;reqId&quot;:&quot;req-2&quot;,&quot;res&quot;:{&quot;statusCode&quot;:200},&quot;responseTime&quot;:0.4802369996905327,&quot;msg&quot;:&quot;request completed&quot;}
</code></pre><p>The first one (<code>req-1</code>) was a <code>GET /v1</code>, that failed (<strong>FAST</strong> - <code>responseTime</code> is in <code>ms</code>) with our <code>503</code> status code and the meaningful information in the response. Below is the response for that request:</p><pre><code class=language-sh>HTTP/1.1 503 Service Unavailable
Connection: keep-alive
Content-Length: 31
Content-Type: application/json; charset=utf-8
Date: Fri, 15 Apr 2022 23:03:15 GMT
Keep-Alive: timeout=5
Retry-After: 5000

{
    &quot;error&quot;: true,
    &quot;retryInMs&quot;: 5000
}
</code></pre><p>Then we attempt a new request (<code>req-2</code>), which was a <code>GET /ping</code>. As expected, since that was not one of the requests we asked our plugin to filter, it succeeded. That could also be used as means of informing an interested party whether or not we were ready to serve requests (although <code>/ping</code> is more commonly associated with <em>liveness</em> checks and that would be the responsibility of a <em>readiness</em> check -- the curious reader can get more info on these terms <a href=https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-setting-up-health-checks-with-readiness-and-liveness-probes>here</a>) with the <code>ready</code> field. Below is the response for that request:</p><pre><code class=language-sh>HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 29
Content-Type: application/json; charset=utf-8
Date: Fri, 15 Apr 2022 23:03:16 GMT
Keep-Alive: timeout=5

{
    &quot;error&quot;: false,
    &quot;ready&quot;: false
}
</code></pre><p>After that there were more interesting log messages:</p><pre><code class=language-sh>{&quot;time&quot;:1650063798377,&quot;reqId&quot;:&quot;req-3&quot;,&quot;req&quot;:{&quot;method&quot;:&quot;POST&quot;,&quot;url&quot;:&quot;/webhook&quot;,&quot;hostname&quot;:&quot;localhost:1234&quot;,&quot;remoteAddress&quot;:&quot;127.0.0.1&quot;,&quot;remotePort&quot;:51932},&quot;msg&quot;:&quot;incoming request&quot;}
{&quot;time&quot;:1650063798379,&quot;reqId&quot;:&quot;req-3&quot;,&quot;msg&quot;:&quot;Ready for customer requests!&quot;}
{&quot;time&quot;:1650063798379,&quot;reqId&quot;:&quot;req-3&quot;,&quot;res&quot;:{&quot;statusCode&quot;:200},&quot;responseTime&quot;:1.3567829988896847,&quot;msg&quot;:&quot;request completed&quot;}
</code></pre><p>This time it was our simulated external provider hitting us to let us know authentication had gone well and telling us what our <code>magicKey</code> was. We saved that into our <code>magicKey</code> decorator and celebrated with a log message saying we were now ready for customers to hit us!</p><pre><code class=language-sh>{&quot;time&quot;:1650063799858,&quot;reqId&quot;:&quot;req-4&quot;,&quot;req&quot;:{&quot;method&quot;:&quot;GET&quot;,&quot;url&quot;:&quot;/v1&quot;,&quot;hostname&quot;:&quot;localhost:1234&quot;,&quot;remoteAddress&quot;:&quot;127.0.0.1&quot;,&quot;remotePort&quot;:51934},&quot;msg&quot;:&quot;incoming request&quot;}
{&quot;time&quot;:1650063800561,&quot;reqId&quot;:&quot;req-4&quot;,&quot;res&quot;:{&quot;statusCode&quot;:200},&quot;responseTime&quot;:702.4662979990244,&quot;msg&quot;:&quot;request completed&quot;}
</code></pre><p>Finally, a final <code>GET /v1</code> request was made and, this time, it succeeded. Its response was the following:</p><pre><code class=language-sh>HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 31
Content-Type: application/json; charset=utf-8
Date: Fri, 15 Apr 2022 23:03:20 GMT
Keep-Alive: timeout=5

{
    &quot;customer&quot;: true,
    &quot;error&quot;: false
}
</code></pre><h2 id=conclusion>Conclusion</h2><p>Specifics of the implementation will vary from one problem to another, but the main goal of this guide was to show a very specific use case of an issue that could be solved within Fastify&#39;s ecosystem.</p><p>This guide is a tutorial on the use of plugins, decorators, and hooks to solve the problem of delaying serving specific requests on our application. It&#39;s not production-ready, as it keeps local state (the <code>magicKey</code>) and it&#39;s not horizontally scalable (we don&#39;t want to flood our provider, right?). One way of improving it would be storing the <code>magicKey</code> somewhere else (perhaps a cache database?).</p><p>The keywords here were <a href=../../Reference/Decorators>Decorators</a>, <a href=../../Reference/Hooks>Hooks</a>, and <a href=../../Reference/Plugins>Plugins</a>. Combining what Fastify has to offer can lead to very ingenious and creative solutions to a wide variety of problems. Let&#39;s be creative! :)</p></div><hr><nav class=level></nav></div></div></div></section><script>// dynamically creates a submenu for the current section based on the content headers
  var titles = document.querySelectorAll('#doc-content h3, #doc-content h4')
  var currentMenu = document.getElementById('doc-menu-section')
  if (titles.length && currentMenu) {
    var submenu = document.createElement('ul')
    titles.forEach(el => {
      var currentSubmenuItem = document.createElement('li')
      var currentSubmenuLink = document.createElement('a')
      currentSubmenuLink.href = '#' + el.id
      currentSubmenuLink.title = el.textContent
      currentSubmenuLink.append(document.createTextNode(el.textContent))
      currentSubmenuItem.append(currentSubmenuLink)
      submenu.append(currentSubmenuItem)
    })
    currentMenu.append(submenu)
  }

  // dynamically creates header anchor links
  var headers = document.querySelectorAll('#doc-content h3, #doc-content h4')
  headers.forEach(el => {
    var currentAnchorLink = document.createElement('a')
    currentAnchorLink.className = 'anchor'
    currentAnchorLink.href = "#" + el.id
    currentAnchorLink.append(document.createTextNode('¶'))
    el.insertBefore(currentAnchorLink, el.firstChild);
  })</script><script>const contentLoaded = document.addEventListener('DOMContentLoaded', setTOCHeight)
  const resize = window.addEventListener('resize', setTOCHeight)

  function setTOCHeight() {
    const docHeight = window.innerHeight
    const tocSidebar = document.querySelector('#toc') || 0

    const tocHeight = docHeight - tocSidebar.getBoundingClientRect().top

    document.documentElement.style
      .setProperty('--TOC-height', `${tocHeight}px`)
  }

  window.addEventListener('beforeunload', () => {
    document.removeEventListener(contentLoaded)
    window.removeEventListener(resize)
  })</script></main><footer class="grey is-primary footer"><div class=container><div class="content has-text-centered"><p>Fastify, Copyright &copy; 2016-2023 <a href=https://openjsf.org/ target=_blank rel=noopener>OpenJS Foundation</a> and <a href=https://github.com/fastify/fastify#team target=_blank rel=noopener>The Fastify team</a>, Licensed under <a href=https://github.com/fastify/fastify/blob/master/LICENSE target=_blank rel=noopener>MIT</a></p><a href=https://www.netlify.com><img src=https://www.netlify.com/img/global/badges/netlify-color-accent.svg alt="Deploys by Netlify" loading=lazy decoding=async></a><p><small>Icons by simpleicons.org</small></p></div></div></footer><script src=/js/main.1e1d476db6c0b326.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js integrity="sha512-s+tOYYcC3Jybgr9mVsdAxsRYlGNq4mlAurOrfNuGMQ/SCofNPu92tjE7YRZCsdEtWL1yGkqk15fU/ark206YTg==" crossorigin=anonymous></script><script>hljs.highlightAll();</script><script src=https://cdn.jsdelivr.net/npm/@docsearch/js@alpha></script><script type=text/javascript>docsearch({
        appId: 'DMPMC33PLU',
        apiKey: '12d46b3bfeee6511031cfe00778f3e45',
        indexName: 'fastify',
        container: '#algolia-search-input',
        algoliaOptions: { 'facetFilters': ["version:latest", "tags:docs"] }
      });</script></body></html>