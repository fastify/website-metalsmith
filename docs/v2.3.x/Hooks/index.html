<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Hooks</title><meta name=description content="Fast and low overhead web framework, for Node.js"><link rel=apple-touch-icon sizes=57x57 href=/images/apple-icon-57x57.ed24c0a19503e080.png><link rel=apple-touch-icon sizes=60x60 href=/images/apple-icon-60x60.60c285c424d50738.png><link rel=apple-touch-icon sizes=72x72 href=/images/apple-icon-72x72.e49b27cfe1ab1461.png><link rel=apple-touch-icon sizes=76x76 href=/images/apple-icon-76x76.752f43fc91b8c1f7.png><link rel=apple-touch-icon sizes=114x114 href=/images/apple-icon-114x114.61739fa1d5a7059a.png><link rel=apple-touch-icon sizes=120x120 href=/images/apple-icon-120x120.7c25de37c5ce2ec1.png><link rel=apple-touch-icon sizes=144x144 href=/images/apple-icon-144x144.04d88fb27bd92cbe.png><link rel=apple-touch-icon sizes=152x152 href=/images/apple-icon-152x152.9364781175671626.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-icon-180x180.67579100928bfcd2.png><link rel=icon type=image/png sizes=192x192 href=/images/android-icon-192x192.37eb7f1ae3853740.png><link rel=icon type=image/png sizes=32x32 href=/images/favicon-32x32.1e22f0e774bc3cce.png><link rel=icon type=image/png sizes=96x96 href=/images/favicon-96x96.7e8a68b1b80c1799.png><link rel=icon type=image/png sizes=16x16 href=/images/favicon-16x16.e534ce05cb727f1a.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content=#ffffff><meta name=msapplication-TileImage content=/images/ms-icon-144x144.png><meta name=theme-color content=#ffffff><meta property=og:url content=https://www.fastify.io/docs/v2.3.x/Hooks><meta property=og:type content=website><meta property=og:title content=Hooks><meta property=og:description content="Fast and low overhead web framework, for Node.js"><meta property=og:image content=https://www.fastify.io/images/fastify-fb-share-image.07b6e6860853c758.png><meta name=twitter:card content=summary_large_image><meta name=twitter:site content=@fastifyjs><meta name=twitter:creator content=@fastifyjs><meta name=twitter:title content=Hooks><meta name=twitter:description content="Fast and low overhead web framework, for Node.js"><meta name=twitter:image content=https://www.fastify.io/images/fastify-twitter-share-image.cd9f217b360af3e2.png><link rel=stylesheet href=/css/style.f4d6592b3a91c5ef.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/default.min.css integrity="sha512-kZqGbhf9JTB4bVJ0G8HCkqmaPcRgo88F0dneK30yku5Y/dep7CZfCnNml2Je/sY4lBoqoksXz4PtVXS4GHSUzQ==" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@docsearch/css@alpha><meta name=robots content="noindex, nofollow"></head><body><nav id=main-navbar class=navbar><div class=navbar-brand><a class=navbar-item href=/ ><img src=/images/fastify-logo-menu.d13f8da7a965c800.png alt="Fastify: Fast and low overhead web framework, for Node.js" height=28 decoding=async> </a><a class="navbar-item is-hidden-desktop" href=https://github.com/fastify/fastify target=_blank rel=noopener><span class=icon style="color: #333;"><i class="fa fa-github"></i></span></a><div class="navbar-burger burger" data-target=mobileMenu><span></span> <span></span> <span></span></div></div><div class=navbar-menu id=mobileMenu><div class=navbar-start><a class=navbar-item href=/ >Home</a> <a class=navbar-item href=/docs/latest>Docs</a> <a class=navbar-item href=/ecosystem>Ecosystem</a> <a class=navbar-item href=/benchmarks>Benchmarks</a> <a class=navbar-item href=/contribute>Contribute</a> <a class=navbar-item href=https://medium.com/@fastifyjs/ >Blog</a> <a class=navbar-item href=https://github.com/fastify/help>Help</a></div><div class=navbar-end><span id=algolia-search-input class="control has-icons-left navbar-item"></span> <a class=navbar-item href=https://github.com/fastify/fastify target=_blank rel=noopener><span class="fa fa-github"></span>&nbsp;GitHub </a><a class=navbar-item href=https://twitter.com/fastifyjs target=_blank rel=noopener><span class="fa fa-twitter"></span>&nbsp;Twitter </a><a class=navbar-item rel=me href=https://fosstodon.org/@fastify target=_blank><span class="fa fa-hashtag"></span>&nbsp;Mastodon</a></div></div></nav><main class=page-content aria-label=Content><section class="hero is-primary" style="background-image: url(/images/bg-pattern-dark.3f8cda863b3bbf52.png)"><div class=hero-body><div class=container><h1 class=title>Documentation (v2.3.0)</h1></div></div></section><section class=section><div class=container><div class=columns><div class="column is-3 is-hidden-mobile sticky-container"><aside class="menu sticky" id=toc><ul class=menu-list><li style="text-transform: capitalize"><a title=Benchmarking href=/docs/v2.3.x/Benchmarking>Benchmarking</a></li><li style="text-transform: capitalize"><a title=ContentTypeParser href=/docs/v2.3.x/ContentTypeParser>ContentTypeParser</a></li><li style="text-transform: capitalize"><a title=Decorators href=/docs/v2.3.x/Decorators>Decorators</a></li><li style="text-transform: capitalize"><a title=Ecosystem href=/docs/v2.3.x/Ecosystem>Ecosystem</a></li><li style="text-transform: capitalize"><a title=Errors href=/docs/v2.3.x/Errors>Errors</a></li><li style="text-transform: capitalize"><a title=Fluent-Schema href=/docs/v2.3.x/Fluent-Schema>Fluent-Schema</a></li><li style="text-transform: capitalize"><a title=Getting-Started href=/docs/v2.3.x/Getting-Started>Getting-Started</a></li><li style="text-transform: capitalize"><a title=HTTP2 href=/docs/v2.3.x/HTTP2>HTTP2</a></li><li style="text-transform: capitalize" id=doc-menu-section><a title=Hooks class=is-active href=/docs/v2.3.x/Hooks>Hooks</a></li><li style="text-transform: capitalize"><a title=LTS href=/docs/v2.3.x/LTS>LTS</a></li><li style="text-transform: capitalize"><a title=Lifecycle href=/docs/v2.3.x/Lifecycle>Lifecycle</a></li><li style="text-transform: capitalize"><a title=Logging href=/docs/v2.3.x/Logging>Logging</a></li><li style="text-transform: capitalize"><a title=Middlewares href=/docs/v2.3.x/Middlewares>Middlewares</a></li><li style="text-transform: capitalize"><a title=Plugins-Guide href=/docs/v2.3.x/Plugins-Guide>Plugins-Guide</a></li><li style="text-transform: capitalize"><a title=Plugins href=/docs/v2.3.x/Plugins>Plugins</a></li><li style="text-transform: capitalize"><a title=Reply href=/docs/v2.3.x/Reply>Reply</a></li><li style="text-transform: capitalize"><a title=Request href=/docs/v2.3.x/Request>Request</a></li><li style="text-transform: capitalize"><a title=Routes href=/docs/v2.3.x/Routes>Routes</a></li><li style="text-transform: capitalize"><a title=Server href=/docs/v2.3.x/Server>Server</a></li><li style="text-transform: capitalize"><a title=Serverless href=/docs/v2.3.x/Serverless>Serverless</a></li><li style="text-transform: capitalize"><a title=Testing href=/docs/v2.3.x/Testing>Testing</a></li><li style="text-transform: capitalize"><a title=TypeScript href=/docs/v2.3.x/TypeScript>TypeScript</a></li><li style="text-transform: capitalize"><a title=Validation-and-Serialization href=/docs/v2.3.x/Validation-and-Serialization>Validation-and-Serialization</a></li><li style="text-transform: capitalize"><a title=Write-Plugin href=/docs/v2.3.x/Write-Plugin>Write-Plugin</a></li></ul><div class=content style="margin: .8em; border-top: 1px solid #ccc; padding: .8em 0 0 0">Docs version<div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value"><option value=/docs/latest>latest</option><option value=/docs/master>master</option><option value=/docs/v4.12.x>v4.12.x</option><option value=/docs/v4.11.x>v4.11.x</option><option value=/docs/v4.10.x>v4.10.x</option><option value=/docs/v4.9.x>v4.9.x</option><option value=/docs/v4.8.x>v4.8.x</option><option value=/docs/v4.7.x>v4.7.x</option><option value=/docs/v4.6.x>v4.6.x</option><option value=/docs/v4.5.x>v4.5.x</option><option value=/docs/v4.4.x>v4.4.x</option><option value=/docs/v4.3.x>v4.3.x</option><option value=/docs/v4.2.x>v4.2.x</option><option value=/docs/v4.1.x>v4.1.x</option><option value=/docs/v4.0.x>v4.0.x</option><option value=/docs/v3.29.x>v3.29.x</option><option value=/docs/v3.28.x>v3.28.x</option><option value=/docs/v3.27.x>v3.27.x</option><option value=/docs/v3.26.x>v3.26.x</option><option value=/docs/v3.25.x>v3.25.x</option><option value=/docs/v3.24.x>v3.24.x</option><option value=/docs/v3.23.x>v3.23.x</option><option value=/docs/v3.22.x>v3.22.x</option><option value=/docs/v3.21.x>v3.21.x</option><option value=/docs/v3.20.x>v3.20.x</option><option value=/docs/v3.19.x>v3.19.x</option><option value=/docs/v3.18.x>v3.18.x</option><option value=/docs/v3.17.x>v3.17.x</option><option value=/docs/v3.16.x>v3.16.x</option><option value=/docs/v3.15.x>v3.15.x</option><option value=/docs/v3.14.x>v3.14.x</option><option value=/docs/v3.13.x>v3.13.x</option><option value=/docs/v3.12.x>v3.12.x</option><option value=/docs/v3.11.x>v3.11.x</option><option value=/docs/v3.10.x>v3.10.x</option><option value=/docs/v3.9.x>v3.9.x</option><option value=/docs/v3.8.x>v3.8.x</option><option value=/docs/v3.7.x>v3.7.x</option><option value=/docs/v3.6.x>v3.6.x</option><option value=/docs/v3.5.x>v3.5.x</option><option value=/docs/v3.4.x>v3.4.x</option><option value=/docs/v3.3.x>v3.3.x</option><option value=/docs/v3.2.x>v3.2.x</option><option value=/docs/v3.1.x>v3.1.x</option><option value=/docs/v3.0.x>v3.0.x</option><option value=/docs/v2.15.x>v2.15.x</option><option value=/docs/v2.14.x>v2.14.x</option><option value=/docs/v2.13.x>v2.13.x</option><option value=/docs/v2.12.x>v2.12.x</option><option value=/docs/v2.11.x>v2.11.x</option><option value=/docs/v2.10.x>v2.10.x</option><option value=/docs/v2.9.x>v2.9.x</option><option value=/docs/v2.8.x>v2.8.x</option><option value=/docs/v2.7.x>v2.7.x</option><option value=/docs/v2.6.x>v2.6.x</option><option value=/docs/v2.5.x>v2.5.x</option><option value=/docs/v2.4.x>v2.4.x</option><option selected value=/docs/v2.3.x>v2.3.x</option><option value=/docs/v2.2.x>v2.2.x</option><option value=/docs/v2.1.x>v2.1.x</option><option value=/docs/v2.0.x>v2.0.x</option><option value=/docs/v1.14.x>v1.14.x</option><option value=/docs/v1.13.x>v1.13.x</option></select></div></div></div></div></aside></div><div class="column is-9"><nav class=breadcrumb><ul><li><a href=/ style="padding-left: 0">Fastify</a></li><li><a href=/docs/v2.3.x>Documentation</a></li><li><div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value" style="border: none;"><option value=/docs/latest>latest</option><option value=/docs/master>master</option><option value=/docs/v4.12.x>v4.12.x</option><option value=/docs/v4.11.x>v4.11.x</option><option value=/docs/v4.10.x>v4.10.x</option><option value=/docs/v4.9.x>v4.9.x</option><option value=/docs/v4.8.x>v4.8.x</option><option value=/docs/v4.7.x>v4.7.x</option><option value=/docs/v4.6.x>v4.6.x</option><option value=/docs/v4.5.x>v4.5.x</option><option value=/docs/v4.4.x>v4.4.x</option><option value=/docs/v4.3.x>v4.3.x</option><option value=/docs/v4.2.x>v4.2.x</option><option value=/docs/v4.1.x>v4.1.x</option><option value=/docs/v4.0.x>v4.0.x</option><option value=/docs/v3.29.x>v3.29.x</option><option value=/docs/v3.28.x>v3.28.x</option><option value=/docs/v3.27.x>v3.27.x</option><option value=/docs/v3.26.x>v3.26.x</option><option value=/docs/v3.25.x>v3.25.x</option><option value=/docs/v3.24.x>v3.24.x</option><option value=/docs/v3.23.x>v3.23.x</option><option value=/docs/v3.22.x>v3.22.x</option><option value=/docs/v3.21.x>v3.21.x</option><option value=/docs/v3.20.x>v3.20.x</option><option value=/docs/v3.19.x>v3.19.x</option><option value=/docs/v3.18.x>v3.18.x</option><option value=/docs/v3.17.x>v3.17.x</option><option value=/docs/v3.16.x>v3.16.x</option><option value=/docs/v3.15.x>v3.15.x</option><option value=/docs/v3.14.x>v3.14.x</option><option value=/docs/v3.13.x>v3.13.x</option><option value=/docs/v3.12.x>v3.12.x</option><option value=/docs/v3.11.x>v3.11.x</option><option value=/docs/v3.10.x>v3.10.x</option><option value=/docs/v3.9.x>v3.9.x</option><option value=/docs/v3.8.x>v3.8.x</option><option value=/docs/v3.7.x>v3.7.x</option><option value=/docs/v3.6.x>v3.6.x</option><option value=/docs/v3.5.x>v3.5.x</option><option value=/docs/v3.4.x>v3.4.x</option><option value=/docs/v3.3.x>v3.3.x</option><option value=/docs/v3.2.x>v3.2.x</option><option value=/docs/v3.1.x>v3.1.x</option><option value=/docs/v3.0.x>v3.0.x</option><option value=/docs/v2.15.x>v2.15.x</option><option value=/docs/v2.14.x>v2.14.x</option><option value=/docs/v2.13.x>v2.13.x</option><option value=/docs/v2.12.x>v2.12.x</option><option value=/docs/v2.11.x>v2.11.x</option><option value=/docs/v2.10.x>v2.10.x</option><option value=/docs/v2.9.x>v2.9.x</option><option value=/docs/v2.8.x>v2.8.x</option><option value=/docs/v2.7.x>v2.7.x</option><option value=/docs/v2.6.x>v2.6.x</option><option value=/docs/v2.5.x>v2.5.x</option><option value=/docs/v2.4.x>v2.4.x</option><option selected value=/docs/v2.3.x>v2.3.x</option><option value=/docs/v2.2.x>v2.2.x</option><option value=/docs/v2.1.x>v2.1.x</option><option value=/docs/v2.0.x>v2.0.x</option><option value=/docs/v1.14.x>v1.14.x</option><option value=/docs/v1.13.x>v1.13.x</option></select></div></div></div></li><div class=field><div class=control><div class=select><select onchange="if (this.value) window.location.href=this.value" style="border: none;"><option value=/docs/v2.3.x>Documentation</option><option value=/docs/v2.3.x/Benchmarking>Benchmarking</option><option value=/docs/v2.3.x/ContentTypeParser>ContentTypeParser</option><option value=/docs/v2.3.x/Decorators>Decorators</option><option value=/docs/v2.3.x/Ecosystem>Ecosystem</option><option value=/docs/v2.3.x/Errors>Errors</option><option value=/docs/v2.3.x/Fluent-Schema>Fluent-Schema</option><option value=/docs/v2.3.x/Getting-Started>Getting-Started</option><option value=/docs/v2.3.x/HTTP2>HTTP2</option><option selected value=/docs/v2.3.x/Hooks>Hooks</option><option value=/docs/v2.3.x/LTS>LTS</option><option value=/docs/v2.3.x/Lifecycle>Lifecycle</option><option value=/docs/v2.3.x/Logging>Logging</option><option value=/docs/v2.3.x/Middlewares>Middlewares</option><option value=/docs/v2.3.x/Plugins-Guide>Plugins-Guide</option><option value=/docs/v2.3.x/Plugins>Plugins</option><option value=/docs/v2.3.x/Reply>Reply</option><option value=/docs/v2.3.x/Request>Request</option><option value=/docs/v2.3.x/Routes>Routes</option><option value=/docs/v2.3.x/Server>Server</option><option value=/docs/v2.3.x/Serverless>Serverless</option><option value=/docs/v2.3.x/Testing>Testing</option><option value=/docs/v2.3.x/TypeScript>TypeScript</option><option value=/docs/v2.3.x/Validation-and-Serialization>Validation-and-Serialization</option><option value=/docs/v2.3.x/Write-Plugin>Write-Plugin</option></select></div></div></div></ul></nav><div id=doc-content class=content><h2 id=hooks>Hooks</h2><p>Hooks are registered with the <code>fastify.addHook</code> method and allow you to listen to specific events in the application or request/response lifecycle. You have to register a hook before the event is triggered otherwise the event is lost.</p><h2 id=requestresponse-hooks>Request/Response Hooks</h2><p>By using the hooks you can interact directly inside the lifecycle of Fastify. There are seven different Hooks that you can use <em>(in order of execution)</em>:</p><ul><li><code>&#39;onRequest&#39;</code></li><li><code>&#39;preParsing&#39;</code></li><li><code>&#39;preValidation&#39;</code></li><li><code>&#39;preHandler&#39;</code></li><li><code>&#39;preSerialization&#39;</code></li><li><code>&#39;onError&#39;</code></li><li><code>&#39;onSend&#39;</code></li><li><code>&#39;onResponse&#39;</code></li></ul><p>Example:</p><pre><code class=language-js>fastify.addHook(&#39;onRequest&#39;, (request, reply, next) =&gt; {
  // some code
  next()
})

fastify.addHook(&#39;preParsing&#39;, (request, reply, next) =&gt; {
  // some code
  next()
})

fastify.addHook(&#39;preValidation&#39;, (request, reply, next) =&gt; {
  // some code
  next()
})

fastify.addHook(&#39;preHandler&#39;, (request, reply, next) =&gt; {
  // some code
  next()
})

fastify.addHook(&#39;preSerialization&#39;, (request, reply, payload, next) =&gt; {
  // some code
  next()
})

fastify.addHook(&#39;onError&#39;, (request, reply, error, next) =&gt; {
  // some code
  next()
})

fastify.addHook(&#39;onSend&#39;, (request, reply, payload, next) =&gt; {
  // some code
  next()
})

fastify.addHook(&#39;onResponse&#39;, (request, reply, next) =&gt; {
  // some code
  next()
})
</code></pre><p>Or <code>async/await</code></p><pre><code class=language-js>fastify.addHook(&#39;onRequest&#39;, async (request, reply) =&gt; {
  // some code
  await asyncMethod()
  // error occurred
  if (err) {
    throw new Error(&#39;some errors occurred.&#39;)
  }
  return
})

fastify.addHook(&#39;preParsing&#39;, async (request, reply) =&gt; {
  // some code
  await asyncMethod()
  // error occurred
  if (err) {
    throw new Error(&#39;some errors occurred.&#39;)
  }
  return
})

fastify.addHook(&#39;preValidation&#39;, async (request, reply) =&gt; {
  // some code
  await asyncMethod()
  // error occurred
  if (err) {
    throw new Error(&#39;some errors occurred.&#39;)
  }
  return
})

fastify.addHook(&#39;preHandler&#39;, async (request, reply) =&gt; {
  // some code
  await asyncMethod()
  // error occurred
  if (err) {
    throw new Error(&#39;some errors occurred.&#39;)
  }
  return
})

fastify.addHook(&#39;preSerialization&#39;, async (request, reply, payload) =&gt; {
  // some code
  await asyncMethod()
  // error occurred
  if (err) {
    throw new Error(&#39;some errors occurred.&#39;)
  }
  return payload
})

fastify.addHook(&#39;onError&#39;, async (request, reply, error) =&gt; {
  // useful for custom error logging
  // you should not use this hook to update the error
})

fastify.addHook(&#39;onSend&#39;, async (request, reply, payload) =&gt; {
  // some code
  await asyncMethod()
  // error occurred
  if (err) {
    throw new Error(&#39;some errors occurred.&#39;)
  }
  return
})

fastify.addHook(&#39;onResponse&#39;, async (request, reply) =&gt; {
  // some code
  await asyncMethod()
  // error occurred
  if (err) {
    throw new Error(&#39;some errors occurred.&#39;)
  }
  return
})
</code></pre><p><strong>Notice:</strong> the <code>next</code> callback is not available when using <code>async</code>/<code>await</code> or returning a <code>Promise</code>. If you do invoke a <code>next</code> callback in this situation unexpected behavior may occur, e.g. duplicate invocation of handlers.</p><p><strong>Notice:</strong> in the <code>onRequest</code> and <code>preValidation</code> hooks, <code>request.body</code> will always be <code>null</code>, because the body parsing happens before the <code>preHandler</code> hook.</p><p><a href=/docs/v2.3.x/v2.3.x/Request>Request</a> and <a href=/docs/v2.3.x/v2.3.x/Reply>Reply</a> are the core Fastify objects.<br><code>next</code> is the function to continue with the <a href=/docs/v2.3.x/v2.3.x/Lifecycle>lifecycle</a>.</p><p>It is pretty easy to understand where each hook is executed by looking at the <a href=/docs/v2.3.x/v2.3.x/Lifecycle>lifecycle page</a>.<br>Hooks are affected by Fastify&#39;s encapsulation, and can thus be applied to selected routes. See the <a href=#scope>Scopes</a> section for more information.</p><p>If you get an error during the execution of your hook, just pass it to <code>next()</code> and Fastify will automatically close the request and send the appropriate error code to the user.</p><pre><code class=language-js>fastify.addHook(&#39;onRequest&#39;, (request, reply, next) =&gt; {
  next(new Error(&#39;some error&#39;))
})
</code></pre><p>If you want to pass a custom error code to the user, just use <code>reply.code()</code>:</p><pre><code class=language-js>fastify.addHook(&#39;preHandler&#39;, (request, reply, next) =&gt; {
  reply.code(400)
  next(new Error(&#39;some error&#39;))
})
</code></pre><p><em>The error will be handled by <a href=/docs/v2.3.x/Reply.md#errors><code>Reply</code></a>.</em></p><h4 id=the-onerror-hook>The <code>onError</code> Hook</h4><p>This hook is useful if you need to do some custom error logging or add some specific header in case of error.<br>It is not intended for changing the error, and calling <code>reply.send</code> will throw an exception.<br>This hook will be executed only after the <code>customErrorHandler</code> has been executed, and only if the <code>customErrorHandler</code> sends back an error to the user <em>(Note that the default <code>customErrorHandler</code> always send back the error to the user)</em>.<br><strong>Notice:</strong> unlike the other hooks, pass an error to the <code>next</code> function is not supported.</p><pre><code class=language-js>fastify.addHook(&#39;onError&#39;, (request, reply, error, next) =&gt; {
  // apm stands for Application Performance Monitoring
  apm.sendError(error)
  next()
})

// Or async
fastify.addHook(&#39;onError&#39;, async (request, reply, error) =&gt; {
  // apm stands for Application Performance Monitoring
  apm.sendError(error)
})
</code></pre><h4 id=the-preserialization-hook>The <code>preSerialization</code> Hook</h4><p>If you are using the <code>preSerialization</code> hook, you can change (or replace) the payload before it is serialized. For example:</p><pre><code class=language-js>fastify.addHook(&#39;preSerialization&#39;, (request, reply, payload, next) =&gt; {
  var err = null;
  var newPayload = {wrapped: payload }
  next(err, newPayload)
})

// Or async
fastify.addHook(&#39;preSerialization&#39;, async (request, reply, payload) =&gt; {
  return {wrapped: payload }
})
</code></pre><p>Note: the hook is NOT called if the payload is a <code>string</code>, a <code>Buffer</code>, a <code>stream</code>, or <code>null</code>.</p><h4 id=the-onsend-hook>The <code>onSend</code> Hook</h4><p>If you are using the <code>onSend</code> hook, you can change the payload. For example:</p><pre><code class=language-js>fastify.addHook(&#39;onSend&#39;, (request, reply, payload, next) =&gt; {
  var err = null;
  var newPayload = payload.replace(&#39;some-text&#39;, &#39;some-new-text&#39;)
  next(err, newPayload)
})

// Or async
fastify.addHook(&#39;onSend&#39;, async (request, reply, payload) =&gt; {
  var newPayload = payload.replace(&#39;some-text&#39;, &#39;some-new-text&#39;)
  return newPayload
})
</code></pre><p>You can also clear the payload to send a response with an empty body by replacing the payload with <code>null</code>:</p><pre><code class=language-js>fastify.addHook(&#39;onSend&#39;, (request, reply, payload, next) =&gt; {
  reply.code(304)
  const newPayload = null
  next(null, newPayload)
})
</code></pre><blockquote><p>You can also send an empty body by replacing the payload with the empty string <code>&#39;&#39;</code>, but be aware that this will cause the <code>Content-Length</code> header to be set to <code>0</code>, whereas the <code>Content-Length</code> header will not be set if the payload is <code>null</code>.</p></blockquote><p>Note: If you change the payload, you may only change it to a <code>string</code>, a <code>Buffer</code>, a <code>stream</code>, or <code>null</code>.</p><h4 id=the-onresponse-hook>The <code>onResponse</code> Hook</h4><p>The <code>onResponse</code> hook is executed when a response has been sent, so you will not be able to send more data to the client, however you can use this hook to send some data to an external service or elaborate some statistics.</p><h3 id=respond-to-a-request-from-a-hook>Respond to a request from a hook</h3><p>If needed, you can respond to a request before you reach the route handler. An example could be an authentication hook. If you are using <code>onRequest</code> or <code>preHandler</code> use <code>reply.send</code>; if you are using a middleware, <code>res.end</code>.</p><pre><code class=language-js>fastify.addHook(&#39;onRequest&#39;, (request, reply, next) =&gt; {
  reply.send(&#39;early response&#39;)
})

// Works with async functions too
fastify.addHook(&#39;preHandler&#39;, async (request, reply) =&gt; {
  reply.send({ hello: &#39;world&#39; })
})
</code></pre><p>If you want to respond with a stream, you should avoid using an <code>async</code> function for the hook. If you must use an <code>async</code> function, your code will need to follow the pattern in <a href=https://github.com/fastify/fastify/blob/94ea67ef2d8dce8a955d510cd9081aabd036fa85/test/hooks-async.js#L269-L275>test/hooks-async.js</a>.</p><pre><code class=language-js>fastify.addHook(&#39;onRequest&#39;, (request, reply, next) =&gt; {
  const stream = fs.createReadStream(&#39;some-file&#39;, &#39;utf8&#39;)
  reply.send(stream)
})
</code></pre><h2 id=application-hooks>Application Hooks</h2><p>You are able to hook into the application-lifecycle as well. It&#39;s important to note that these hooks aren&#39;t fully encapsulated. The <code>this</code> inside the hooks are encapsulated but the handlers can respond to an event outside the encapsulation boundaries.</p><ul><li><code>&#39;onClose&#39;</code></li><li><code>&#39;onRoute&#39;</code></li><li><code>&#39;onRegister&#39;</code></li></ul><p><a name=on-close></a> <strong>&#39;onClose&#39;</strong><br>Triggered when <code>fastify.close()</code> is invoked to stop the server. It is useful when <a href=/docs/v2.3.x/v2.3.x/Plugins>plugins</a> need a &quot;shutdown&quot; event, such as a connection to a database.<br>The first argument is the Fastify instance, the second one the <code>done</code> callback.</p><pre><code class=language-js>fastify.addHook(&#39;onClose&#39;, (instance, done) =&gt; {
  // some code
  done()
})
</code></pre><p><a name=on-route></a> <strong>&#39;onRoute&#39;</strong><br>Triggered when a new route is registered. Listeners are passed a <code>routeOptions</code> object as the sole parameter. The interface is synchronous, and, as such, the listeners do not get passed a callback.</p><pre><code class=language-js>fastify.addHook(&#39;onRoute&#39;, (routeOptions) =&gt; {
  // some code
  routeOptions.method
  routeOptions.schema
  routeOptions.url
  routeOptions.bodyLimit
  routeOptions.logLevel
  routeOptions.prefix
})
</code></pre><p><a name=on-register></a> <strong>&#39;onRegister&#39;</strong><br>Triggered when a new plugin function is registered, and a new encapsulation context is created, the hook will be executed <strong>before</strong> the plugin code.<br>This hook can be useful if you are developing a plugin that needs to know when a plugin context is formed, and you want to operate in that specific context.<br><strong>Note:</strong> This hook will not be called if a plugin is wrapped inside <a href=https://github.com/fastify/fastify-plugin><code>fastify-plugin</code></a>.</p><pre><code class=language-js>fastify.decorate(&#39;data&#39;, [])

fastify.register(async (instance, opts) =&gt; {
  instance.data.push(&#39;hello&#39;)
  console.log(instance.data) // [&#39;hello&#39;]

  instance.register(async (instance, opts) =&gt; {
    instance.data.push(&#39;world&#39;)
    console.log(instance.data) // [&#39;hello&#39;, &#39;world&#39;]
  })
})

fastify.register(async (instance, opts) =&gt; {
  console.log(instance.data) // []
})

fastify.addHook(&#39;onRegister&#39;, (instance) =&gt; {
  // create a new array from the old one
  // but without keeping the reference
  // allowing the user to have encapsulated
  // instances of the `data` property
  instance.data = instance.data.slice()
})
</code></pre><p><a name=scope></a></p><h3 id=scope>Scope</h3><p>Except for <a href=#application-hooks>Application Hooks</a>, all hooks are encapsulated. This means that you can decide where your hooks should run by using <code>register</code> as explained in the <a href=/docs/v2.3.x/v2.3.x/Plugins-Guide>plugins guide</a>. If you pass a function, that function is bound to the right Fastify context and from there you have full access to the Fastify API.</p><pre><code class=language-js>fastify.addHook(&#39;onRequest&#39;, function (request, reply, next) {
  const self = this // Fastify context
  next()
})
</code></pre><p>Note: using an arrow function will break the binding of this to the Fastify instance.</p><p><a name=route-hooks></a></p><h2 id=route-level-hooks>Route level hooks</h2><p>You can declare one or more custom <code>onRequest</code>, <code>preParsing</code>, <code>preValidation</code>, <code>preHandler</code> and <code>preSerialization</code> hook(s) that will be unique for the route. If you do so, those hooks always be executed as last hook in their category.<br>This can be useful if you need to run the authentication, and the <code>preParsing</code> or <code>preValidation</code> hooks are exactly what you need for doing that. Multiple route-level hooks can also be specified as an array.</p><p>Let&#39;s make an example:</p><pre><code class=language-js>fastify.addHook(&#39;onRequest&#39;, (request, reply, done) =&gt; {
  // your code
  done()
})

fastify.addHook(&#39;preParsing&#39;, (request, reply, done) =&gt; {
  // your code
  done()
})

fastify.addHook(&#39;preValidation&#39;, (request, reply, done) =&gt; {
  // your code
  done()
})

fastify.addHook(&#39;preHandler&#39;, (request, reply, done) =&gt; {
  // your code
  done()
})

fastify.addHook(&#39;preSerialization&#39;, (request, reply, done) =&gt; {
  // your code
  done()
})

fastify.route({
  method: &#39;GET&#39;,
  url: &#39;/&#39;,
  schema: { ... },
  onRequest: function (request, reply, done) {
    // this hook will always be executed after the shared `onRequest` hooks
    done()
  },
  preParsing: function (request, reply, done) {
    // this hook will always be executed after the shared `preParsing` hooks
    done()
  },
  preValidation: function (request, reply, done) {
    // this hook will always be executed after the shared `preValidation` hooks
    done()
  },
  preHandler: function (request, reply, done) {
    // this hook will always be executed after the shared `preHandler` hooks
    done()
  },
  // // Example with an array. All hooks support this syntax.
  //
  // preHandler: [function (request, reply, done) {
  //   // this hook will always be executed after the shared `preHandler` hooks
  //   done()
  // }],
  preSerialization: (request, reply, payload, next) =&gt; {
    // manipulate the payload
    next(null, payload)
  },
  handler: function (request, reply) {
    reply.send({ hello: &#39;world&#39; })
  }
})
</code></pre><p><strong>Note</strong>: both options also accept an array of functions.</p></div><hr><nav class=level></nav></div></div></div></section><script>// dynamically creates a submenu for the current section based on the content headers
  var titles = document.querySelectorAll('#doc-content h3, #doc-content h4')
  var currentMenu = document.getElementById('doc-menu-section')
  if (titles.length && currentMenu) {
    var submenu = document.createElement('ul')
    titles.forEach(el => {
      var currentSubmenuItem = document.createElement('li')
      var currentSubmenuLink = document.createElement('a')
      currentSubmenuLink.href = '#' + el.id
      currentSubmenuLink.title = el.textContent
      currentSubmenuLink.append(document.createTextNode(el.textContent))
      currentSubmenuItem.append(currentSubmenuLink)
      submenu.append(currentSubmenuItem)
    })
    currentMenu.append(submenu)
  }

  // dynamically creates header anchor links
  var headers = document.querySelectorAll('#doc-content h3, #doc-content h4')
  headers.forEach(el => {
    var currentAnchorLink = document.createElement('a')
    currentAnchorLink.className = 'anchor'
    currentAnchorLink.href = "#" + el.id
    currentAnchorLink.append(document.createTextNode('Â¶'))
    el.insertBefore(currentAnchorLink, el.firstChild);
  })</script><script>const contentLoaded = document.addEventListener('DOMContentLoaded', setTOCHeight)
  const resize = window.addEventListener('resize', setTOCHeight)

  function setTOCHeight() {
    const docHeight = window.innerHeight
    const tocSidebar = document.querySelector('#toc') || 0

    const tocHeight = docHeight - tocSidebar.getBoundingClientRect().top

    document.documentElement.style
      .setProperty('--TOC-height', `${tocHeight}px`)
  }

  window.addEventListener('beforeunload', () => {
    document.removeEventListener(contentLoaded)
    window.removeEventListener(resize)
  })</script></main><footer class="grey is-primary footer"><div class=container><div class="content has-text-centered"><p>Fastify, Copyright &copy; 2016-2023 <a href=https://openjsf.org/ target=_blank rel=noopener>OpenJS Foundation</a> and <a href=https://github.com/fastify/fastify#team target=_blank rel=noopener>The Fastify team</a>, Licensed under <a href=https://github.com/fastify/fastify/blob/master/LICENSE target=_blank rel=noopener>MIT</a></p><a href=https://www.netlify.com><img src=https://www.netlify.com/img/global/badges/netlify-color-accent.svg alt="Deploys by Netlify" loading=lazy decoding=async></a><p><small>Icons by simpleicons.org</small></p></div></div></footer><script src=/js/main.1e1d476db6c0b326.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js integrity="sha512-s+tOYYcC3Jybgr9mVsdAxsRYlGNq4mlAurOrfNuGMQ/SCofNPu92tjE7YRZCsdEtWL1yGkqk15fU/ark206YTg==" crossorigin=anonymous></script><script>hljs.highlightAll();</script><script src=https://cdn.jsdelivr.net/npm/@docsearch/js@alpha></script><script type=text/javascript>docsearch({
        appId: 'DMPMC33PLU',
        apiKey: '12d46b3bfeee6511031cfe00778f3e45',
        indexName: 'fastify',
        container: '#algolia-search-input',
        algoliaOptions: { 'facetFilters': ["version:latest", "tags:docs"] }
      });</script></body></html>